<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Validaci√≥n de Contrato - E-FirmaContrata</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="theme.css">
  <style>
    /* Layout espec√≠fico */
    .validation-container {
      max-width: 1200px;
      margin: 2rem auto;
      padding: 0 1rem;
    }
    
    .validation-header {
      background: linear-gradient(135deg, var(--primary) 0%, #667eea 100%);
      color: white;
      padding: 2rem;
      border-radius: 12px 12px 0 0;
      margin-bottom: 0;
    }
    
    .validation-body {
      background: white;
      padding: 2rem;
      border-radius: 0 0 12px 12px;
      box-shadow: var(--shadow-lg);
    }
    
    /* Grid de contenido */
    .content-grid {
      display: grid;
      grid-template-columns: 1fr 350px;
      gap: 2rem;
      margin-top: 2rem;
    }
    
    /* Documento preview */
    .document-preview {
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 2rem;
      min-height: 600px;
      overflow-y: auto;
    }
    
    .document-content {
      font-family: 'Times New Roman', serif;
      line-height: 1.6;
      color: #111827;
    }
    
    /* Panel lateral */
    .sidebar {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }
    
    .info-card {
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 1.5rem;
    }
    
    .info-card h3 {
      margin-bottom: 1rem;
      color: var(--dark);
      font-size: 1.1rem;
    }
    
    .info-item {
      display: flex;
      justify-content: space-between;
      padding: 0.5rem 0;
      border-bottom: 1px solid #f3f4f6;
    }
    
    .info-item:last-child {
      border-bottom: none;
    }
    
    .info-label {
      color: #6b7280;
      font-size: 0.9rem;
    }
    
    .info-value {
      color: var(--dark);
      font-weight: 500;
    }
    
    /* Estados */
    .status-badge {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      border-radius: 20px;
      font-size: 0.875rem;
      font-weight: 500;
    }
    
    .status-pending {
      background: #fef3c7;
      color: #92400e;
    }
    
    .status-approved {
      background: #d1fae5;
      color: #065f46;
    }
    
    .status-rejected {
      background: #fee2e2;
      color: #991b1b;
    }
    
    /* Acciones */
    .actions-card {
      background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
      color: white;
      padding: 1.5rem;
      border-radius: 8px;
    }
    
    .actions-card h3 {
      color: white;
      margin-bottom: 1rem;
    }
    
    .action-buttons {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }
    
    .btn-action {
      width: 100%;
      padding: 0.75rem;
      border: none;
      border-radius: 6px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .btn-approve {
      background: #10b981;
      color: white;
    }
    
    .btn-approve:hover {
      background: #059669;
      transform: translateY(-2px);
    }
    
    .btn-reject {
      background: #ef4444;
      color: white;
    }
    
    .btn-reject:hover {
      background: #dc2626;
      transform: translateY(-2px);
    }
    
    .btn-download {
      background: #3b82f6;
      color: white;
    }
    
    .btn-download:hover {
      background: #2563eb;
      transform: translateY(-2px);
    }
    
    /* Observaciones */
    .observations-field {
      margin-top: 1rem;
    }
    
    .observations-field label {
      display: block;
      margin-bottom: 0.5rem;
      color: white;
      font-size: 0.9rem;
    }
    
    .observations-field textarea {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 6px;
      background: rgba(255, 255, 255, 0.1);
      color: white;
      resize: vertical;
      min-height: 100px;
    }
    
    .observations-field textarea::placeholder {
      color: rgba(255, 255, 255, 0.5);
    }
    
    /* Responsive */
    @media (max-width: 768px) {
      .content-grid {
        grid-template-columns: 1fr;
      }
      
      .sidebar {
        order: -1;
      }
      
      .document-preview {
        min-height: 400px;
      }
    }
    
    /* Loader overlay */
    .loader-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    
    .loader-overlay.hidden {
      display: none;
    }
    
    /* Toast mejorado */
    .toast {
      position: fixed;
      bottom: 2rem;
      right: 2rem;
      background: #1f2937;
      color: white;
      padding: 1rem 1.5rem;
      border-radius: 8px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
      transform: translateY(100px);
      opacity: 0;
      transition: all 0.3s;
      z-index: 10000;
    }
    
    .toast.show {
      transform: translateY(0);
      opacity: 1;
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header-main">
    <div class="container">
      <div class="header-content">
        <h1 class="logo">üè† E-FirmaContrata</h1>
        <nav class="nav-menu">
          <a href="index.html">Inicio</a>
          <a href="selector.html">Portal</a>
        </nav>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="main-content">
    <div class="validation-container">
      <!-- Header de validaci√≥n -->
      <div class="validation-header">
        <h2>üìÑ Validaci√≥n de Contrato</h2>
        <p>C√≥digo de Registro: <strong id="cdrDisplay">-</strong></p>
        <div style="margin-top: 1rem;">
          <span id="estadoBadge" class="status-badge status-pending">Pendiente de Validaci√≥n</span>
        </div>
      </div>

      <!-- Body de validaci√≥n -->
      <div class="validation-body">
        <!-- Alert Box -->
        <div id="alertBox" class="alert alert-info hidden" role="alert"></div>

        <!-- Grid de contenido -->
        <div class="content-grid">
          <!-- Preview del documento -->
          <div class="document-preview">
            <div id="documentContent" class="document-content">
              <p class="muted" style="text-align: center;">Cargando contrato...</p>
            </div>
          </div>

          <!-- Sidebar -->
          <div class="sidebar">
            <!-- Informaci√≥n del contrato -->
            <div class="info-card">
              <h3>üìã Informaci√≥n del Contrato</h3>
              <div class="info-item">
                <span class="info-label">Inquilino:</span>
                <span id="nombreInquilino" class="info-value">-</span>
              </div>
              <div class="info-item">
                <span class="info-label">Propietario:</span>
                <span id="nombrePropietario" class="info-value">-</span>
              </div>
              <div class="info-item">
                <span class="info-label">Inmueble:</span>
                <span id="direccionInmueble" class="info-value">-</span>
              </div>
              <div class="info-item">
                <span class="info-label">Canon:</span>
                <span id="valorCanon" class="info-value">-</span>
              </div>
              <div class="info-item">
                <span class="info-label">Duraci√≥n:</span>
                <span id="duracionContrato" class="info-value">-</span>
              </div>
            </div>

            <!-- Estado de aprobaciones -->
            <div class="info-card">
              <h3>‚úÖ Estado de Aprobaciones</h3>
              <div id="estadoAprobaciones">
                <div class="info-item">
                  <span class="info-label">Inquilino:</span>
                  <span class="status-badge status-pending">Pendiente</span>
                </div>
                <div class="info-item">
                  <span class="info-label">Propietario:</span>
                  <span class="status-badge status-pending">Pendiente</span>
                </div>
                <div class="info-item">
                  <span class="info-label">Administrador:</span>
                  <span class="status-badge status-pending">Pendiente</span>
                </div>
              </div>
            </div>

            <!-- Acciones -->
            <div class="actions-card">
              <h3>üéØ Acciones Disponibles</h3>
              <div class="action-buttons">
                <button id="btnDownload" class="btn-action btn-download">
                  üì• Descargar Borrador
                </button>
                <button id="btnApprove" class="btn-action btn-approve">
                  ‚úì Aprobar Contrato
                </button>
                <button id="btnReject" class="btn-action btn-reject">
                  ‚úó Solicitar Correcci√≥n
                </button>
              </div>
              
              <div class="observations-field">
                <label for="observaciones">Observaciones (Opcional)</label>
                <textarea id="observaciones" placeholder="Ingrese sus comentarios o motivo de rechazo..."></textarea>
              </div>
            </div>

            <!-- Selector de parte (oculto, se muestra din√°micamente) -->
            <div id="selectorParte" class="info-card hidden">
              <h3>üë§ Seleccione su rol</h3>
              <select id="selectParte" class="input">
                <option value="">Seleccione...</option>
                <option value="inquilino">Inquilino</option>
                <option value="propietario">Propietario</option>
                <option value="administrador">Administrador</option>
              </select>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Footer -->
  <footer class="footer">
    <div class="container">
      <p>&copy; 2024 Real Estate - Gold Life System. Todos los derechos reservados.</p>
    </div>
  </footer>

  <!-- Loader Overlay -->
  <div id="loaderOverlay" class="loader-overlay hidden">
    <div class="loader"></div>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <!-- Config global -->
  <script src="config.js"></script>

  <script>
  (function(){
    // ---------- Estado ----------
    const state = {
      cdr: '',
      docId: null,
      contrato: null,
      parte: null,
      estadoGlobal: 'PENDIENTE'
    };

    // ---------- Helpers ----------
    const $ = (id) => document.getElementById(id);
    
    const showAlert = (type, text) => {
      const map = { 
        success: 'alert-success', 
        warning: 'alert-warning', 
        danger: 'alert-danger', 
        info: 'alert-info' 
      };
      const box = $('alertBox');
      box.className = `alert ${map[type] || 'alert-info'}`;
      box.innerHTML = escapeHTML(text);
      box.classList.remove('hidden');
    };
    
    const clearAlert = () => $('alertBox').classList.add('hidden');
    
    const toggleLoading = (show) => {
      $('loaderOverlay').classList.toggle('hidden', !show);
    };
    
    const toast = (text) => {
      const t = $('toast');
      t.textContent = text;
      t.classList.add('show');
      setTimeout(() => t.classList.remove('show'), 3000);
    };
    
    const escapeHTML = (str) => {
      const div = document.createElement('div');
      div.textContent = str || '';
      return div.innerHTML;
    };
    
    const formatCurrency = (num) => {
      return new Intl.NumberFormat('es-CO', {
        style: 'currency',
        currency: 'COP',
        minimumFractionDigits: 0
      }).format(num || 0);
    };

    // ---------- Init ----------
    init();

    async function init(){
      const params = new URLSearchParams(location.search);
      state.cdr = params.get('cdr') || '';
      state.docId = params.get('docId') || '';
      state.parte = params.get('parte') || '';
      
      $('cdrDisplay').textContent = state.cdr || '‚Äî';
      
      if (!state.cdr) {
        showAlert('warning', 'Falta el c√≥digo de registro. Accede desde el panel de validaci√≥n.');
        return;
      }
      
      // Si hay parte predefinida, ocultamos el selector
      if (state.parte) {
        $('selectorParte').classList.add('hidden');
      } else {
        $('selectorParte').classList.remove('hidden');
      }
      
      bindEvents();
      await loadContractData();
      await loadApprovalStatus();
    }

    // ---------- Bindings ----------
    function bindEvents(){
      $('btnApprove').addEventListener('click', handleApprove);
      $('btnReject').addEventListener('click', handleReject);
      $('btnDownload').addEventListener('click', handleDownload);
      $('selectParte').addEventListener('change', (e) => {
        state.parte = e.target.value;
      });
    }

    // ---------- Load Data CORREGIDO ----------
    async function loadContractData(){
      toggleLoading(true);
      
      try {
        const url = new URL(CONFIG.API_URL);
        url.searchParams.append('accion', 'obtenerContrato');
        url.searchParams.append('cdr', state.cdr);
        if (state.docId) url.searchParams.append('docId', state.docId);
        
        const res = await fetch(url.toString());
        const data = await res.json();
        
        // VALIDACI√ìN CORREGIDA
        if (!data || !data.success) {
          throw new Error(data?.message || 'No se pudo cargar el contrato');
        }
        
        state.contrato = data;
        displayContract(data);
        displayContractInfo(data.datos);
        
      } catch(err) {
        console.error('[Contrato] Error:', err);
        showAlert('danger', err.message || 'Error cargando el contrato');
      } finally {
        toggleLoading(false);
      }
    }

    // ---------- Load Approval Status CORREGIDO ----------
    async function loadApprovalStatus(){
      try {
        const url = new URL(CONFIG.API_URL);
        url.searchParams.append('accion', 'obtenerEstadoAprobaciones');
        url.searchParams.append('cdr', state.cdr);
        
        const res = await fetch(url.toString());
        const data = await res.json();
        
        // VALIDACI√ìN CORREGIDA
        if (!data || !data.success) {
          console.warn('No se pudo cargar el estado de aprobaciones');
          return;
        }
        
        displayApprovalStatus(data.estados);
        
      } catch(err) {
        console.error('[Aprobaciones] Error:', err);
      }
    }

    // ---------- Display Functions ----------
    function displayContract(data){
      const content = $('documentContent');
      if (data.contenido) {
        // Mostrar el contenido del contrato con formato
        content.innerHTML = `
          <div style="padding: 2rem; background: white; border-radius: 8px;">
            <h2 style="text-align: center; margin-bottom: 2rem;">CONTRATO DE ARRENDAMIENTO</h2>
            <div style="white-space: pre-wrap; font-family: 'Times New Roman', serif; line-height: 1.8;">
              ${escapeHTML(data.contenido)}
            </div>
          </div>
        `;
      } else {
        content.innerHTML = '<p class="muted" style="text-align: center;">No se pudo cargar el contenido del contrato.</p>';
      }
    }

    function displayContractInfo(datos){
      if (!datos) return;
      
      // Actualizar informaci√≥n del contrato
      $('nombreInquilino').textContent = datos['NOMBRE-INQUILINO'] || '‚Äî';
      $('nombrePropietario').textContent = datos['NOMBRE-PROPIETARIO'] || '‚Äî';
      $('direccionInmueble').textContent = datos['DIRECCION-DEL-INMUEBLE-DEL-FOLIO-DE-MATRICULA'] || '‚Äî';
      $('valorCanon').textContent = formatCurrency(datos['PRECIO-DEL-CANON-EN-NUMERO']);
      $('duracionContrato').textContent = `${datos['numero-de-meses-del-contrato-en-numero'] || '‚Äî'} meses`;
    }

    function displayApprovalStatus(estados){
      if (!estados || !Array.isArray(estados)) return;
      
      const container = $('estadoAprobaciones');
      let html = '';
      
      estados.forEach(est => {
        const badgeClass = est.estado === 'APROBADO' ? 'status-approved' :
                          est.estado === 'RECHAZADO' ? 'status-rejected' : 
                          'status-pending';
        const badgeText = est.estado === 'APROBADO' ? 'Aprobado' :
                         est.estado === 'RECHAZADO' ? 'Rechazado' :
                         'Pendiente';
        
        html += `
          <div class="info-item">
            <span class="info-label">${escapeHTML(est.parte)}:</span>
            <span class="status-badge ${badgeClass}">${badgeText}</span>
          </div>
        `;
      });
      
      container.innerHTML = html;
      
      // Actualizar badge global
      const todosAprobados = estados.every(e => e.estado === 'APROBADO');
      const hayRechazado = estados.some(e => e.estado === 'RECHAZADO');
      
      const badge = $('estadoBadge');
      if (todosAprobados) {
        badge.className = 'status-badge status-approved';
        badge.textContent = 'Contrato Aprobado';
        state.estadoGlobal = 'APROBADO';
      } else if (hayRechazado) {
        badge.className = 'status-badge status-rejected';
        badge.textContent = 'Requiere Correcci√≥n';
        state.estadoGlobal = 'CORRECCION';
      } else {
        badge.className = 'status-badge status-pending';
        badge.textContent = 'Pendiente de Validaci√≥n';
        state.estadoGlobal = 'PENDIENTE';
      }
    }

    // ---------- Actions CORREGIDO ----------
    async function handleApprove(){
      if (!state.parte && !$('selectParte').value) {
        showAlert('warning', 'Seleccione su rol para aprobar el contrato');
        $('selectParte').focus();
        return;
      }
      
      const parte = state.parte || $('selectParte').value;
      const observaciones = $('observaciones').value.trim();
      
      if (!confirm('¬øEst√° seguro de aprobar este contrato?')) return;
      
      toggleLoading(true);
      
      try {
        // ESTRUCTURA CORREGIDA
        const payload = {
          accion: 'registrarAprobacionContrato',
          cdr: state.cdr,
          parte: parte,
          estado: 'APROBADO',
          comentarios: observaciones || null
        };
        
        const url = new URL(CONFIG.API_URL);
        const res = await fetch(url.toString(), {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        
        const data = await res.json();
        
        // VALIDACI√ìN CORREGIDA
        if (!data || !data.success) {
          throw new Error(data?.message || 'No se pudo registrar la aprobaci√≥n');
        }
        
        toast('‚úÖ Contrato aprobado exitosamente');
        $('observaciones').value = '';
        
        // Recargar estado
        await loadApprovalStatus();
        
      } catch(err) {
        console.error('[Aprobar] Error:', err);
        showAlert('danger', err.message || 'Error al aprobar el contrato');
      } finally {
        toggleLoading(false);
      }
    }

    async function handleReject(){
      if (!state.parte && !$('selectParte').value) {
        showAlert('warning', 'Seleccione su rol para rechazar el contrato');
        $('selectParte').focus();
        return;
      }
      
      const parte = state.parte || $('selectParte').value;
      const observaciones = $('observaciones').value.trim();
      
      if (!observaciones) {
        showAlert('warning', 'Por favor indique el motivo del rechazo');
        $('observaciones').focus();
        return;
      }
      
      if (!confirm('¬øEst√° seguro de solicitar correcci√≥n en este contrato?')) return;
      
      toggleLoading(true);
      
      try {
        // ESTRUCTURA CORREGIDA
        const payload = {
          accion: 'registrarAprobacionContrato',
          cdr: state.cdr,
          parte: parte,
          estado: 'RECHAZADO',
          comentarios: observaciones
        };
        
        const url = new URL(CONFIG.API_URL);
        const res = await fetch(url.toString(), {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        
        const data = await res.json();
        
        // VALIDACI√ìN CORREGIDA
        if (!data || !data.success) {
          throw new Error(data?.message || 'No se pudo registrar el rechazo');
        }
        
        toast('‚ö†Ô∏è Correcci√≥n solicitada');
        $('observaciones').value = '';
        
        // Recargar estado
        await loadApprovalStatus();
        
      } catch(err) {
        console.error('[Rechazar] Error:', err);
        showAlert('danger', err.message || 'Error al rechazar el contrato');
      } finally {
        toggleLoading(false);
      }
    }

    function handleDownload(){
      if (!state.contrato?.url) {
        showAlert('warning', 'No hay documento disponible para descargar');
        return;
      }
      
      window.open(state.contrato.url, '_blank', 'noopener');
      toast('üì• Descargando contrato...');
    }

  })();
  </script>
</body>
</html>
