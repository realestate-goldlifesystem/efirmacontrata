<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Validación de Contrato • E-FirmaContrata</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Branding global -->
  <link rel="stylesheet" href="theme.css" />

  <!-- Estilos mínimos específicos -->
  <style>
    .page{
      min-height:100vh; display:flex; align-items:flex-start; justify-content:center; padding:24px;
      background: radial-gradient(1600px 800px at 50% -20%, rgba(255,215,0,.10), transparent 60%), var(--black-primary);
    }
    .wrap{ width:min(1100px, 96vw) }
    .hr{ height:1px; background: rgba(255,215,0,.18); margin:18px 0 }
    .grid-2{ display:grid; grid-template-columns: 1fr 1fr; gap:16px }
    .grid-3{ display:grid; grid-template-columns: 1fr 1fr 1fr; gap:16px }
    @media (max-width: 900px){ .grid-2,.grid-3{ grid-template-columns: 1fr } }
    .meta div{ display:flex; gap:8px; align-items:center }
    .kbd{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; background:#111; border:1px solid rgba(255,215,0,.25); border-radius:8px; padding:2px 6px; color:#ffe082; }
    .actions{ display:flex; flex-wrap:wrap; gap:10px }
    .small{ font-size: var(--fs-small); color: var(--gray-400) }
    .hidden{ display:none !important }
    .table{ width:100%; border-collapse: collapse; }
    .table th, .table td{ padding:10px 12px; border-bottom:1px solid rgba(255,215,0,.18) }
    .table th{ text-align:left; color: var(--gold-300) }
    .pill{ padding:6px 10px; border-radius: var(--radius-round); border:1px solid rgba(255,215,0,.25); color:#ffd54f; background: rgba(255,215,0,.08); font-size: var(--fs-small) }
    .right{ text-align:right }
  </style>
</head>
<body>
  <main class="page">
    <section class="card wrap">
      <header class="card-header">
        <div class="badge">E-FirmaContrata</div>
        <h1>Validación de Contrato</h1>
        <p class="muted" style="margin:6px 0 0">Revisa datos, genera el borrador y gestiona aprobaciones.</p>
      </header>

      <div class="card-body">
        <!-- Notificaciones -->
        <div id="alertBox" class="alert hidden" role="alert"></div>

        <!-- Encabezado -->
        <div class="grid-3 meta">
          <div><strong>CDR:</strong> <span id="cdrTxt" class="kbd">—</span></div>
          <div><strong>Estado:</strong> <span id="estadoBadge" class="badge">Cargando…</span></div>
          <div class="right"><span id="lastSync" class="small">Sincronizado: —</span></div>
        </div>

        <div class="hr"></div>

        <!-- Datos de contrato (resumen) -->
        <div class="grid-2">
          <div class="card">
            <div class="card-body">
              <h3>Inquilino</h3>
              <table class="table">
                <tbody id="tblInquilino"><tr><td class="small">Cargando…</td></tr></tbody>
              </table>
            </div>
          </div>
          <div class="card">
            <div class="card-body">
              <h3>Propietario</h3>
              <table class="table">
                <tbody id="tblPropietario"><tr><td class="small">Cargando…</td></tr></tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="hr"></div>

        <!-- Acciones principales -->
        <div class="actions" style="margin-bottom:8px">
          <button id="btnGenerar" class="btn btn-primary btn-pill" type="button">Generar borrador</button>
          <button id="btnVerBorrador" class="btn btn-secondary btn-pill hidden" type="button">Ver borrador</button>
          <button id="btnEnviarAprob" class="btn btn-info btn-pill" type="button">Enviar para aprobación</button>
          <button id="btnRefrescar" class="btn btn-ghost btn-pill" type="button">Refrescar</button>
        </div>

        <div class="small">
          * El borrador reemplaza placeholders definidos en el backend. Revisa nombres, direcciones, cánones, cuentas y fechas.
        </div>

        <div class="hr"></div>

        <!-- Aprobaciones -->
        <div class="card">
          <div class="card-body">
            <h3>Aprobaciones</h3>
            <div class="grid-2">
              <div>
                <div class="badge">Estado de aprobaciones</div>
                <table class="table" style="margin-top:10px">
                  <thead>
                    <tr><th>Parte</th><th>Estado</th><th>Fecha</th><th>Observación</th></tr>
                  </thead>
                  <tbody id="tblAprobaciones"><tr><td colspan="4" class="small">Sin datos.</td></tr></tbody>
                </table>
              </div>
              <div>
                <div class="badge">Acciones de aprobación</div>
                <div class="actions" style="margin-top:10px">
                  <select id="selParte" class="input" style="max-width:220px">
                    <option value="inquilino">Inquilino</option>
                    <option value="propietario">Propietario</option>
                    <option value="administrador">Administrador</option>
                  </select>
                  <button id="btnAprobar" class="btn btn-success btn-pill" type="button">Aprobar</button>
                  <button id="btnRechazar" class="btn btn-danger btn-pill" type="button">Rechazar</button>
                </div>
                <label for="obs" style="margin-top:10px">Observación (opcional)</label>
                <textarea id="obs" class="input" rows="3" placeholder="Motivo / notas"></textarea>
              </div>
            </div>
          </div>
        </div>

        <!-- Loader -->
        <div id="loader" class="loader hidden" aria-label="Procesando"></div>
      </div>
    </section>
  </main>

  <!-- Config global -->
  <script src="config.js"></script>

  <script>
  (function(){
    // ---------- Estado ----------
    const state = {
      cdr: '',
      contrato: null,   // datos agregados
      borradorUrl: '',
      estado: 'CARGANDO',
      aprobaciones: []
    };

    // ---------- Helpers ----------
    const $ = (id) => document.getElementById(id);
    const setBadge = (text, type='info') => {
      const m = {success:'badge-success', warning:'badge-warning', danger:'badge-danger', info:'badge-info'};
      const b = $('estadoBadge');
      b.className = `badge ${m[type]||'badge-info'}`;
      b.textContent = text;
    };
    const showAlert = (type, text) => {
      const map = { success:'alert-success', warning:'alert-warning', danger:'alert-danger', info:'alert-info' };
      const box = $('alertBox');
      box.className = `alert ${map[type]||'alert-info'}`;
      box.innerHTML = escapeHTML(text);
      box.classList.remove('hidden');
    };
    const clearAlert = () => $('alertBox').classList.add('hidden');
    const toggleLoading = (v) => $('loader').classList.toggle('hidden', !v);
    const nowFmt = () => new Date().toLocaleString();

    // ---------- Init ----------
    init();

    function init(){
      const qs = new URLSearchParams(location.search);
      state.cdr = qs.get('cdr') || '';
      $('cdrTxt').textContent = state.cdr || '—';

      bindEvents();
      if (!state.cdr) {
        showAlert('warning', 'Falta el CDR. Abre esta página desde el panel o selector.');
        return;
      }
      loadContrato();
    }

    function bindEvents(){
      $('btnRefrescar').addEventListener('click', loadContrato);
      $('btnGenerar').addEventListener('click', onGenerarBorrador);
      $('btnVerBorrador').addEventListener('click', () => {
        if (state.borradorUrl) window.open(state.borradorUrl, '_blank');
      });
      $('btnEnviarAprob').addEventListener('click', onEnviarAprobacion);
      $('btnAprobar').addEventListener('click', () => onRegistrarDecision('aprobado'));
      $('btnRechazar').addEventListener('click', () => onRegistrarDecision('rechazado'));
    }

    // ---------- Cargas ----------
    async function loadContrato(){
      clearAlert();
      toggleLoading(true);
      try{
        const url = new URL(CONFIG.API_URL);
        url.searchParams.set('accion','obtenerDatosContrato');
        url.searchParams.set('cdr', state.cdr);
        const res = await fetch(url.toString(), { method:'GET' });
        const data = await res.json();

        if (!data || data.ok !== true) throw new Error(data?.message || 'No fue posible obtener los datos del contrato.');

        state.contrato = data.contrato || {};
        state.estado = data.estado || 'SIN_ESTADO';
        state.borradorUrl = data.borradorUrl || '';
        state.aprobaciones = data.aprobaciones || [];

        renderResumen();
        renderAprobaciones();
        renderEstado();

        $('lastSync').textContent = `Sincronizado: ${nowFmt()}`;
        $('btnVerBorrador').classList.toggle('hidden', !state.borradorUrl);
      }catch(err){
        console.error('[validacion-contrato] loadContrato:', err);
        showAlert('danger', err.message || 'Error cargando datos.');
      }finally{
        toggleLoading(false);
      }
    }

    // ---------- Render ----------
    function renderResumen(){
      const i = state.contrato?.inquilino || {};
      const p = state.contrato?.propietario || {};
      $('tblInquilino').innerHTML = toRows({
        'Nombre': full(i.nombres, i.apellidos),
        'Documento': i.tipoDocumento && i.numeroDocumento ? `${i.tipoDocumento} ${i.numeroDocumento}` : '—',
        'Email': i.email || '—',
        'Celular': i.celular || '—',
        'Inmueble': state.contrato?.inmueble || '—',
        'Canon / Mes': money(state.contrato?.canon)||'—'
      });
      $('tblPropietario').innerHTML = toRows({
        'Nombre': full(p.nombres, p.apellidos),
        'Documento': p.tipoDocumento && p.numeroDocumento ? `${p.tipoDocumento} ${p.numeroDocumento}` : '—',
        'Email': p.email || '—',
        'Celular': p.celular || '—',
        'Cuenta Bancaria': state.contrato?.cuenta || '—',
        'Ciudad / Dirección': state.contrato?.direccion || '—'
      });
    }

    function renderAprobaciones(){
      const rows = (state.aprobaciones||[]).map(a => `
        <tr>
          <td>${escapeHTML(cap(a.parte))}</td>
          <td><span class="pill">${escapeHTML(cap(a.estado||'pendiente'))}</span></td>
          <td>${escapeHTML(a.fecha||'—')}</td>
          <td>${escapeHTML(a.observacion||'')}</td>
        </tr>
      `).join('') || '<tr><td colspan="4" class="small">Sin datos.</td></tr>';
      $('tblAprobaciones').innerHTML = rows;
    }

    function renderEstado(){
      const e = (state.estado||'').toUpperCase();
      if (e.includes('FINAL')) return setBadge('FINALIZADO', 'success');
      if (e.includes('APROBADO')) return setBadge('APROBADO TOTAL', 'success');
      if (e.includes('CORRECCION')) return setBadge('CORRECCIÓN SOLICITADA', 'warning');
      if (e.includes('BORRADOR')) return setBadge('BORRADOR GENERADO', 'info');
      if (e.includes('LISTO') || e.includes('INCOMPLETO')) return setBadge(e.replaceAll('_',' '), 'info');
      setBadge(e || 'SIN ESTADO', 'info');
    }

    // ---------- Acciones ----------
    async function onGenerarBorrador(){
      clearAlert(); toggleLoading(true);
      try{
        const url = new URL(CONFIG.API_URL);
        const body = { accion:'generarContrato', cdr: state.cdr };
        const res = await fetch(url.toString(), {
          method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)
        });
        const data = await res.json();
        if (!data || data.ok !== true) throw new Error(data?.message || 'No se pudo generar el borrador.');
        state.borradorUrl = data.borradorUrl || '';
        state.estado = data.estado || state.estado;
        renderEstado();
        $('btnVerBorrador').classList.toggle('hidden', !state.borradorUrl);
        showAlert('success','Borrador generado con éxito.');
      }catch(err){
        console.error('[generarContrato]', err);
        showAlert('danger', err.message || 'Error generando el borrador.');
      }finally{
        toggleLoading(false);
      }
    }

    async function onEnviarAprobacion(){
      clearAlert(); toggleLoading(true);
      try{
        // Normalmente el backend envía notificaciones y marca el estado como “EN APROBACIÓN”
        const url = new URL(CONFIG.API_URL);
        const body = { accion:'enviarParaAprobacion', cdr: state.cdr };
        const res = await fetch(url.toString(), {
          method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)
        });
        const data = await res.json();
        if (!data || data.ok !== true) throw new Error(data?.message || 'No se pudo enviar a aprobación.');
        state.estado = data.estado || state.estado;
        renderEstado();
        showAlert('success','Enviado a aprobación. Se notificó a las partes.');
        // refrescar aprobaciones por si vienen ya creadas
        await loadAprobacionesSolo();
      }catch(err){
        console.error('[enviarParaAprobacion]', err);
        showAlert('danger', err.message || 'Error enviando a aprobación.');
      }finally{
        toggleLoading(false);
      }
    }

    async function onRegistrarDecision(decision){
      clearAlert(); toggleLoading(true);
      try{
        const parte = $('selParte').value;
        const observacion = $('obs').value || '';
        const url = new URL(CONFIG.API_URL);
        const body = {
          accion:'registrarAprobacionContrato',
          cdr: state.cdr,
          parte, // 'inquilino' | 'propietario' | 'administrador'
          decision, // 'aprobado' | 'rechazado'
          observacion
        };
        const res = await fetch(url.toString(), {
          method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)
        });
        const data = await res.json();
        if (!data || data.ok !== true) throw new Error(data?.message || 'No se pudo registrar la decisión.');
        showAlert('success', `Decisión registrada: ${cap(decision)} (${cap(parte)}).`);
        await loadAprobacionesSolo();
        // Si todas las partes aprobaron, backend puede avanzar a APROBADO_TOTAL o FINALIZADO
        state.estado = data.estado || state.estado;
        renderEstado();
        $('obs').value = '';
      }catch(err){
        console.error('[registrarAprobacionContrato]', err);
        showAlert('danger', err.message || 'Error registrando aprobación.');
      }finally{
        toggleLoading(false);
      }
    }

    async function loadAprobacionesSolo(){
      try{
        const url = new URL(CONFIG.API_URL);
        url.searchParams.set('accion','obtenerEstadoAprobaciones');
        url.searchParams.set('cdr', state.cdr);
        const res = await fetch(url.toString(), { method:'GET' });
        const data = await res.json();
        if (data && data.ok === true) {
          state.aprobaciones = data.aprobaciones || [];
          renderAprobaciones();
        }
      }catch(e){/* silencioso */}
    }

    // ---------- Util ----------
    function toRows(obj){
      return Object.entries(obj).map(([k,v]) => `<tr><th>${escapeHTML(k)}</th><td>${val(v)}</td></tr>`).join('');
    }
    function full(n,a){ return [n||'', a||''].filter(Boolean).join(' ') || '—'; }
    function money(n){
      if (n == null || n === '') return '';
      const num = Number(n); if (Number.isNaN(num)) return escapeHTML(String(n));
      return new Intl.NumberFormat('es-CO',{ style:'currency', currency:'COP', maximumFractionDigits:0 }).format(num);
    }
    function val(v){ return v ? `<span class="muted">${escapeHTML(String(v))}</span>` : '<span class="muted">—</span>'; }
    function cap(s){ return String(s||'').replace(/\b\w/g, m => m.toUpperCase()); }
    function escapeHTML(s){ return (s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
  })();
  </script>
</body>
</html>
