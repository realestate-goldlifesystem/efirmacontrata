<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Formulario Inquilino • E-FirmaContrata</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Branding global -->
  <link rel="stylesheet" href="theme.css" />

  <!-- Estilos mínimos específicos (wizard + modal + toast) -->
  <style>
    .page{
      min-height:100vh; display:flex; align-items:flex-start; justify-content:center; padding:24px;
      background: radial-gradient(1600px 800px at 50% -20%, rgba(255,215,0,.10), transparent 60%), var(--black-primary);
    }
    .wizard{ width:min(1100px, 96vw) }
    .progress{ display:grid; grid-template-columns: repeat(5, 1fr); gap:10px; margin-top:8px }
    .step{
      position:relative; text-align:center; padding:10px 8px; border-radius: var(--radius-md);
      background: linear-gradient(135deg, var(--black-secondary), var(--gray-800));
      border:1px solid rgba(255,215,0,.18); color:#ccc; user-select:none;
    }
    .step.active{
      color:#111; background: linear-gradient(135deg, var(--gold-700), var(--gold-500));
      border-color: rgba(255,215,0,.45); box-shadow: var(--glow-gold); font-weight:700;
    }
    .step .k{ display:block; font-size: var(--fs-small); opacity:.85 }
    .steps-wrap{ margin-top:18px }
    .step-pane{ display:none }
    .step-pane.show{ display:block }
    .hr{ height:1px; background: rgba(255,215,0,.18); margin:18px 0 }
    .grid-2col{ display:grid; grid-template-columns: 1fr 1fr; gap:16px }
    .grid-3col{ display:grid; grid-template-columns: 1fr 1fr 1fr; gap:16px }
    @media (max-width: 860px){ .grid-2col,.grid-3col{ grid-template-columns: 1fr } }
    .file .name{ display:block; margin-top:6px; font-size: var(--fs-small); color: var(--gray-400) }
    .actions{ display:flex; gap:12px; flex-wrap:wrap; margin-top:18px }
    .chips{ display:flex; flex-wrap:wrap; gap:8px; margin-top:8px }
    .chip{ padding:6px 10px; border-radius: var(--radius-round); background: rgba(255,215,0,.12); border:1px solid rgba(255,215,0,.25); font-size: var(--fs-small); color: var(--gold-300) }
    .hidden{ display:none !important }
    .pay-note{ font-size: var(--fs-small); color: var(--gray-400) }

    /* Modal simple */
    .modal{ position: fixed; inset: 0; background: rgba(0,0,0,.55); display:none; align-items:center; justify-content:center; z-index: 50; }
    .modal.show{ display:flex }
    .modal .sheet{ width:min(520px, 92vw) }

    /* Toast */
    .toast{ position: fixed; right:16px; bottom:16px; padding:12px 14px; border-radius:12px; background: #0f172a; color:#e9e9e9; border:1px solid rgba(255,215,0,.35); box-shadow: var(--glow-gold); z-index:60; opacity:0; transform: translateY(8px); transition: .25s all ease; }
    .toast.show{ opacity:1; transform: translateY(0) }
  </style>
</head>
<body>
  <main class="page">
    <section class="card wizard" aria-labelledby="title">
      <header class="card-header">
        <div class="badge">E-FirmaContrata</div>
        <h1 id="title">Formulario del Inquilino</h1>
        <p class="muted" style="margin:6px 0 0">Completa los pasos y realiza el pago para continuar con tu validación.</p>

        <!-- Barra de progreso -->
        <div class="progress" aria-label="Progreso">
          <div class="step" data-step="0"><span class="k">1</span>Datos</div>
          <div class="step" data-step="1"><span class="k">2</span>Documentos</div>
          <div class="step" data-step="2"><span class="k">3</span>Codeudor</div>
          <div class="step" data-step="3"><span class="k">4</span>Pago</div>
          <div class="step" data-step="4"><span class="k">5</span>Resumen</div>
        </div>
      </header>

      <div class="card-body">
        <!-- Banner de corrección -->
        <div id="bannerCorreccion" class="banner hidden" role="status" aria-live="polite">
          <strong>Corrección solicitada:</strong>
          <div id="correccionDocs" class="chips"></div>
          <p id="correccionObs" class="muted" style="margin-top:8px">Vuelve a cargar los documentos marcados.</p>
        </div>

        <!-- Estado / Notificaciones -->
        <div id="alertBox" class="alert hidden" role="alert"></div>

        <!-- PANE 0: Datos -->
        <div class="steps-wrap">
          <div class="step-pane" data-pane="0">
            <h2 class="header-premium" style="margin:0 0 12px">Datos personales</h2>
            <div class="grid-2col">
              <div>
                <label for="tipoDocumento">Tipo de Documento <span class="required">*</span></label>
                <select id="tipoDocumento" class="input" required>
                  <option value="">Seleccione...</option>
                  <option value="CC">Cédula de Ciudadanía</option>
                  <option value="CE">Cédula de Extranjería</option>
                  <option value="PA">Pasaporte</option>
                </select>
              </div>
              <div>
                <label for="numeroDocumento">Número de Documento <span class="required">*</span></label>
                <input id="numeroDocumento" class="input" type="text" placeholder="Ej: 1234567890" required />
              </div>
              <div>
                <label for="confirmarDocumento">Confirmar Número <span class="required">*</span></label>
                <input id="confirmarDocumento" class="input" type="text" placeholder="Confirme el número" required />
                <div id="docError" class="error-msg">El número no coincide.</div>
              </div>
              <div>
                <label for="nombres">Nombres <span class="required">*</span></label>
                <input id="nombres" class="input" type="text" placeholder="Nombres completos" required />
              </div>
              <div>
                <label for="apellidos">Apellidos <span class="required">*</span></label>
                <input id="apellidos" class="input" type="text" placeholder="Apellidos completos" required />
              </div>
              <div>
                <label for="email">Correo <span class="required">*</span></label>
                <input id="email" class="input" type="email" placeholder="correo@ejemplo.com" required />
              </div>
              <div>
                <label for="confirmarEmail">Confirmar Correo <span class="required">*</span></label>
                <input id="confirmarEmail" class="input" type="email" placeholder="Confirme el correo" required />
                <div id="emailError" class="error-msg">El correo no coincide.</div>
              </div>
              <div>
                <label for="celular">Celular <span class="required">*</span></label>
                <input id="celular" class="input" type="tel" placeholder="3001234567" required />
              </div>
              <div>
                <label for="confirmarCelular">Confirmar Celular <span class="required">*</span></label>
                <input id="confirmarCelular" class="input" type="tel" placeholder="Confirme el celular" required />
                <div id="celError" class="error-msg">El celular no coincide.</div>
              </div>
            </div>
          </div>

          <!-- PANE 1: Documentos -->
          <div class="step-pane" data-pane="1">
            <h2 class="header-premium" style="margin:0 0 12px">Documentos del inquilino</h2>
            <div class="grid-3col">
              <div>
                <label>Documento de identidad (frontal) <span class="required">*</span></label>
                <label class="file">
                  <input id="docFront" type="file" class="file-upload-input hidden" accept="application/pdf,image/*" />
                  <span>Seleccionar archivo</span>
                  <span id="docFrontName" class="name"></span>
                </label>
              </div>
              <div>
                <label>Documento de identidad (reverso) <span class="required">*</span></label>
                <label class="file">
                  <input id="docBack" type="file" class="file-upload-input hidden" accept="application/pdf,image/*" />
                  <span>Seleccionar archivo</span>
                  <span id="docBackName" class="name"></span>
                </label>
              </div>
              <div>
                <label>Soporte de ingresos <span class="required">*</span></label>
                <label class="file">
                  <input id="ingresos" type="file" class="file-upload-input hidden" accept="application/pdf,image/*" />
                  <span>Seleccionar archivo</span>
                  <span id="ingresosName" class="name"></span>
                </label>
              </div>
            </div>
            <p class="muted" style="margin-top:6px">Formatos: PDF/JPG/PNG • Máx: 10MB por archivo.</p>
          </div>

          <!-- PANE 2: Codeudor -->
          <div class="step-pane" data-pane="2">
            <h2 class="header-premium" style="margin:0 0 12px">Codeudor (si aplica)</h2>
            <div class="grid-2col">
              <div>
                <label for="coTipo">Tipo de Documento</label>
                <select id="coTipo" class="input">
                  <option value="">Seleccione...</option>
                  <option value="CC">Cédula de Ciudadanía</option>
                  <option value="CE">Cédula de Extranjería</option>
                </select>
              </div>
              <div>
                <label for="coNumero">Número de Documento</label>
                <input id="coNumero" class="input" type="text" placeholder="Ej: 1234567890" />
              </div>
              <div>
                <label for="coNombres">Nombres</label>
                <input id="coNombres" class="input" type="text" placeholder="Nombres completos" />
              </div>
              <div>
                <label for="coApellidos">Apellidos</label>
                <input id="coApellidos" class="input" type="text" placeholder="Apellidos completos" />
              </div>
              <div>
                <label for="coEmail">Correo</label>
                <input id="coEmail" class="input" type="email" placeholder="correo@ejemplo.com" />
              </div>
              <div>
                <label for="coCelular">Celular</label>
                <input id="coCelular" class="input" type="tel" placeholder="3001234567" />
              </div>
            </div>

            <div class="hr"></div>

            <div class="grid-3col">
              <div>
                <label>Documento de identidad (frontal)</label>
                <label class="file">
                  <input id="coDocFront" type="file" class="file-upload-input hidden" accept="application/pdf,image/*" />
                  <span>Seleccionar archivo</span>
                  <span id="coDocFrontName" class="name"></span>
                </label>
              </div>
              <div>
                <label>Documento de identidad (reverso)</label>
                <label class="file">
                  <input id="coDocBack" type="file" class="file-upload-input hidden" accept="application/pdf,image/*" />
                  <span>Seleccionar archivo</span>
                  <span id="coDocBackName" class="name"></span>
                </label>
              </div>
              <div>
                <label>Soporte de ingresos</label>
                <label class="file">
                  <input id="coIngresos" type="file" class="file-upload-input hidden" accept="application/pdf,image/*" />
                  <span>Seleccionar archivo</span>
                  <span id="coIngresosName" class="name"></span>
                </label>
              </div>
            </div>
          </div>

          <!-- PANE 3: Pago -->
          <div class="step-pane" data-pane="3">
            <h2 class="header-premium" style="margin:0 0 12px">Pago de validación</h2>
            <p class="muted">Selecciona tu método de pago preferido para continuar con la validación.</p>

            <div class="grid-2col">
              <div class="card">
                <div class="card-body">
                  <h3>Bre-B / Nequi / Daviplata</h3>
                  <p class="pay-note">Transferencia directa. Confirmación en minutos.</p>
                  <div class="actions">
                    <button id="btnPayBreb" class="btn btn-primary btn-pill" type="button">Ver número y copiar</button>
                  </div>
                </div>
              </div>

              <div class="card">
                <div class="card-body">
                  <h3>Tarjeta de crédito / Débito <span class="muted">(más impuestos)</span></h3>
                  <p class="pay-note">Procesado por pasarela segura.</p>
                  <div class="actions">
                    <button id="btnPayWompi" class="btn btn-secondary btn-pill" type="button">Pagar con tarjeta</button>
                  </div>
                </div>
              </div>
            </div>

            <div class="alert alert-info" style="margin-top:12px">
              Si tienes problemas con el pago, contáctanos para brindarte un enlace alterno.
            </div>
          </div>

          <!-- PANE 4: Resumen -->
          <div class="step-pane" data-pane="4">
            <h2 class="header-premium" style="margin:0 0 12px">Resumen</h2>
            <div id="resumen" class="grid"><!-- Se llena dinámicamente --></div>
            <div class="alert alert-info" style="margin-top:10px" aria-live="polite">
              Verifica que los datos y archivos listados sean correctos antes de enviar.
            </div>
          </div>
        </div>

        <!-- Acciones del wizard -->
        <div class="actions">
          <a class="btn btn-secondary btn-pill" href="selector.html">Volver al selector</a>
          <button id="btnPrev" class="btn btn-ghost btn-pill" type="button">Anterior</button>
          <button id="btnNext" class="btn btn-primary btn-pill" type="button">Siguiente</button>
          <button id="btnEnviar" class="btn btn-success btn-pill hidden" type="button">Enviar documentación</button>
        </div>

        <!-- Loader -->
        <div id="loader" class="loader hidden" aria-label="Procesando"></div>
      </div>
    </section>
  </main>

  <!-- Modal pago Bre-B/Nequi/Daviplata -->
  <div id="modalBreb" class="modal" role="dialog" aria-modal="true" aria-labelledby="modalBrebTitle" aria-hidden="true">
    <div class="card sheet">
      <div class="card-header">
        <h2 id="modalBrebTitle" class="header-premium" style="margin:0">Transferencia: Bre-B / Nequi / Daviplata</h2>
      </div>
      <div class="card-body">
        <p class="muted">Transfiere al siguiente número y luego vuelve para finalizar tu proceso.</p>
        <div class="grid-2col" style="align-items:end">
          <div>
            <label>Número de cuenta / celular</label>
            <input id="brebNumber" class="input" type="text" value="" readonly />
            <p class="pay-note" style="margin-top:6px">Se copiará exactamente este valor.</p>
          </div>
          <div class="actions">
            <button id="btnCopyBreb" class="btn btn-primary btn-pill" type="button">Copiar al portapapeles</button>
            <button id="btnCloseBreb" class="btn btn-ghost btn-pill" type="button">Cerrar</button>
          </div>
        </div>
        <div class="alert alert-info" style="margin-top:12px">
          Consejo: agrega una nota de referencia con tu <strong>CDR</strong> si la pasarela lo permite.
        </div>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast" role="status" aria-live="polite">Copiado al portapapeles</div>

  <!-- Config global -->
  <script src="config.js"></script>

  <script>
  (function(){
    // --------- Estado ----------
    const state = {
      cdr: '',
      modoCorreccion: false,
      docsCorreccion: [],
      step: 0,
      max: 4, // último índice de paso
      archivos: {}, // { key: {nombre, tipo, contenido(base64)} }
      maxFileSize: CONFIG?.MAX_FILE_SIZE || (10 * 1024 * 1024)
    };

    // --------- Shortcuts ----------
    const $ = (id) => document.getElementById(id);
    const qs = (sel, ctx=document) => ctx.querySelector(sel);
    const qsa = (sel, ctx=document) => Array.from(ctx.querySelectorAll(sel));

    // --------- Elementos ----------
    const el = {
      bannerCorreccion: $("bannerCorreccion"),
      correccionDocs: $("correccionDocs"),
      correccionObs: $("correccionObs"),
      alertBox: $("alertBox"),
      loader: $("loader"),
      btnPrev: $("btnPrev"),
      btnNext: $("btnNext"),
      btnEnviar: $("btnEnviar"),
      resumen: $("resumen"),
      // Datos
      tipoDocumento: $("tipoDocumento"),
      numeroDocumento: $("numeroDocumento"),
      confirmarDocumento: $("confirmarDocumento"),
      nombres: $("nombres"),
      apellidos: $("apellidos"),
      email: $("email"),
      confirmarEmail: $("confirmarEmail"),
      celular: $("celular"),
      confirmarCelular: $("confirmarCelular"),
      docError: $("docError"),
      emailError: $("emailError"),
      celError: $("celError"),
      // Docs inquilino
      docFront: $("docFront"), docFrontName: $("docFrontName"),
      docBack: $("docBack"), docBackName: $("docBackName"),
      ingresos: $("ingresos"), ingresosName: $("ingresosName"),
      // Codeudor
      coTipo: $("coTipo"), coNumero: $("coNumero"),
      coNombres: $("coNombres"), coApellidos: $("coApellidos"),
      coEmail: $("coEmail"), coCelular: $("coCelular"),
      coDocFront: $("coDocFront"), coDocFrontName: $("coDocFrontName"),
      coDocBack: $("coDocBack"), coDocBackName: $("coDocBackName"),
      coIngresos: $("coIngresos"), coIngresosName: $("coIngresosName"),
      // Pagos
      btnPayBreb: $("btnPayBreb"),
      btnPayWompi: $("btnPayWompi"),
      // Modal + toast
      modalBreb: $("modalBreb"),
      brebNumber: $("brebNumber"),
      btnCopyBreb: $("btnCopyBreb"),
      btnCloseBreb: $("btnCloseBreb"),
      toast: $("toast"),
    };

    // --------- Init ----------
    init();

    function init(){
      // Params
      const params = new URLSearchParams(location.search);
      state.cdr = params.get('cdr') || '';
      state.modoCorreccion = (params.get('modo') === 'correccion');
      const docs = params.get('docs');

      if (!state.cdr) {
        showAlert('warning', 'CDR no presente. Regresa al selector para validar tu enlace.');
      }

      if (state.modoCorreccion) {
        try {
          state.docsCorreccion = docs ? JSON.parse(decodeURIComponent(docs)) : [];
        } catch(e){ state.docsCorreccion = []; }
        renderCorreccionBanner();
      }

      // Wizard
      renderSteps();
      bindWizard();

      // Files
      bindFile(el.docFront, 'docFront', el.docFrontName);
      bindFile(el.docBack, 'docBack', el.docBackName);
      bindFile(el.ingresos, 'ingresos', el.ingresosName);
      bindFile(el.coDocFront, 'coDocFront', el.coDocFrontName);
      bindFile(el.coDocBack, 'coDocBack', el.coDocBackName);
      bindFile(el.coIngresos, 'coIngresos', el.coIngresosName);

      // Pago: modal + tarjeta
      el.brebNumber.value = CONFIG?.PAY_BREB_NEQUI_DAVIPLATA || '3177623878';
      el.btnPayBreb.addEventListener('click', openBrebModal);
      el.btnCloseBreb.addEventListener('click', closeBrebModal);
      el.modalBreb.addEventListener('click', (e)=>{ if (e.target === el.modalBreb) closeBrebModal(); });
      el.btnCopyBreb.addEventListener('click', copyBreb);

      el.btnPayWompi.addEventListener('click', handlePayWompi);
    }

    // --------- Corrección ----------
    function renderCorreccionBanner(){
      if (!state.docsCorreccion.length){ return; }
      el.bannerCorreccion.classList.remove('hidden');
      el.correccionDocs.innerHTML = state.docsCorreccion.map(d => `<span class="chip">${escapeHTML(d)}</span>`).join('');
    }

    // --------- Wizard ----------
    function renderSteps(){ gotoStep(0, true); }

    function bindWizard(){
      el.btnPrev.addEventListener('click', () => gotoStep(state.step - 1));
      el.btnNext.addEventListener('click', () => {
        if (!validateStep(state.step)) return;
        if (state.step < state.max) gotoStep(state.step + 1);
      });
      el.btnEnviar.addEventListener('click', onSubmit);

      qsa('.progress .step').forEach(s => {
        s.addEventListener('click', () => {
          const target = Number(s.dataset.step);
          if (target <= state.step) return gotoStep(target);
          if (validateStep(state.step)) gotoStep(target);
        });
      });
    }

    function gotoStep(n, first=false){
      state.step = Math.max(0, Math.min(n, state.max));
      qsa('.step-pane').forEach(p => p.classList.toggle('show', Number(p.dataset.pane) === state.step));
      qsa('.progress .step').forEach(s => s.classList.toggle('active', Number(s.dataset.step) === state.step));
      el.btnPrev.disabled = (state.step === 0);
      el.btnNext.classList.toggle('hidden', state.step === state.max);
      el.btnEnviar.classList.toggle('hidden', state.step !== state.max);

      if (state.step === state.max) buildSummary();
      if (!first) window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // --------- Files ----------
    function bindFile(input, key, nameEl){
      input.addEventListener('change', () => handleFile(input.files?.[0], key, nameEl));
    }

    function handleFile(file, key, nameEl){
      if (!file) return;
      if (file.size > state.maxFileSize){
        showAlert('danger', `El archivo "${file.name}" excede el límite de ${(state.maxFileSize/1024/1024).toFixed(0)}MB.`);
        return;
      }
      const reader = new FileReader();
      reader.onload = (e) => {
        state.archivos[key] = { nombre:file.name, tipo:file.type, contenido:e.target.result };
        if (nameEl) nameEl.textContent = file.name;
      };
      reader.readAsDataURL(file);
    }

    // --------- Validación por paso (mínima y coherente) ----------
    const rx = {
      email: /^[^\s@]+@[^\s@]+\.[^\s@]+$/,
      phone: /^\d{10}$/,
      num: /^[0-9A-Za-z.-]{5,}$/
    };

    function validateStep(step){
      hideInlineErrors();
      switch(step){
        case 0:{
          const required = [
            el.tipoDocumento, el.numeroDocumento, el.confirmarDocumento,
            el.nombres, el.apellidos, el.email, el.confirmarEmail,
            el.celular, el.confirmarCelular
          ];
          for (const r of required){
            if (!r.value || !r.value.trim()){
              showAlert('warning', 'Completa los campos obligatorios del paso Datos.');
              r.focus(); return false;
            }
          }
          if (!rx.num.test(el.numeroDocumento.value.trim())){
            showAlert('warning', 'Número de documento inválido.'); el.numeroDocumento.focus(); return false;
          }
          if (el.numeroDocumento.value.trim() !== el.confirmarDocumento.value.trim()){
            el.docError.classList.add('show'); el.confirmarDocumento.classList.add('invalid'); return false;
          }
          if (!rx.email.test(el.email.value.trim())){
            showAlert('warning', 'Correo inválido.'); el.email.focus(); return false;
          }
          if (el.email.value.trim() !== el.confirmarEmail.value.trim()){
            el.emailError.classList.add('show'); el.confirmarEmail.classList.add('invalid'); return false;
          }
          if (!rx.phone.test(el.celular.value.trim())){
            showAlert('warning', 'Celular inválido (10 dígitos).'); el.celular.focus(); return false;
          }
          if (el.celular.value.trim() !== el.confirmarCelular.value.trim()){
            el.celError.classList.add('show'); el.confirmarCelular.classList.add('invalid'); return false;
          }
          return true;
        }
        case 1:{
          const need = ['docFront','docBack','ingresos'];
          for (const k of need){
            if (!state.archivos[k]){
              showAlert('warning', 'Faltan documentos requeridos (frontal, reverso e ingresos).');
              return false;
            }
          }
          return true;
        }
        case 2:{
          // Codeudor opcional: sin bloqueo
          return true;
        }
        case 3:{
          // Paso de pago: no bloqueamos navegación aquí; el backend validará pago si aplica
          return true;
        }
        default: return true;
      }
    }

    function hideInlineErrors(){
      [el.docError, el.emailError, el.celError].forEach(n => n.classList.remove('show'));
      [el.confirmarDocumento, el.confirmarEmail, el.confirmarCelular].forEach(i => i.classList.remove('invalid'));
      el.alertBox.classList.add('hidden');
    }

    // --------- Resumen ----------
    function buildSummary(){
      const files = Object.entries(state.archivos).map(([k,v]) => {
        const nice = {
          docFront:'Doc. Identidad (frontal)', docBack:'Doc. Identidad (reverso)', ingresos:'Soporte de ingresos',
          coDocFront:'Codeudor: Doc. (frontal)', coDocBack:'Codeudor: Doc. (reverso)', coIngresos:'Codeudor: Ingresos'
        }[k] || k;
        return `<li>${nice}: <span class="muted">${escapeHTML(v?.nombre || '—')}</span></li>`;
      }).join('');

      const co = [el.coTipo.value, el.coNumero.value, el.coNombres.value, el.coApellidos.value, el.coEmail.value, el.coCelular.value].some(Boolean);

      el.resumen.innerHTML = `
        <div class="card">
          <div class="card-body">
            <h3>Datos</h3>
            <div class="grid-2col" style="margin-top:10px">
              <div><strong>Documento:</strong> <span class="muted">${escapeHTML(el.tipoDocumento.value||'')} ${escapeHTML(el.numeroDocumento.value||'')}</span></div>
              <div><strong>Nombre:</strong> <span class="muted">${escapeHTML(el.nombres.value||'')} ${escapeHTML(el.apellidos.value||'')}</span></div>
              <div><strong>Correo:</strong> <span class="muted">${escapeHTML(el.email.value||'')}</span></div>
              <div><strong>Celular:</strong> <span class="muted">${escapeHTML(el.celular.value||'')}</span></div>
            </div>
            ${co ? `
            <div class="hr"></div>
            <h3>Codeudor</h3>
            <div class="grid-2col" style="margin-top:10px">
              <div><strong>Documento:</strong> <span class="muted">${escapeHTML(el.coTipo.value||'')} ${escapeHTML(el.coNumero.value||'')}</span></div>
              <div><strong>Nombre:</strong> <span class="muted">${escapeHTML(el.coNombres.value||'')} ${escapeHTML(el.coApellidos.value||'')}</span></div>
              <div><strong>Correo:</strong> <span class="muted">${escapeHTML(el.coEmail.value||'')}</span></div>
              <div><strong>Celular:</strong> <span class="muted">${escapeHTML(el.coCelular.value||'')}</span></div>
            </div>` : ''}
            <div class="hr"></div>
            <h3>Archivos</h3>
            <ul style="margin-top:8px">${files || '<li class="muted">Sin archivos</li>'}</ul>
          </div>
        </div>
      `;
    }

    // --------- Pagos ----------
    function openBrebModal(){
      el.modalBreb.classList.add('show');
      el.modalBreb.setAttribute('aria-hidden', 'false');
      el.brebNumber.select();
    }
    function closeBrebModal(){
      el.modalBreb.classList.remove('show');
      el.modalBreb.setAttribute('aria-hidden', 'true');
    }
    async function copyBreb(){
      const value = (CONFIG?.PAY_BREB_NEQUI_DAVIPLATA || '').toString().trim();
      try{
        if (!value) throw new Error('Número de pago no configurado.');
        await navigator.clipboard.writeText(value);
        toast('Número copiado: ' + value);
      }catch(e){
        toast('No se pudo copiar. Selecciona y copia manualmente.');
      }
    }
    function handlePayWompi(){
      const url = CONFIG?.PAY_WOMPI_URL || '';
      if (!url) return showAlert('warning', 'No encontramos el enlace de pago con tarjeta en config.js.');
      window.open(url, '_blank', 'noopener');
    }

    // --------- Submit ----------
    async function onSubmit(){
      // Validación final integral
      for (let i=0; i<=3; i++){
        if (!validateStep(i)) { gotoStep(i); return; }
      }

      toggleLoading(true);

      const payload = {
        accion: 'procesarFormularioInquilino',
        cdr: state.cdr,
        modo: state.modoCorreccion ? 'correccion' : 'normal',
        inquilino: {
          tipoDocumento: el.tipoDocumento.value.trim(),
          numeroDocumento: el.numeroDocumento.value.trim(),
          nombres: el.nombres.value.trim(),
          apellidos: el.apellidos.value.trim(),
          email: el.email.value.trim(),
          celular: el.celular.value.trim()
        },
        codeudor: {
          tipoDocumento: el.coTipo.value.trim(),
          numeroDocumento: el.coNumero.value.trim(),
          nombres: el.coNombres.value.trim(),
          apellidos: el.coApellidos.value.trim(),
          email: el.coEmail.value.trim(),
          celular: el.coCelular.value.trim()
        },
        archivos: state.archivos   // base64
      };

      try{
        const url = new URL(CONFIG.API_URL);
        const res = await fetch(url.toString(), {
          method:'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        if (!data || data.ok !== true){
          throw new Error(data && data.message ? data.message : 'No fue posible procesar la información.');
        }
        const msg = encodeURIComponent('Documentación enviada correctamente.');
        location.href = `pagina-exito.html?status=success&msg=${msg}`;
      }catch(err){
        console.error('[Inquilino] Error:', err);
        showAlert('danger', err.message || 'Ocurrió un error inesperado.');
      }finally{
        toggleLoading(false);
      }
    }

    // --------- Utilidades ----------
    function showAlert(type, text){
      const map = { success:'alert-success', warning:'alert-warning', danger:'alert-danger', info:'alert-info' };
      el.alertBox.className = `alert ${map[type] || 'alert-info'}`;
      el.alertBox.innerHTML = escapeHTML(text);
      el.alertBox.classList.remove('hidden');
      el.alertBox.focus?.();
    }
    function toggleLoading(show){
      el.loader.classList.toggle('hidden', !show);
      el.btnPrev.disabled = !!show; el.btnNext.disabled = !!show; el.btnEnviar.disabled = !!show;
    }
    function toast(text){
      el.toast.textContent = text || 'Acción realizada.';
      el.toast.classList.add('show');
      clearTimeout(toast._t);
      toast._t = setTimeout(()=> el.toast.classList.remove('show'), 2200);
    }
    function escapeHTML(s){
      return (s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }
  })();
  </script>
</body>
</html>
