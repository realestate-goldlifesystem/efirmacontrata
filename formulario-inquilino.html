<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Formulario Inquilino - E-firmaContrata</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<style>
/* MANTENIENDO TU DISE√ëO ORIGINAL EXACTO */
:root {
  --gold-primary:#FFD700;
  --gold-dark:#B8860B;
  --gold-light:#FFF8DC;
  --black-primary:#0F0F0F;
  --black-secondary:#1A1A1A;
  --gray-dark:#2D2D2D;
  --gray-medium:#404040;
  --white:#FFF;
  --success:#059669;
  --error:#DC2626;
  --info:#2563EB;
}

body {
  font-family:'Segoe UI',Tahoma,sans-serif;
  background:var(--black-primary);
  min-height:100vh;
  overflow-x:hidden;
  position:relative;
  margin:0;
}

.particles {
  position:fixed;
  top:0;
  left:0;
  width:100%;
  height:100%;
  pointer-events:none;
  overflow:hidden;
  z-index:1;
}

.particle {
  position:absolute;
  width:4px;
  height:4px;
  background:var(--gold-primary);
  border-radius:50%;
  opacity:0;
  animation:floatUp 15s infinite;
  box-shadow:0 0 6px var(--gold-primary);
}

@keyframes floatUp {
  0%{opacity:0;transform:translateY(100vh) scale(0)}
  10%{opacity:1;transform:translateY(90vh) scale(1)}
  90%{opacity:1;transform:translateY(10vh) scale(1)}
  100%{opacity:0;transform:translateY(0) scale(0)}
}

.main-container {
  position:relative;
  z-index:10;
  min-height:100vh;
  display:flex;
  align-items:center;
  justify-content:center;
  padding:20px;
}

.form-card {
  width:100%;
  max-width:920px;
  background:linear-gradient(135deg,var(--black-secondary),var(--gray-dark));
  border-radius:20px;
  overflow:hidden;
  box-shadow:0 0 50px rgba(255,215,0,0.1),0 0 100px rgba(255,215,0,0.05),inset 0 0 2px rgba(255,215,0,0.1);
  border:1px solid rgba(255,215,0,0.2);
}

.form-header {
  background:linear-gradient(135deg,var(--gold-dark),var(--gold-primary));
  padding:30px;
  text-align:center;
  position:relative;
  overflow:hidden;
}

.form-header::before {
  content:'';
  position:absolute;
  top:-50%;
  left:-50%;
  width:200%;
  height:200%;
  background:linear-gradient(45deg,transparent,rgba(255,255,255,.3),transparent);
  animation:shimmer 3s infinite;
}

@keyframes shimmer {
  0%{transform:translateX(-100%) translateY(-100%) rotate(45deg)}
  100%{transform:translateX(100%) translateY(100%) rotate(45deg)}
}

.logo {
  font-size:36px;
  font-weight:bold;
  color:var(--black-primary);
  margin-bottom:8px;
  letter-spacing:2px;
}

.tagline {
  color:var(--black-secondary);
  font-size:14px;
  font-weight:500;
}

.initial-screen {
  padding:55px 40px;
  text-align:center;
}

.initial-screen.hidden {
  display:none;
}

.initial-title {
  color:var(--gold-primary);
  font-size:28px;
  margin-bottom:18px;
}

.initial-description {
  color:var(--white);
  margin-bottom:40px;
  line-height:1.5;
}

.initial-buttons {
  display:flex;
  gap:20px;
  flex-wrap:wrap;
  justify-content:center;
}

.initial-btn {
  flex:1;
  min-width:250px;
  padding:20px;
  background:var(--black-primary);
  border:2px solid rgba(255,215,0,0.3);
  border-radius:15px;
  cursor:pointer;
  position:relative;
  transition:.3s;
}

.initial-btn:hover {
  border-color:var(--gold-primary);
  transform:translateY(-5px);
  box-shadow:0 10px 30px rgba(255,215,0,0.2);
}

.initial-btn-icon {
  font-size:48px;
  margin-bottom:10px;
}

.initial-btn-title {
  color:var(--gold-primary);
  font-size:20px;
  margin-bottom:6px;
}

.initial-btn-desc {
  color:var(--gray-medium);
  font-size:14px;
}

.progress-container {
  padding:25px 30px;
  background:var(--gray-dark);
  border-bottom:1px solid rgba(255,215,0,0.15);
  display:none;
}

.progress-container.show {
  display:block;
}

.progress-bar {
  display:flex;
  justify-content:space-between;
  position:relative;
}

.progress-line {
  position:absolute;
  top:20px;
  left:0;
  right:0;
  height:2px;
  background:var(--gray-medium);
}

.progress-line-active {
  position:absolute;
  top:20px;
  left:0;
  height:2px;
  background:linear-gradient(90deg,var(--gold-dark),var(--gold-primary));
  transition:width .5s;
  box-shadow:0 0 10px var(--gold-primary);
}

.step {
  text-align:center;
  flex:1;
  position:relative;
}

.step-circle {
  width:40px;
  height:40px;
  margin:0 auto 8px;
  border-radius:50%;
  background:var(--gray-medium);
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:bold;
  font-size:14px;
  color:#111;
  border:2px solid var(--gray-medium);
  transition:.3s;
}

.step.active .step-circle {
  background:var(--gold-primary);
  color:var(--black-primary);
  border-color:var(--gold-primary);
  box-shadow:0 0 18px rgba(255,215,0,0.5);
}

.step.completed .step-circle {
  background:var(--success);
  color:#fff;
  border-color:var(--success);
}

.step-label {
  font-size:12px;
  color:var(--gray-medium);
}

.step.active .step-label,
.step.completed .step-label {
  color:var(--gold-primary);
}

.form-content {
  padding:40px;
  display:none;
}

.form-content.show {
  display:block;
}

.form-step {
  display:none;
  animation:fadeIn .45s ease;
}

.form-step.active {
  display:block;
}

@keyframes fadeIn {
  from{opacity:0;transform:translateX(20px)}
  to{opacity:1;transform:translateX(0)}
}

.step-title {
  color:var(--gold-primary);
  font-size:24px;
  margin:0 0 25px;
  padding-bottom:10px;
  border-bottom:2px solid rgba(255,215,0,0.25);
}

.form-field {
  opacity:0;
  transform:translateY(20px);
  transition:.45s;
  margin-bottom:24px;
}

.form-field.show {
  opacity:1;
  transform:translateY(0);
}

.form-row {
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:20px;
}

@media (max-width:768px) {
  .form-row{grid-template-columns:1fr}
  .step-label{display:none}
  .decision-buttons{flex-direction:column}
  .btn{width:100%}
  .form-navigation{flex-direction:column;gap:12px}
  .banner-pago-ok{margin:0 20px}
}

label {
  display:block;
  color:var(--gold-light);
  font-size:14px;
  margin-bottom:6px;
  font-weight:500;
}

.required {
  color:var(--gold-primary);
}

input[type=text],
input[type=email],
input[type=tel],
input[type=date],
select {
  width:100%;
  padding:12px 14px;
  background:var(--black-primary);
  border:1px solid rgba(255,215,0,0.25);
  border-radius:8px;
  color:var(--white);
  font-size:14px;
  transition:.3s;
}

input:focus,
select:focus {
  outline:none;
  border-color:var(--gold-primary);
  box-shadow:0 0 0 3px rgba(255,215,0,0.15);
}

input.valid {
  border-color:var(--success);
}

input.invalid {
  border-color:var(--error);
}

.validation-message {
  font-size:12px;
  margin-top:4px;
  display:none;
}

.validation-message.show {
  display:block;
}

.validation-message.error {
  color:var(--error);
}

.validation-message.success {
  color:var(--success);
}

.file-upload-wrapper {
  position:relative;
  overflow:hidden;
  display:inline-block;
  width:100%;
}

.file-upload-label {
  display:block;
  padding:12px 15px;
  text-align:center;
  background:linear-gradient(135deg,var(--gray-dark),var(--black-primary));
  border:2px dashed rgba(255,215,0,0.35);
  border-radius:8px;
  color:var(--gold-light);
  cursor:pointer;
  transition:.3s;
}

.file-upload-label:hover {
  border-color:var(--gold-primary);
  background:linear-gradient(135deg,var(--black-primary),var(--gray-dark));
}

.file-selected {
  background:rgba(255,215,0,0.1);
  border-color:var(--gold-primary);
}

.file-size-info {
  font-size:11px;
  color:var(--gray-medium);
  margin-top:5px;
}

.file-upload-input {
  display:none;
}

.decision-question {
  text-align:center;
  padding:35px 0;
  transition:.3s;
}

.decision-question.disabled {
  opacity:.35;
  pointer-events:none;
}

.decision-buttons {
  display:flex;
  gap:18px;
  justify-content:center;
  flex-wrap:wrap;
  margin-top:25px;
}

.decision-btn {
  padding:14px 38px;
  background:var(--black-primary);
  border:2px solid rgba(255,215,0,0.35);
  border-radius:10px;
  color:#fff;
  cursor:pointer;
  font-size:15px;
  font-weight:600;
  transition:.35s;
}

.decision-btn:hover:not(:disabled) {
  border-color:var(--gold-primary);
  box-shadow:0 5px 18px rgba(255,215,0,0.25);
}

.decision-btn.selected {
  background:var(--gold-primary);
  color:var(--black-primary);
  border-color:var(--gold-primary);
}

.form-navigation {
  display:none;
  justify-content:space-between;
  align-items:center;
  padding:28px 40px;
  background:var(--gray-dark);
  border-top:1px solid rgba(255,215,0,0.15);
}

.form-navigation.show {
  display:flex;
}

.btn {
  padding:12px 30px;
  border:none;
  border-radius:8px;
  font-size:15px;
  font-weight:600;
  cursor:pointer;
  transition:.35s;
  text-transform:uppercase;
  letter-spacing:.5px;
}

.btn-prev {
  background:var(--gray-medium);
  color:#fff;
}

.btn-prev:hover {
  background:var(--gray-dark);
  transform:translateX(-5px);
}

.btn-next,
.btn-submit {
  background:linear-gradient(135deg,var(--gold-dark),var(--gold-primary));
  color:var(--black-primary);
  position:relative;
  overflow:hidden;
}

.btn-next::before,
.btn-submit::before {
  content:'';
  position:absolute;
  top:0;
  left:-100%;
  width:100%;
  height:100%;
  background:linear-gradient(90deg,transparent,rgba(255,255,255,.35),transparent);
  transition:.55s;
}

.btn-next:hover::before,
.btn-submit:hover::before {
  left:100%;
}

.btn-next:hover,
.btn-submit:hover {
  transform:translateX(5px);
  box-shadow:0 5px 18px rgba(255,215,0,0.25);
}

.btn:disabled {
  opacity:.5;
  cursor:not-allowed;
  transform:none!important;
}

/* Modal */
.modal {
  display:none;
  position:fixed;
  top:0;
  left:0;
  width:100%;
  height:100%;
  background:rgba(0,0,0,.9);
  z-index:1000;
  align-items:center;
  justify-content:center;
  padding:20px;
}

.modal.show {
  display:flex;
}

.modal-content {
  background:linear-gradient(135deg,var(--black-secondary),var(--gray-dark));
  max-width:900px;
  width:100%;
  padding:34px 38px;
  border-radius:18px;
  border:1px solid rgba(255,215,0,0.3);
  box-shadow:0 0 25px rgba(255,215,0,0.18);
  max-height:92vh;
  overflow-y:auto;
  position:relative;
}

.close-btn {
  position:absolute;
  top:12px;
  right:12px;
  background:none;
  border:1px solid var(--gold-primary);
  color:var(--gold-primary);
  padding:6px 12px;
  border-radius:6px;
  cursor:pointer;
  font-weight:600;
}

.modal-title {
  color:var(--gold-primary);
  font-size:24px;
  margin:0 0 18px;
  text-align:center;
}

.resume-section {
  margin-bottom:24px;
}

.resume-section h4 {
  color:var(--gold-primary);
  margin:0 0 10px;
  font-size:16px;
}

.resume-grid {
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:10px 20px;
}

@media (max-width:620px) {
  .resume-grid{grid-template-columns:1fr}
}

.resume-item {
  font-size:13px;
  color:var(--gold-light);
  background:rgba(255,215,0,0.07);
  padding:6px 10px;
  border-radius:6px;
}

.resume-item b {
  color:var(--gold-primary);
}

.actions-row {
  display:flex;
  gap:15px;
  justify-content:center;
  margin-top:25px;
  flex-wrap:wrap;
}

.btn-secondary {
  background:var(--gray-medium);
  color:#fff;
  border:none;
  padding:12px 25px;
  border-radius:8px;
  cursor:pointer;
  font-weight:600;
  letter-spacing:.5px;
  transition:.3s;
}

.btn-secondary:hover {
  background:var(--gray-dark);
}

.loading-overlay {
  position:fixed;
  top:0;
  left:0;
  width:100%;
  height:100%;
  background:rgba(0,0,0,.85);
  display:none;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  z-index:1300;
  color:#fff;
}

.loading-overlay.show {
  display:flex;
}

.loading-overlay .spinner {
  border:4px solid #444;
  border-top:4px solid var(--gold-primary);
  border-radius:50%;
  width:60px;
  height:60px;
  animation:spin 1s linear infinite;
  margin-bottom:25px;
}

@keyframes spin {
  0%{transform:rotate(0deg)}
  100%{transform:rotate(360deg)}
}

.debug-banner {
  position:fixed;
  bottom:8px;
  right:8px;
  background:rgba(255,215,0,0.12);
  border:1px solid var(--gold-primary);
  padding:6px 12px;
  color:var(--gold-primary);
  font-size:12px;
  border-radius:6px;
  z-index:1500;
  font-weight:600;
  backdrop-filter:blur(4px);
}

/* Modal Pago */
.modal-pago .modal-content {
  max-width:520px;
}

.pago-row {
  display:flex;
  gap:10px;
  align-items:center;
  flex-wrap:wrap;
}

.copy-btn {
  padding:8px 14px;
  border:none;
  border-radius:6px;
  cursor:pointer;
  background:var(--gold-primary);
  color:#000;
  font-weight:600;
  display:flex;
  align-items:center;
  gap:6px;
}

.copy-btn.copied {
  background:var(--success);
  color:#fff;
}

.pago-box {
  background:rgba(255,215,0,0.08);
  border:1px solid rgba(255,215,0,0.3);
  padding:12px 16px;
  border-radius:10px;
  font-size:14px;
  display:flex;
  justify-content:space-between;
  gap:12px;
  flex:1;
  min-width:240px;
  color:var(--gold-light);
}

.badge-info {
  display:inline-block;
  padding:4px 10px;
  font-size:11px;
  border-radius:14px;
  background:rgba(255,215,0,0.15);
  color:var(--gold-primary);
  margin-left:6px;
}

.link-wompi {
  display:inline-block;
  margin-top:10px;
  background:linear-gradient(135deg,var(--gold-dark),var(--gold-primary));
  color:#000;
  text-decoration:none;
  padding:10px 18px;
  border-radius:8px;
  font-weight:600;
}

.link-wompi:hover {
  filter:brightness(1.05);
}

.notice {
  font-size:12px;
  color:var(--gold-light);
  opacity:.85;
  margin-top:6px;
}

.confirm-pago-msg {
  display:none;
  margin-top:15px;
  font-size:13px;
  color:var(--success);
  font-weight:600;
  text-align:center;
}

.confirm-pago-msg.show {
  display:block;
}

.divider {
  height:1px;
  background:rgba(255,215,0,0.25);
  margin:18px 0;
}

.banner-pago-ok {
  background:linear-gradient(90deg,#064e3b,#065f46);
  padding:10px 14px;
  border-radius:10px;
  margin:0 40px 0 40px;
  color:#d1fae5;
  font-size:13px;
  display:none;
}

.banner-pago-ok.show {
  display:block;
}

/* Estados de correcci√≥n */
.correction-banner {
  background:linear-gradient(90deg,#7c2d12,#9a3412);
  padding:15px 20px;
  margin:0 40px 20px 40px;
  border-radius:10px;
  color:#fed7aa;
  display:none;
}

.correction-banner.show {
  display:block;
}

.correction-banner h3 {
  color:#ffedd5;
  margin:0 0 10px 0;
}

.correction-list {
  list-style:none;
  padding:0;
  margin:10px 0;
}

.correction-list li {
  padding:5px 0;
  padding-left:20px;
  position:relative;
}

.correction-list li:before {
  content:'‚ö†Ô∏è';
  position:absolute;
  left:0;
}
</style>
</head>
<body>
<div class="particles" id="particles"></div>
<div class="main-container">
  <div class="form-card">
    <div class="form-header">
      <div class="logo">EFirmaContrata</div>
      <div class="tagline">Gesti√≥n de Documentaci√≥n Real Estate - GoldLife System</div>
    </div>

    <!-- Banner de pago completado -->
    <div id="bannerPagoOk" class="banner-pago-ok">
      ‚úÖ Pago marcado como realizado. Puede continuar con el registro.
    </div>

    <!-- Banner de correcci√≥n -->
    <div id="correctionBanner" class="correction-banner">
      <h3>üìù Correcci√≥n Solicitada</h3>
      <p>Se han solicitado correcciones en los siguientes documentos:</p>
      <ul class="correction-list" id="correctionList"></ul>
      <p id="correctionObservations"></p>
    </div>

    <!-- Pantalla inicial -->
    <div class="initial-screen" id="initialScreen">
      <h2 class="initial-title">Bienvenido al Sistema de Registro</h2>
      <p class="initial-description">Para continuar con el proceso de arrendamiento, primero debe realizar el pago de los derechos de contrato y luego proceder con el registro de sus documentos.</p>
      <div class="initial-buttons">
        <div class="initial-btn" onclick="abrirModalPago()">
          <div class="initial-btn-icon">üí≥</div>
          <div class="initial-btn-title">Pagar Derechos</div>
          <div class="initial-btn-desc">Valor: $60.000 COP</div>
        </div>
        <div class="initial-btn">
          <div class="initial-btn-icon">üìù</div>
          <div class="initial-btn-title">Registrarse</div>
          <div class="initial-btn-desc">Complete su documentaci√≥n</div>
          <button id="btnIniciarRegistro" onclick="verificarPagoAntesDeIniciar()" style="all:unset;cursor:pointer;position:absolute;top:0;left:0;width:100%;height:100%;"></button>
        </div>
      </div>
    </div>

    <!-- Barra de progreso -->
    <div class="progress-container" id="progressContainer">
      <div class="progress-bar" id="progressBar"></div>
    </div>

    <!-- Contenido del formulario -->
    <div class="form-content" id="formContent">
      <!-- Paso 1: Documentos Iniciales -->
      <div class="form-step active" data-step="documentos">
        <h2 class="step-title">Documentos Iniciales</h2>
        <div class="form-field" id="field1">
          <label>Documento Estudio Aprobado <span class="required">*</span></label>
          <div class="file-upload-wrapper">
            <label class="file-upload-label" for="estudioAprobado" id="labelEstudioAprobado">
              Seleccionar archivo
            </label>
            <input type="file" id="estudioAprobado" class="file-upload-input" 
                   accept="image/*,.pdf" required onchange="handleFileSelect(this,'field2')">
          </div>
          <div class="file-size-info">M√°ximo 10MB - Formatos: JPG, PNG, PDF</div>
        </div>
        <div class="form-field" id="field2">
          <label>Comprobante de Pago <span class="required">*</span></label>
          <div class="file-upload-wrapper">
            <label class="file-upload-label" for="comprobantePago" id="labelComprobantePago">
              Seleccionar archivo
            </label>
            <input type="file" id="comprobantePago" class="file-upload-input" 
                   accept="image/*,.pdf" required onchange="handleFileSelect(this,null);notificarComprobanteCargado();">
          </div>
          <div class="file-size-info">M√°ximo 10MB - Formatos: JPG, PNG, PDF</div>
        </div>
      </div>

      <!-- Paso 2: Informaci√≥n Personal -->
      <div class="form-step" data-step="informacion">
        <h2 class="step-title">Informaci√≥n Personal del Inquilino</h2>
        <div class="form-field" id="field3">
          <div class="form-row">
            <div>
              <label>Tipo de Documento <span class="required">*</span></label>
              <select id="tipoDocumento" required onchange="showNextField('field4')">
                <option value="">Seleccione...</option>
                <option value="CC">C√©dula de Ciudadan√≠a</option>
                <option value="CE">C√©dula de Extranjer√≠a</option>
                <option value="PA">Pasaporte</option>
                <option value="NIT">NIT</option>
              </select>
            </div>
            <div>
              <label>N√∫mero de Documento <span class="required">*</span></label>
              <input type="text" id="numeroDocumento" placeholder="Ej: 1234567890" required onblur="showNextField('field4')">
              <div class="validation-message" id="numeroDocumentoError"></div>
            </div>
          </div>
        </div>
        <div class="form-field" id="field4">
          <div class="form-row">
            <div>
              <label>Confirmar N√∫mero de Documento <span class="required">*</span></label>
              <input type="text" id="confirmarDocumento" placeholder="Confirme el n√∫mero" required 
                     onblur="validateAndShow('numeroDocumento','confirmarDocumento','field5')">
              <div class="validation-message" id="confirmarDocumentoError"></div>
            </div>
            <div>
              <label>Fecha de Expedici√≥n</label>
              <input type="date" id="fechaExpedicion">
            </div>
          </div>
        </div>
        <div class="form-field" id="field5">
          <div class="form-row">
            <div>
              <label>Nombres Completos <span class="required">*</span></label>
              <input type="text" id="nombres" placeholder="Ej: Juan Carlos" required onblur="showNextField('field6')">
            </div>
            <div>
              <label>Apellidos Completos <span class="required">*</span></label>
              <input type="text" id="apellidos" placeholder="Ej: Garc√≠a L√≥pez" required onblur="showNextField('field6')">
            </div>
          </div>
        </div>
        <div class="form-field" id="field6">
          <div class="form-row">
            <div>
              <label>Correo Electr√≥nico <span class="required">*</span></label>
              <input type="email" id="email" placeholder="correo@ejemplo.com" required 
                     onblur="validarEmail(this); showNextField('field7')">
            </div>
            <div>
              <label>Confirmar Correo <span class="required">*</span></label>
              <input type="email" id="confirmarEmail" placeholder="Confirme el correo" required 
                     onblur="validateAndShow('email','confirmarEmail','field7')">
            </div>
          </div>
        </div>
        <div class="form-field" id="field7">
          <div class="form-row">
            <div>
              <label>Celular <span class="required">*</span></label>
              <input type="tel" id="celular" placeholder="Ej: 3001234567" required 
                     onblur="validarTelefono(this); showNextField('field8')">
            </div>
            <div>
              <label>Confirmar Celular <span class="required">*</span></label>
              <input type="tel" id="confirmarCelular" placeholder="Confirme el celular" required 
                     onblur="validateAndShow('celular','confirmarCelular','field8')">
            </div>
          </div>
        </div>
        <div class="form-field" id="field8">
          <label>Ocupaci√≥n / Profesi√≥n <span class="required">*</span></label>
          <input type="text" id="ocupacion" placeholder="Ej: Ingeniero, Comerciante, etc." required>
        </div>
      </div>

      <!-- Paso 3: Identidad -->
      <div class="form-step" data-step="identidad">
        <h2 class="step-title">Identidad del Inquilino</h2>
        <div class="form-field show">
          <div style="text-align:center;margin-bottom:30px;">
            <h3 style="color:var(--gold-primary);margin-bottom:18px;">¬øEl archivo tiene ambas caras del documento?</h3>
            <div class="decision-buttons">
              <button type="button" class="decision-btn" onclick="setDocumentType(true)">S√ç</button>
              <button type="button" class="decision-btn" onclick="setDocumentType(false)">NO</button>
            </div>
          </div>
          <div id="singleDocUpload" style="display:none;opacity:0;transition:.5s">
            <label>Documento de Identidad (Ambas caras) <span class="required">*</span></label>
            <div class="file-upload-wrapper">
              <label class="file-upload-label" for="docIdentidadCompleto" id="labelDocIdentidadCompleto">
                Seleccionar archivo con ambas caras
              </label>
              <input type="file" id="docIdentidadCompleto" class="file-upload-input" 
                     accept="image/*,.pdf" onchange="handleDocumentUpload(this,'completo')">
            </div>
            <div class="file-size-info">M√°ximo 10MB - Formatos: JPG, PNG, PDF</div>
          </div>
          <div id="doubleDocUpload" style="display:none;opacity:0;transition:.5s">
            <div style="margin-bottom:18px;">
              <label>Cara frontal del documento <span class="required">*</span></label>
              <div class="file-upload-wrapper">
                <label class="file-upload-label" for="docIdentidadFrente" id="labelDocIdentidadFrente">
                  Seleccionar cara frontal
                </label>
                <input type="file" id="docIdentidadFrente" class="file-upload-input" 
                       accept="image/*,.pdf" onchange="handleDocumentUpload(this,'frente')">
              </div>
            </div>
            <div>
              <label>Cara posterior del documento <span class="required">*</span></label>
              <div class="file-upload-wrapper">
                <label class="file-upload-label" for="docIdentidadReverso" id="labelDocIdentidadReverso">
                  Seleccionar cara posterior
                </label>
                <input type="file" id="docIdentidadReverso" class="file-upload-input" 
                       accept="image/*,.pdf" onchange="handleDocumentUpload(this,'reverso')">
              </div>
            </div>
          </div>
        </div>
        <div class="decision-question disabled" id="codeudorQuestion">
          <h3 style="color:var(--gold-primary);margin-bottom:18px;">¬øTiene codeudores?</h3>
          <div class="decision-buttons">
            <button class="decision-btn" id="btnCodeudorNo" onclick="setCodeudor(false)" disabled>NO</button>
            <button class="decision-btn" id="btnCodeudorSi" onclick="setCodeudor(true)" disabled>S√ç</button>
          </div>
        </div>
      </div>

      <!-- Pasos de Codeudores (din√°micos) -->
      <div class="form-step" data-step="codeudor-1">
        <h2 class="step-title">Identidad del Codeudor 1</h2>
        <div id="codeudor1Fields"></div>
        <div class="decision-question">
          <h3 style="color:var(--gold-primary);margin-bottom:18px;">¬øHay m√°s codeudores?</h3>
          <div class="decision-buttons">
            <button class="decision-btn" id="btnMoreCodeudor1No" onclick="addMoreCodeudor(false,1)">NO</button>
            <button class="decision-btn" id="btnMoreCodeudor1Si" onclick="addMoreCodeudor(true,1)">S√ç</button>
          </div>
        </div>
      </div>

      <div class="form-step" data-step="codeudor-2">
        <h2 class="step-title">Identidad del Codeudor 2</h2>
        <div id="codeudor2Fields"></div>
        <div class="decision-question">
          <h3 style="color:var(--gold-primary);margin-bottom:18px;">¬øHay m√°s codeudores?</h3>
          <div class="decision-buttons">
            <button class="decision-btn" id="btnMoreCodeudor2No" onclick="addMoreCodeudor(false,2)">NO</button>
            <button class="decision-btn" id="btnMoreCodeudor2Si" onclick="addMoreCodeudor(true,2)">S√ç</button>
          </div>
        </div>
      </div>

      <div class="form-step" data-step="codeudor-3">
        <h2 class="step-title">Identidad del Codeudor 3</h2>
        <div id="codeudor3Fields"></div>
        <div class="decision-question">
          <h3 style="color:var(--gold-primary);margin-bottom:18px;">M√°ximo de codeudores alcanzado</h3>
        </div>
      </div>

      <!-- Paso Final: Confirmaci√≥n -->
      <div class="form-step" data-step="confirmacion">
        <h2 class="step-title">Revisi√≥n Final</h2>
        <div style="text-align:center;padding:40px 0;">
          <h3 style="color:var(--gold-primary);margin:18px 0;">¬øTodo listo para enviar?</h3>
          <p style="color:#fff;margin-bottom:28px;">
            Revise que toda la informaci√≥n est√© correcta antes de continuar. 
            Si necesita hacer cambios, use el bot√≥n "Anterior".
          </p>
          <button class="btn btn-submit" onclick="mostrarConfirmacion()" style="margin:0 auto;">
            üìã Ver Resumen y Confirmar
          </button>
        </div>
      </div>
    </div>

    <!-- Navegaci√≥n -->
    <div class="form-navigation" id="formNavigation">
      <button type="button" class="btn btn-prev" id="btnPrev" onclick="previousStep()" style="display:none;">
        Anterior
      </button>
      <div style="flex:1;"></div>
      <button type="button" class="btn btn-next" id="btnNext" onclick="nextStep()">
        Siguiente
      </button>
    </div>
  </div>
</div>

<!-- Modal Resumen -->
<div class="modal" id="resumenModal">
  <div class="modal-content">
    <button class="close-btn" onclick="cerrarModalResumen()">Cerrar ‚úï</button>
    <h3 class="modal-title">Resumen de la Informaci√≥n</h3>
    <div id="resumenContenido"></div>
    <div class="actions-row">
      <button class="btn-secondary" onclick="cerrarModalResumen()">Regresar</button>
      <button class="btn btn-submit" onclick="confirmarEnvio()">Confirmar Env√≠o ‚úì</button>
    </div>
  </div>
</div>

<!-- Modal Pago -->
<div class="modal modal-pago" id="modalPago">
  <div class="modal-content">
    <button class="close-btn" onclick="cerrarModalPago()">Cerrar ‚úï</button>
    <h3 class="modal-title">Pago de Derechos de Contrato</h3>
    
    <div class="resume-section">
      <h4>Monto</h4>
      <div class="resume-item">
        Valor a pagar: <b>$60.000 COP</b> 
        <span class="badge-info">Obligatorio</span>
      </div>
    </div>
    
    <div class="resume-section">
      <h4>Transferencia (Nequi)</h4>
      <div class="pago-row">
        <div class="pago-box">
          <span><b>Cuenta:</b> <span id="numeroNequi">3177623878</span></span>
          <button class="copy-btn" id="btnCopyCuenta" onclick="copiarCuenta()">üìã Copiar</button>
        </div>
      </div>
      <div class="notice">Copie el n√∫mero y realice la transferencia desde su app Nequi / Bancolombia.</div>
    </div>
    
    <div class="resume-section">
      <h4>Pago con Tarjeta (Wompi)</h4>
      <a class="link-wompi" target="_blank" rel="noopener" 
         href="https://checkout.wompi.co/l/VPOS_kp6q1M">
        üí≥ Ir a Wompi
      </a>
      <div class="notice">Al finalizar el pago, regrese aqu√≠ y marque "Ya realic√© el pago".</div>
    </div>
    
    <div class="divider"></div>
    
    <div class="resume-section">
      <h4>Adjuntar Comprobante (Opcional)</h4>
      <div class="file-upload-wrapper">
        <label class="file-upload-label" for="comprobantePagoDirecto" id="labelComprobantePagoDirecto">
          Seleccionar comprobante
        </label>
        <input type="file" id="comprobantePagoDirecto" class="file-upload-input" 
               accept="image/*,.pdf" onchange="handleComprobanteDirecto(this)">
      </div>
      <div class="file-size-info">Si lo adjunta aqu√≠ aparecer√° cargado en el Paso 1.</div>
    </div>
    
    <div class="actions-row" style="margin-top:10px;">
      <button class="btn btn-submit" onclick="marcarPagoRealizado()">Ya realic√© el pago ‚úì</button>
      <button class="btn-secondary" onclick="cerrarModalPago()">Cerrar</button>
    </div>
    <div id="msgPagoConfirmado" class="confirm-pago-msg">
      ‚úÖ Pago marcado. Ahora puede iniciar el registro.
    </div>
  </div>
</div>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
  <div class="spinner"></div>
  <h3 id="loadingMsg">Procesando...</h3>
  <p style="font-size:13px;opacity:.8;">No cierre esta ventana.</p>
</div>

<!-- Debug Banner -->
<div id="debugBanner" class="debug-banner" style="display:none;">DEBUG ACTIVO</div>

<!-- Script de configuraci√≥n -->
<script>
const CONFIG = {
  DEBUG: false, // Cambiar a true para desarrollo
  API_URL: 'https://script.google.com/macros/s/TU_ID_REAL_AQUI/exec', // CAMBIAR POR TU ID REAL
  MAX_FILE_SIZE: 10 * 1024 * 1024, // 10MB
  MAX_IMAGE_SIZE: 5 * 1024 * 1024, // 5MB
  COMPRESSION_QUALITY: 0.7,
  MAX_CODEUDORES: 3
};
</script>

<!-- Script principal -->
<script>
// ==============================
// ESTADO GLOBAL
// ==============================
const state = {
  currentStep: 1,
  totalSteps: 4,
  codigoRegistro: '',
  archivosBase64: {},
  hasCodeudores: null,
  numCodeudores: 0,
  documentoCompletoRequerido: null,
  documentosIdentidadCargados: false,
  pagoRealizado: false,
  modoCorreccion: false,
  documentosCorreccion: [],
  steps: [
    {id:'documentos',label:'Documentos',number:1},
    {id:'informacion',label:'Informaci√≥n',number:2},
    {id:'identidad',label:'Identidad',number:3},
    {id:'confirmacion',label:'Confirmaci√≥n',number:4}
  ],
  codeudorDataSaved: {},
  codeudorFieldsCreated: {},
  codeudorDocTipo: {},
  maxFileSize: CONFIG.MAX_FILE_SIZE
};

// ==============================
// INICIALIZACI√ìN
// ==============================
window.onload = function() {
  initializeApp();
  if (CONFIG.DEBUG) {
    document.getElementById('debugBanner').style.display = 'block';
  }
};

function initializeApp() {
  const urlParams = new URLSearchParams(window.location.search);
  state.codigoRegistro = urlParams.get('cdr') || '';
  state.modoCorreccion = urlParams.get('modo') === 'correccion';
  
  console.info('[InquilinoWizard] CDR:', state.codigoRegistro);
  console.info('[InquilinoWizard] Modo:', state.modoCorreccion ? 'Correcci√≥n' : 'Normal');
  
  if (!state.codigoRegistro || !validarCodigoRegistro(state.codigoRegistro)) {
    alert('C√≥digo de registro no v√°lido');
    window.location.href = 'selector.html';
    return;
  }
  
  // Si es modo correcci√≥n, procesar documentos a corregir
  if (state.modoCorreccion) {
    procesarModoCorreccion(urlParams);
  }
  
  createParticles();
}

function validarCodigoRegistro(codigo) {
  const regex = /^[A-Z0-9_\-()#\s\.]+$/i;
  return regex.test(codigo);
}

function procesarModoCorreccion(urlParams) {
  const docs = urlParams.get('docs');
  if (docs) {
    try {
      state.documentosCorreccion = JSON.parse(decodeURIComponent(docs));
      mostrarBannerCorreccion();
    } catch (e) {
      console.error('Error parseando documentos de correcci√≥n:', e);
    }
  }
}

function mostrarBannerCorreccion() {
  const banner = document.getElementById('correctionBanner');
  const list = document.getElementById('correctionList');
  const obs = document.getElementById('correctionObservations');
  
  if (state.documentosCorreccion.length > 0) {
    let html = '';
    state.documentosCorreccion.forEach(doc => {
      html += `<li>${doc}</li>`;
    });
    list.innerHTML = html;
    banner.classList.add('show');
  }
}

// ==============================
// EFECTO PART√çCULAS
// ==============================
function createParticles() {
  const container = document.getElementById('particles');
  for (let i = 0; i < 50; i++) {
    const p = document.createElement('div');
    p.className = 'particle';
    p.style.left = Math.random() * 100 + '%';
    p.style.animationDelay = Math.random() * 15 + 's';
    p.style.animationDuration = (15 + Math.random() * 10) + 's';
    container.appendChild(p);
  }
}

// ==============================
// MODAL DE PAGO
// ==============================
function abrirModalPago() {
  document.getElementById('modalPago').classList.add('show');
  console.log('[Pago] Modal abierto');
}

function cerrarModalPago() {
  document.getElementById('modalPago').classList.remove('show');
  console.log('[Pago] Modal cerrado');
}

function copiarCuenta() {
  const numero = document.getElementById('numeroNequi').textContent.trim();
  navigator.clipboard.writeText(numero).then(() => {
    const btn = document.getElementById('btnCopyCuenta');
    btn.classList.add('copied');
    btn.textContent = '‚úì Copiado';
    setTimeout(() => {
      btn.classList.remove('copied');
      btn.textContent = 'üìã Copiar';
    }, 2000);
  }).catch(() => alert('No se pudo copiar'));
}

function marcarPagoRealizado() {
  state.pagoRealizado = true;
  document.getElementById('msgPagoConfirmado').classList.add('show');
  document.getElementById('bannerPagoOk').classList.add('show');
  console.log('[Pago] pagoRealizado = true');
  setTimeout(() => cerrarModalPago(), 1200);
}

function verificarPagoAntesDeIniciar() {
  if (!state.pagoRealizado && !state.modoCorreccion) {
    abrirModalPago();
    return;
  }
  iniciarRegistro();
}

function handleComprobanteDirecto(input) {
  const file = input.files[0];
  if (!file) return;
  
  if (file.size > state.maxFileSize) {
    alert('Archivo excede el l√≠mite');
    input.value = '';
    return;
  }
  
  const reader = new FileReader();
  reader.onload = e => {
    state.archivosBase64.comprobantePago = {
      nombre: file.name,
      tipo: file.type,
      contenido: e.target.result
    };
    
    const labelMain = document.getElementById('labelComprobantePago');
    if (labelMain) {
      labelMain.textContent = file.name;
      labelMain.classList.add('file-selected');
    }
    
    document.getElementById('labelComprobantePagoDirecto').textContent = 'Comprobante listo ‚úì';
    
    if (!state.pagoRealizado) {
      state.pagoRealizado = true;
      document.getElementById('bannerPagoOk').classList.add('show');
    }
  };
  reader.readAsDataURL(file);
}

function notificarComprobanteCargado() {
  if (!state.pagoRealizado) {
    state.pagoRealizado = true;
    document.getElementById('bannerPagoOk').classList.add('show');
    console.log('[Pago] Comprobante cargado marca pagoRealizado = true');
  }
}

// ==============================
// INICIAR REGISTRO
// ==============================
function iniciarRegistro() {
  document.getElementById('initialScreen').classList.add('hidden');
  document.getElementById('progressContainer').classList.add('show');
  document.getElementById('formContent').classList.add('show');
  document.getElementById('formNavigation').classList.add('show');
  actualizarPasosDinamicos();
  setTimeout(() => document.getElementById('field1')?.classList.add('show'), 100);
}

// ==============================
// PASOS DIN√ÅMICOS
// ==============================
function actualizarPasosDinamicos() {
  state.steps = [
    {id:'documentos',label:'Documentos',number:1},
    {id:'informacion',label:'Informaci√≥n',number:2},
    {id:'identidad',label:'Identidad',number:3}
  ];
  
  let s = 4;
  for (let i = 1; i <= state.numCodeudores; i++) {
    state.steps.push({id:`codeudor-${i}`,label:`Codeudor ${i}`,number:s++});
  }
  
  state.steps.push({id:'confirmacion',label:'Confirmaci√≥n',number:s});
  state.totalSteps = s;
  renderProgressBar();
}

function renderProgressBar() {
  const pb = document.getElementById('progressBar');
  if (!pb) return;
  
  let html = '<div class="progress-line"></div>';
  html += '<div class="progress-line-active" id="progressLineActive" style="width:0%"></div>';
  
  state.steps.forEach((st, idx) => {
    const active = (idx + 1) === state.currentStep;
    const completed = (idx + 1) < state.currentStep;
    html += `
      <div class="step ${active?'active':''} ${completed?'completed':''}" id="step-${st.id}">
        <div class="step-circle">${completed?'‚úì':st.number}</div>
        <div class="step-label">${st.label}</div>
      </div>`;
  });
  
  pb.innerHTML = html;
  updateProgressBar();
}

function updateProgressBar() {
  const progress = ((state.currentStep - 1) / (state.totalSteps - 1)) * 100;
  const line = document.getElementById('progressLineActive');
  if (line) line.style.width = progress + '%';
}

// ==============================
// NAVEGACI√ìN
// ==============================
function nextStep() {
  if (!validateCurrentStep()) return;
  hideCurrentStep();
  state.currentStep++;
  const next = state.steps[state.currentStep - 1];
  if (next.id.includes('codeudor-')) {
    const n = parseInt(next.id.split('-')[1]);
    createCodeudorFields(n);
  }
  showCurrentStep();
  updateNavigationButtons();
  updateProgressBar();
}

function previousStep() {
  if (state.currentStep <= 1) return;
  hideCurrentStep();
  state.currentStep--;
  showCurrentStep();
  updateNavigationButtons();
  updateProgressBar();
}

function hideCurrentStep() {
  const st = state.steps[state.currentStep - 1];
  const el = getStepElement(st.id);
  if (el) el.classList.remove('active');
}

function showCurrentStep() {
  const st = state.steps[state.currentStep - 1];
  const el = getStepElement(st.id);
  if (el) {
    el.classList.add('active');
    if (st.id === 'informacion') {
      setTimeout(() => document.getElementById('field3')?.classList.add('show'), 80);
    }
    if (st.id === 'documentos') {
      setTimeout(() => document.getElementById('field1')?.classList.add('show'), 80);
    }
  }
}

function getStepElement(id) {
  return document.querySelector(`[data-step="${id}"]`);
}

function updateNavigationButtons() {
  const btnPrev = document.getElementById('btnPrev');
  const btnNext = document.getElementById('btnNext');
  btnPrev.style.display = state.currentStep === 1 ? 'none' : 'block';
  const current = state.steps[state.currentStep - 1];
  btnNext.style.display = current.id === 'confirmacion' ? 'none' : 'block';
}

// ==============================
// CODEUDORES
// ==============================
function createCodeudorFields(num) {
  if (state.codeudorFieldsCreated[num]) return;
  
  const container = document.getElementById(`codeudor${num}Fields`);
  if (!container) return;
  
  const saved = state.codeudorDataSaved[num] || {};
  const docTipo = state.codeudorDocTipo[num];
  
  container.innerHTML = `
    <div class="form-field show">
      <div class="form-row">
        <div>
          <label>Tipo de Documento <span class="required">*</span></label>
          <select id="tipoDocCodeudor${num}">
            <option value="">Seleccione...</option>
            <option value="CC" ${saved.tipoDocumento==='CC'?'selected':''}>C√©dula de Ciudadan√≠a</option>
            <option value="CE" ${saved.tipoDocumento==='CE'?'selected':''}>C√©dula de Extranjer√≠a</option>
            <option value="PA" ${saved.tipoDocumento==='PA'?'selected':''}>Pasaporte</option>
          </select>
        </div>
        <div>
          <label>N√∫mero de Documento <span class="required">*</span></label>
          <input type="text" id="numDocCodeudor${num}" value="${saved.numeroDocumento||''}" placeholder="N√∫mero">
        </div>
      </div>
    </div>
    <div class="form-field show">
      <div class="form-row">
        <div>
          <label>Confirmar N√∫mero <span class="required">*</span></label>
          <input type="text" id="confirmNumDocCodeudor${num}" value="${saved.numeroDocumento||''}" 
                 placeholder="Confirmar" onblur="validarCoincidencia('numDocCodeudor${num}','confirmNumDocCodeudor${num}')">
          <div class="validation-message" id="confirmNumDocCodeudor${num}Error"></div>
        </div>
        <div>
          <label>Fecha Expedici√≥n</label>
          <input type="date" id="fechaExpedicionCodeudor${num}" value="${saved.fechaExpedicion||''}">
        </div>
      </div>
    </div>
    <div class="form-field show">
      <div class="form-row">
        <div>
          <label>Nombres <span class="required">*</span></label>
          <input type="text" id="nombresCodeudor${num}" value="${saved.nombres||''}" placeholder="Nombres">
        </div>
        <div>
          <label>Apellidos <span class="required">*</span></label>
          <input type="text" id="apellidosCodeudor${num}" value="${saved.apellidos||''}" placeholder="Apellidos">
        </div>
      </div>
    </div>
    <div class="form-field show">
      <div class="form-row">
        <div>
          <label>Email <span class="required">*</span></label>
          <input type="email" id="emailCodeudor${num}" value="${saved.email||''}" 
                 placeholder="correo@ejemplo.com" onblur="validarEmail(this)">
        </div>
        <div>
          <label>Confirmar Email <span class="required">*</span></label>
          <input type="email" id="confirmEmailCodeudor${num}" value="${saved.email||''}" 
                 placeholder="Confirmar" onblur="validarCoincidencia('emailCodeudor${num}','confirmEmailCodeudor${num}')">
          <div class="validation-message" id="confirmEmailCodeudor${num}Error"></div>
        </div>
      </div>
    </div>
    <div class="form-field show">
      <div class="form-row">
        <div>
          <label>Celular <span class="required">*</span></label>
          <input type="tel" id="celularCodeudor${num}" value="${saved.celular||''}" 
                 placeholder="3001234567" onblur="validarTelefono(this)">
        </div>
        <div>
          <label>Confirmar Celular <span class="required">*</span></label>
          <input type="tel" id="confirmCelularCodeudor${num}" value="${saved.celular||''}" 
                 placeholder="Confirmar" onblur="validarCoincidencia('celularCodeudor${num}','confirmCelularCodeudor${num}')">
          <div class="validation-message" id="confirmCelularCodeudor${num}Error"></div>
        </div>
      </div>
    </div>
    <div class="form-field show" id="docDecisionCodeudor${num}">
      <h3 style="color:var(--gold-primary);margin-bottom:12px;text-align:center;">
        ¬øDocumento codeudor ${num} en un solo archivo?
      </h3>
      <div class="decision-buttons">
        <button type="button" class="decision-btn ${docTipo===true?'selected':''}" 
                onclick="setCodeudorDocumentType(${num},true)">S√ç</button>
        <button type="button" class="decision-btn ${docTipo===false?'selected':''}" 
                onclick="setCodeudorDocumentType(${num},false)">NO</button>
      </div>
    </div>
    <div class="form-field show" id="singleDocCodeudor${num}" style="display:${docTipo===true?'block':'none'}">
      <label>Documento Identidad (Ambas caras) <span class="required">*</span></label>
      <div class="file-upload-wrapper">
        <label class="file-upload-label" for="docCodeudor${num}" id="labelDocCodeudor${num}">
          ${(state.archivosBase64['docCodeudor'+num])?'Archivo cargado ‚úì':'Seleccionar archivo'}
        </label>
        <input type="file" id="docCodeudor${num}" class="file-upload-input" accept="image/*,.pdf" 
               ${docTipo===true?'':'disabled'} onchange="handleCodeudorFile(this,${num})">
      </div>
      <div class="file-size-info">Max 10MB - JPG, PNG, PDF</div>
    </div>
    <div class="form-field show" id="doubleDocCodeudor${num}" style="display:${docTipo===false?'block':'none'}">
      <div style="margin-bottom:12px;">
        <label>Cara frontal <span class="required">*</span></label>
        <div class="file-upload-wrapper">
          <label class="file-upload-label" for="docCodeudor${num}Frente" id="labelDocCodeudor${num}Frente">
            ${(state.archivosBase64['docCodeudor'+num+'Frente'])?'Frente cargado ‚úì':'Seleccionar frente'}
          </label>
          <input type="file" id="docCodeudor${num}Frente" class="file-upload-input" accept="image/*,.pdf" 
                 ${docTipo===false?'':'disabled'} onchange="handleCodeudorDocumentUpload(this,${num},'Frente')">
        </div>
      </div>
      <div>
        <label>Cara posterior <span class="required">*</span></label>
        <div class="file-upload-wrapper">
          <label class="file-upload-label" for="docCodeudor${num}Reverso" id="labelDocCodeudor${num}Reverso">
            ${(state.archivosBase64['docCodeudor'+num+'Reverso'])?'Reverso cargado ‚úì':'Seleccionar reverso'}
          </label>
          <input type="file" id="docCodeudor${num}Reverso" class="file-upload-input" accept="image/*,.pdf" 
                 ${docTipo===false?'':'disabled'} onchange="handleCodeudorDocumentUpload(this,${num},'Reverso')">
       </div>
     </div>
     <div class="file-size-info">Max 10MB c/u - JPG, PNG, PDF</div>
   </div>
 `;
 
 state.codeudorFieldsCreated[num] = true;
}

function setDocumentType(isComplete) {
 state.documentoCompletoRequerido = isComplete;
 event.target.classList.add('selected');
 event.target.parentElement.querySelectorAll('.decision-btn').forEach(b => {
   if (b !== event.target) b.classList.remove('selected');
 });
 
 if (isComplete) {
   document.getElementById('singleDocUpload').style.display = 'block';
   document.getElementById('doubleDocUpload').style.display = 'none';
   setTimeout(() => document.getElementById('singleDocUpload').style.opacity = '1', 60);
 } else {
   document.getElementById('singleDocUpload').style.display = 'none';
   document.getElementById('doubleDocUpload').style.display = 'block';
   setTimeout(() => document.getElementById('doubleDocUpload').style.opacity = '1', 60);
 }
}

function setCodeudor(has) {
 const prev = state.hasCodeudores;
 if (prev === true && !has) limpiarTodosCodeudores();
 
 state.hasCodeudores = has;
 event.target.classList.add('selected');
 event.target.parentElement.querySelectorAll('.decision-btn').forEach(b => {
   if (b !== event.target) b.classList.remove('selected');
 });
 
 state.numCodeudores = has ? 1 : 0;
 actualizarPasosDinamicos();
}

function setCodeudorDocumentType(num, isComplete) {
 state.codeudorDocTipo[num] = isComplete;
 event.target.parentElement.querySelectorAll('.decision-btn').forEach(b => b.classList.remove('selected'));
 event.target.classList.add('selected');
 
 const single = document.getElementById(`singleDocCodeudor${num}`);
 const doble = document.getElementById(`doubleDocCodeudor${num}`);
 
 if (isComplete) {
   single.style.display = 'block';
   doble.style.display = 'none';
   document.getElementById(`docCodeudor${num}`).disabled = false;
   document.getElementById(`docCodeudor${num}Frente`)?.setAttribute('disabled', 'disabled');
   document.getElementById(`docCodeudor${num}Reverso`)?.setAttribute('disabled', 'disabled');
 } else {
   single.style.display = 'none';
   doble.style.display = 'block';
   document.getElementById(`docCodeudor${num}`).setAttribute('disabled', 'disabled');
   document.getElementById(`docCodeudor${num}Frente`).disabled = false;
   document.getElementById(`docCodeudor${num}Reverso`).disabled = false;
 }
}

function addMoreCodeudor(hasMore, currentNum) {
 document.getElementById(`btnMoreCodeudor${currentNum}No`).classList.remove('selected');
 document.getElementById(`btnMoreCodeudor${currentNum}Si`).classList.remove('selected');
 event.target.classList.add('selected');
 
 if (hasMore && currentNum < 3) {
   state.numCodeudores = currentNum + 1;
 } else {
   if (state.numCodeudores > currentNum) {
     for (let i = currentNum + 1; i <= state.numCodeudores; i++) {
       limpiarCodeudor(i);
     }
   }
   state.numCodeudores = currentNum;
 }
 actualizarPasosDinamicos();
}

function limpiarCodeudor(num) {
 delete state.archivosBase64[`docCodeudor${num}`];
 delete state.archivosBase64[`docCodeudor${num}Frente`];
 delete state.archivosBase64[`docCodeudor${num}Reverso`];
 const c = document.getElementById(`codeudor${num}Fields`);
 if (c) c.innerHTML = '';
 delete state.codeudorDataSaved[num];
 delete state.codeudorDocTipo[num];
 state.codeudorFieldsCreated[num] = false;
}

function limpiarTodosCodeudores() {
 for (let i = 1; i <= 3; i++) limpiarCodeudor(i);
 state.numCodeudores = 0;
 state.codeudorDataSaved = {};
 state.codeudorFieldsCreated = {};
 state.codeudorDocTipo = {};
}

// ==============================
// VALIDACIONES DE PASOS
// ==============================
function validateCurrentStep() {
 const st = state.steps[state.currentStep - 1];
 switch (st.id) {
   case 'documentos': return validateStep1();
   case 'informacion': return validateStep2();
   case 'identidad': return validateStep3();
   case 'codeudor-1':
   case 'codeudor-2':
   case 'codeudor-3':
     const n = parseInt(st.id.split('-')[1]);
     return validateCodeudor(n);
   default: return true;
 }
}

function validateStep1() {
 if (!state.archivosBase64.estudioAprobado) {
   alert('Cargue el Documento Estudio Aprobado');
   return false;
 }
 if (!state.archivosBase64.comprobantePago) {
   alert('Cargue el Comprobante de Pago');
   return false;
 }
 return true;
}

function validateStep2() {
 const campos = ['tipoDocumento','numeroDocumento','confirmarDocumento','nombres',
                 'apellidos','email','confirmarEmail','celular','confirmarCelular','ocupacion'];
 
 for (const c of campos) {
   const el = document.getElementById(c);
   if (!el || !el.value.trim()) {
     alert(`Complete: ${c.replace(/([A-Z])/g, ' $1').toLowerCase()}`);
     el?.focus();
     return false;
   }
 }
 
 if (numeroDocumento.value !== confirmarDocumento.value) {
   alert('Los n√∫meros de documento no coinciden');
   return false;
 }
 if (email.value !== confirmarEmail.value) {
   alert('Los emails no coinciden');
   return false;
 }
 if (celular.value !== confirmarCelular.value) {
   alert('Los celulares no coinciden');
   return false;
 }
 return true;
}

function validateStep3() {
 if (state.documentoCompletoRequerido === null) {
   alert('Indique si el documento tiene ambas caras');
   return false;
 }
 
 if (state.documentoCompletoRequerido) {
   if (!state.archivosBase64.docIdentidad) {
     alert('Cargue el documento de identidad');
     return false;
   }
 } else {
   if (!state.archivosBase64.docIdentidadFrente || !state.archivosBase64.docIdentidadReverso) {
     alert('Cargue frente y reverso del documento');
     return false;
   }
 }
 
 if (state.hasCodeudores === null) {
   alert('Indique si tiene codeudores');
   return false;
 }
 return true;
}

function validateCodeudor(num) {
 guardarDatosCodeudor(num);
 
 const campos = [
   `tipoDocCodeudor${num}`,`numDocCodeudor${num}`,`confirmNumDocCodeudor${num}`,
   `nombresCodeudor${num}`,`apellidosCodeudor${num}`,`emailCodeudor${num}`,
   `confirmEmailCodeudor${num}`,`celularCodeudor${num}`,`confirmCelularCodeudor${num}`
 ];
 
 for (const c of campos) {
   const el = document.getElementById(c);
   if (!el || !el.value.trim()) {
     alert(`Complete campos del codeudor ${num}`);
     el?.focus();
     return false;
   }
 }
 
 if (document.getElementById(`numDocCodeudor${num}`).value !== 
     document.getElementById(`confirmNumDocCodeudor${num}`).value) {
   alert(`Documento no coincide en Codeudor ${num}`);
   return false;
 }
 
 if (document.getElementById(`emailCodeudor${num}`).value !== 
     document.getElementById(`confirmEmailCodeudor${num}`).value) {
   alert(`Email no coincide en Codeudor ${num}`);
   return false;
 }
 
 if (document.getElementById(`celularCodeudor${num}`).value !== 
     document.getElementById(`confirmCelularCodeudor${num}`).value) {
   alert(`Celular no coincide en Codeudor ${num}`);
   return false;
 }
 
 if (state.codeudorDocTipo[num] === undefined) {
   alert(`Seleccione tipo de archivo para Codeudor ${num}`);
   return false;
 }
 
 if (state.codeudorDocTipo[num] === true) {
   if (!state.archivosBase64[`docCodeudor${num}`]) {
     alert(`Cargue documento del Codeudor ${num}`);
     return false;
   }
 } else {
   if (!state.archivosBase64[`docCodeudor${num}Frente`] || 
       !state.archivosBase64[`docCodeudor${num}Reverso`]) {
     alert(`Cargue frente y reverso del documento Codeudor ${num}`);
     return false;
   }
 }
 return true;
}

function guardarDatosCodeudor(num) {
 const tipo = document.getElementById(`tipoDocCodeudor${num}`);
 if (tipo) {
   state.codeudorDataSaved[num] = {
     tipoDocumento: tipo.value,
     numeroDocumento: document.getElementById(`numDocCodeudor${num}`)?.value || '',
     nombres: document.getElementById(`nombresCodeudor${num}`)?.value || '',
     apellidos: document.getElementById(`apellidosCodeudor${num}`)?.value || '',
     email: document.getElementById(`emailCodeudor${num}`)?.value || '',
     celular: document.getElementById(`celularCodeudor${num}`)?.value || '',
     fechaExpedicion: document.getElementById(`fechaExpedicionCodeudor${num}`)?.value || ''
   };
 }
}

// ==============================
// VALIDACIONES SIMPLES
// ==============================
function validarEmail(input) {
 const v = input.value.trim();
 const r = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
 if (!r.test(v)) {
   input.classList.add('invalid');
   input.classList.remove('valid');
   return false;
 }
 input.classList.add('valid');
 input.classList.remove('invalid');
 return true;
}

function validarTelefono(input) {
 const v = input.value.trim();
 const r = /^[0-9]{10}$/;
 if (!r.test(v)) {
   input.classList.add('invalid');
   input.classList.remove('valid');
   return false;
 }
 input.classList.add('valid');
 input.classList.remove('invalid');
 return true;
}

function validarCoincidencia(idA, idB) {
 const a = document.getElementById(idA);
 const b = document.getElementById(idB);
 const msg = document.getElementById(idB + 'Error');
 if (!a || !b) return;
 
 if (a.value && b.value && a.value === b.value) {
   b.classList.add('valid');
   b.classList.remove('invalid');
   if (msg) {
     msg.textContent = '‚úì Coincide';
     msg.className = 'validation-message success show';
   }
 } else if (b.value) {
   b.classList.add('invalid');
   b.classList.remove('valid');
   if (msg) {
     msg.textContent = 'No coincide';
     msg.className = 'validation-message error show';
   }
 } else if (msg) {
   msg.classList.remove('show');
 }
}

function validateAndShow(id1, id2, next) {
 validarCoincidencia(id1, id2);
 const v1 = document.getElementById(id1).value;
 const v2 = document.getElementById(id2).value;
 if (v1 === v2 && v1 !== '') {
   showNextField(next);
 }
}

// ==============================
// MANEJO DE ARCHIVOS
// ==============================
function handleFileSelect(input, nextFieldId) {
 const file = input.files[0];
 if (!file) return;
 
 if (file.size > state.maxFileSize) {
   alert('Archivo excede el l√≠mite de 10MB');
   input.value = '';
   return;
 }
 
 const label = document.getElementById('label' + capitalize(input.id));
 if (label) {
   label.textContent = file.name;
   label.classList.add('file-selected');
 }
 
 convertirArchivoBase64(input, () => {
   if (nextFieldId) {
     setTimeout(() => document.getElementById(nextFieldId)?.classList.add('show'), 280);
   }
 });
}

function convertirArchivoBase64(input, cb) {
 const file = input.files[0];
 if (!file) return;
 
 const reader = new FileReader();
 reader.onload = e => {
   state.archivosBase64[input.id] = {
     nombre: file.name,
     tipo: file.type,
     contenido: e.target.result
   };
   if (cb) cb();
 };
 reader.readAsDataURL(file);
}

function handleDocumentUpload(input, tipo) {
 const file = input.files[0];
 if (!file) return;
 
 if (file.size > state.maxFileSize) {
   alert('Archivo excede el l√≠mite');
   input.value = '';
   return;
 }
 
 const labelId = 'labelDocIdentidad' + capitalize(tipo);
 const label = document.getElementById(labelId);
 if (label) {
   label.textContent = file.name;
   label.classList.add('file-selected');
 }
 
 const reader = new FileReader();
 reader.onload = e => {
   if (tipo === 'completo') {
     state.archivosBase64.docIdentidad = {
       nombre: file.name,
       tipo: file.type,
       contenido: e.target.result
     };
     state.documentosIdentidadCargados = true;
   } else if (tipo === 'frente') {
     state.archivosBase64.docIdentidadFrente = {
       nombre: file.name,
       tipo: file.type,
       contenido: e.target.result
     };
     if (state.archivosBase64.docIdentidadReverso) {
       state.documentosIdentidadCargados = true;
     }
   } else if (tipo === 'reverso') {
     state.archivosBase64.docIdentidadReverso = {
       nombre: file.name,
       tipo: file.type,
       contenido: e.target.result
     };
     if (state.archivosBase64.docIdentidadFrente) {
       state.documentosIdentidadCargados = true;
     }
   }
   
   if (state.documentosIdentidadCargados) {
     document.getElementById('codeudorQuestion').classList.remove('disabled');
     document.getElementById('btnCodeudorNo').disabled = false;
     document.getElementById('btnCodeudorSi').disabled = false;
   }
 };
 reader.readAsDataURL(file);
}

function handleCodeudorFile(input, index) {
 const file = input.files[0];
 if (!file) return;
 
 if (file.size > state.maxFileSize) {
   alert('Archivo excede l√≠mite');
   input.value = '';
   return;
 }
 
 const label = document.getElementById(`labelDocCodeudor${index}`);
 if (label) {
   label.textContent = file.name;
   label.classList.add('file-selected');
 }
 convertirArchivoBase64(input);
}

function handleCodeudorDocumentUpload(input, index, parte) {
 const file = input.files[0];
 if (!file) return;
 
 if (file.size > state.maxFileSize) {
   alert('Archivo excede l√≠mite');
   input.value = '';
   return;
 }
 
 const label = document.getElementById(`labelDocCodeudor${index}${parte}`);
 if (label) {
   label.textContent = file.name;
   label.classList.add('file-selected');
 }
 
 const reader = new FileReader();
 reader.onload = e => {
   state.archivosBase64[`docCodeudor${index}${parte}`] = {
     nombre: file.name,
     tipo: file.type,
     contenido: e.target.result
   };
 };
 reader.readAsDataURL(file);
}

// ==============================
// VISUAL HELPERS
// ==============================
function showNextField(id) {
 const el = document.getElementById(id);
 if (el && !el.classList.contains('show')) {
   setTimeout(() => el.classList.add('show'), 250);
 }
}

function capitalize(s) {
 return s.charAt(0).toUpperCase() + s.slice(1);
}

// ==============================
// RESUMEN Y CONFIRMACI√ìN
// ==============================
function mostrarConfirmacion() {
 if (!validateStep1() || !validateStep2() || !validateStep3()) {
   alert('Faltan datos por completar antes de ver el resumen.');
   return;
 }
 
 for (let i = 1; i <= state.numCodeudores; i++) {
   guardarDatosCodeudor(i);
 }
 
 document.getElementById('resumenContenido').innerHTML = generarResumenHTML();
 document.getElementById('resumenModal').classList.add('show');
}

function generarResumenHTML() {
 let html = '';
 
 // Datos del inquilino
 html += `
   <div class="resume-section">
     <h4>Inquilino</h4>
     <div class="resume-grid">
       <div class="resume-item"><b>Tipo Doc:</b> ${val('tipoDocumento')}</div>
       <div class="resume-item"><b>Documento:</b> ${val('numeroDocumento')}</div>
       <div class="resume-item"><b>Nombres:</b> ${val('nombres')}</div>
       <div class="resume-item"><b>Apellidos:</b> ${val('apellidos')}</div>
       <div class="resume-item"><b>Email:</b> ${val('email')}</div>
       <div class="resume-item"><b>Celular:</b> ${val('celular')}</div>
       <div class="resume-item"><b>Ocupaci√≥n:</b> ${val('ocupacion')}</div>
     </div>
   </div>`;
 
 // Documentos
 html += `
   <div class="resume-section">
     <h4>Documentos Iniciales</h4>
     <div class="resume-grid">
       <div class="resume-item"><b>Estudio Aprobado:</b> ${fileName('estudioAprobado')}</div>
       <div class="resume-item"><b>Comprobante Pago:</b> ${fileName('comprobantePago')}</div>
     </div>
   </div>`;
 
 // Identidad
 html += '<div class="resume-section"><h4>Identidad Inquilino</h4><div class="resume-grid">';
 if (state.documentoCompletoRequerido) {
   html += `<div class="resume-item"><b>Documento:</b> ${fileNameObj('docIdentidad')}</div>`;
 } else {
   html += `<div class="resume-item"><b>Frente:</b> ${fileNameObj('docIdentidadFrente')}</div>`;
   html += `<div class="resume-item"><b>Reverso:</b> ${fileNameObj('docIdentidadReverso')}</div>`;
 }
 html += `<div class="resume-item"><b>Codeudores:</b> ${state.numCodeudores}</div></div></div>`;
 
 // Codeudores
 if (state.numCodeudores > 0) {
   for (let i = 1; i <= state.numCodeudores; i++) {
     const d = state.codeudorDataSaved[i] || {};
     html += `
       <div class="resume-section">
         <h4>Codeudor ${i}</h4>
         <div class="resume-grid">
           <div class="resume-item"><b>Tipo Doc:</b> ${d.tipoDocumento || '-'}</div>
           <div class="resume-item"><b>Documento:</b> ${d.numeroDocumento || '-'}</div>
           <div class="resume-item"><b>Nombres:</b> ${d.nombres || '-'}</div>
           <div class="resume-item"><b>Apellidos:</b> ${d.apellidos || '-'}</div>
           <div class="resume-item"><b>Email:</b> ${d.email || '-'}</div>
           <div class="resume-item"><b>Celular:</b> ${d.celular || '-'}</div>
           <div class="resume-item"><b>Archivo:</b> ${
             state.codeudorDocTipo[i] === true
               ? (fileNameObj('docCodeudor' + i))
               : (fileNameObj('docCodeudor' + i + 'Frente') + ' / ' + fileNameObj('docCodeudor' + i + 'Reverso'))
           }</div>
         </div>
       </div>`;
   }
 }
 
 return html;
}

function val(id) {
 return document.getElementById(id)?.value || '-';
}

function fileName(id) {
 return state.archivosBase64[id]?.nombre || 'No cargado';
}

function fileNameObj(id) {
 return state.archivosBase64[id]?.nombre || 'No';
}

function cerrarModalResumen() {
 document.getElementById('resumenModal').classList.remove('show');
}

// ==============================
// ENV√çO FINAL
// ==============================
function confirmarEnvio() {
 const nombres = val('nombres').trim();
 const apellidos = val('apellidos').trim();
 
 const datosFormulario = {
   codigoRegistro: state.codigoRegistro,
   inquilino: {
     nombre: (nombres + ' ' + apellidos).replace(/\s+/g, ' ').trim(),
     tipoDocumento: val('tipoDocumento'),
     numeroDocumento: val('numeroDocumento'),
     email: val('email'),
     celular: val('celular'),
     ocupacion: val('ocupacion')
   },
   codeudores: []
 };
 
 // Agregar codeudores
 for (let i = 1; i <= state.numCodeudores; i++) {
   const d = state.codeudorDataSaved[i];
   if (d) {
     datosFormulario.codeudores.push({
       nombre: (d.nombres + ' ' + d.apellidos).replace(/\s+/g, ' ').trim(),
       tipoDocumento: d.tipoDocumento,
       numeroDocumento: d.numeroDocumento,
       email: d.email,
       celular: d.celular
     });
   }
 }
 
 enviarFormularioInquilino(datosFormulario);
}

async function enviarFormularioInquilino(datosFormulario) {
 mostrarOverlay(true, 'Enviando documentos...');
 
 try {
   // Para producci√≥n, usa el CONFIG.API_URL real
   const response = await fetch(CONFIG.API_URL, {
     method: 'POST',
     mode: 'no-cors',
     headers: {
       'Content-Type': 'text/plain'
     },
     body: JSON.stringify({
       accion: 'procesarFormularioInquilino',
       datosFormulario: datosFormulario,
       archivosBase64: state.archivosBase64
     })
   });
   
   mostrarOverlay(true, 'Documentos enviados. Redirigiendo...');
   
   setTimeout(() => {
     window.location.href = `pagina-exito.html?estado=exitoso&cdr=${encodeURIComponent(state.codigoRegistro)}&tipo=inquilino`;
   }, 1500);
   
 } catch (err) {
   console.error('[InquilinoWizard] Error env√≠o:', err);
   mostrarOverlay(false);
   alert('Error de conexi√≥n. Intente nuevamente.');
 }
}

function mostrarOverlay(show, msg) {
 const ov = document.getElementById('loadingOverlay');
 const lm = document.getElementById('loadingMsg');
 if (show) {
   ov.classList.add('show');
   if (msg) lm.textContent = msg;
 } else {
   ov.classList.remove('show');
 }
}

// ==============================
// LOG FINAL
// ==============================
console.info('‚úÖ [InquilinoWizard] Producci√≥n v7.0 cargado');
console.info('üìã Caracter√≠sticas:');
console.info('- Dise√±o original preservado');
console.info('- Sistema de pago integrado');
console.info('- Modo correcci√≥n habilitado');
console.info('- Validaciones completas');
console.info('- Soporte para 3 codeudores');
</script>
</body>
</html>
