<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Formulario Inquilino - E-firmaContrata</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<style>
/* ===== ESTILOS PRINCIPALES ===== */
:root {
  --gold-primary:#FFD700;--gold-dark:#B8860B;--gold-light:#FFF8DC;
  --black-primary:#0F0F0F;--black-secondary:#1A1A1A;
  --gray-dark:#2D2D2D;--gray-medium:#404040;--white:#FFF;
  --success:#059669;--error:#DC2626;--info:#2563EB;
}

body {
  font-family:'Segoe UI',Tahoma,sans-serif;
  background:var(--black-primary);
  min-height:100vh;
  overflow-x:hidden;
  position:relative;
  margin:0;
}

/* Particles Background */
.particles {
  position:fixed;top:0;left:0;width:100%;height:100%;
  pointer-events:none;overflow:hidden;z-index:1;
}
.particle {
  position:absolute;width:4px;height:4px;
  background:var(--gold-primary);border-radius:50%;
  opacity:0;animation:floatUp 15s infinite;
  box-shadow:0 0 6px var(--gold-primary);
}
@keyframes floatUp {
  0%{opacity:0;transform:translateY(100vh) scale(0)}
  10%{opacity:1;transform:translateY(90vh) scale(1)}
  90%{opacity:1;transform:translateY(10vh) scale(1)}
  100%{opacity:0;transform:translateY(0) scale(0)}
}

/* Container principal */
.main-container {
  position:relative;z-index:10;min-height:100vh;
  display:flex;align-items:center;justify-content:center;padding:20px;
}

.form-card {
  width:100%;max-width:920px;
  background:linear-gradient(135deg,var(--black-secondary),var(--gray-dark));
  border-radius:20px;overflow:hidden;
  box-shadow:0 0 50px rgba(255,215,0,0.1),0 0 100px rgba(255,215,0,0.05);
  border:1px solid rgba(255,215,0,0.2);
}

/* Header con animaci√≥n */
.form-header {
  background:linear-gradient(135deg,var(--gold-dark),var(--gold-primary));
  padding:30px;text-align:center;position:relative;overflow:hidden;
}
.form-header::before {
  content:'';position:absolute;top:-50%;left:-50%;
  width:200%;height:200%;
  background:linear-gradient(45deg,transparent,rgba(255,255,255,.3),transparent);
  animation:shimmer 3s infinite;
}
@keyframes shimmer {
  0%{transform:translateX(-100%) translateY(-100%) rotate(45deg)}
  100%{transform:translateX(100%) translateY(100%) rotate(45deg)}
}

.logo {
  font-size:36px;font-weight:bold;color:var(--black-primary);
  margin-bottom:8px;letter-spacing:2px;
}
.tagline {
  color:var(--black-secondary);font-size:14px;font-weight:500;
}

/* Estado del link */
.link-status {
  padding:15px 30px;
  background:linear-gradient(135deg,#064e3b,#065f46);
  border-bottom:1px solid rgba(255,215,0,0.15);
  display:none;
}
.link-status.show {display:block;}
.link-status.valid {background:linear-gradient(135deg,#064e3b,#065f46);}
.link-status.invalid {background:linear-gradient(135deg,#7f1d1d,#991b1b);}
.link-status-content {
  display:flex;align-items:center;justify-content:center;gap:10px;
  color:#d1fae5;font-size:14px;font-weight:500;
}
.link-status.invalid .link-status-content {color:#fecaca;}

/* Pantalla inicial */
.initial-screen {
  padding:55px 40px;text-align:center;
}
.initial-screen.hidden {display:none;}
.initial-title {
  color:var(--gold-primary);font-size:28px;margin-bottom:18px;
}
.initial-description {
  color:var(--white);margin-bottom:40px;line-height:1.5;
}

/* Botones iniciales */
.initial-buttons {
  display:flex;gap:20px;flex-wrap:wrap;justify-content:center;
}
.initial-btn {
  flex:1;min-width:250px;padding:20px;
  background:var(--black-primary);
  border:2px solid rgba(255,215,0,0.3);
  border-radius:15px;cursor:pointer;
  position:relative;transition:.3s;
}
.initial-btn:hover {
  border-color:var(--gold-primary);
  transform:translateY(-5px);
  box-shadow:0 10px 30px rgba(255,215,0,0.2);
}
.initial-btn-icon {font-size:48px;margin-bottom:10px;}
.initial-btn-title {
  color:var(--gold-primary);font-size:20px;margin-bottom:6px;
}
.initial-btn-desc {color:var(--gray-medium);font-size:14px;}

/* Progress bar */
.progress-container {
  padding:25px 30px;background:var(--gray-dark);
  border-bottom:1px solid rgba(255,215,0,0.15);display:none;
}
.progress-container.show {display:block;}
.progress-bar {
  display:flex;justify-content:space-between;position:relative;
}
.progress-line {
  position:absolute;top:20px;left:0;right:0;
  height:2px;background:var(--gray-medium);
}
.progress-line-active {
  position:absolute;top:20px;left:0;height:2px;
  background:linear-gradient(90deg,var(--gold-dark),var(--gold-primary));
  transition:width .5s;box-shadow:0 0 10px var(--gold-primary);
}

/* Steps */
.step {text-align:center;flex:1;position:relative;}
.step-circle {
  width:40px;height:40px;margin:0 auto 8px;
  border-radius:50%;background:var(--gray-medium);
  display:flex;align-items:center;justify-content:center;
  font-weight:bold;font-size:14px;color:#111;
  border:2px solid var(--gray-medium);transition:.3s;
}
.step.active .step-circle {
  background:var(--gold-primary);color:var(--black-primary);
  border-color:var(--gold-primary);
  box-shadow:0 0 18px rgba(255,215,0,0.5);
}
.step.completed .step-circle {
  background:var(--success);color:#fff;border-color:var(--success);
}
.step-label {font-size:12px;color:var(--gray-medium);}
.step.active .step-label,.step.completed .step-label {
  color:var(--gold-primary);
}

/* Form content */
.form-content {padding:40px;display:none;}
.form-content.show {display:block;}
.form-step {display:none;animation:fadeIn .45s ease;}
.form-step.active {display:block;}
@keyframes fadeIn {
  from{opacity:0;transform:translateX(20px)}
  to{opacity:1;transform:translateX(0)}
}

/* Form fields */
.step-title {
  color:var(--gold-primary);font-size:24px;
  margin:0 0 25px;padding-bottom:10px;
  border-bottom:2px solid rgba(255,215,0,0.25);
}
.form-field {
  opacity:0;transform:translateY(20px);
  transition:.45s;margin-bottom:24px;
}
.form-field.show {opacity:1;transform:translateY(0);}
.form-row {
  display:grid;grid-template-columns:1fr 1fr;gap:20px;
}
@media (max-width:768px){.form-row{grid-template-columns:1fr}}

label {
  display:block;color:var(--gold-light);
  font-size:14px;margin-bottom:6px;font-weight:500;
}
.required {color:var(--gold-primary);}

input[type=text],input[type=email],input[type=tel],input[type=date],select {
  width:100%;padding:12px 14px;
  background:var(--black-primary);
  border:1px solid rgba(255,215,0,0.25);
  border-radius:8px;color:var(--white);
  font-size:14px;transition:.3s;
}
input:focus,select:focus {
  outline:none;border-color:var(--gold-primary);
  box-shadow:0 0 0 3px rgba(255,215,0,0.15);
}

/* File upload */
.file-upload-wrapper {
  position:relative;overflow:hidden;
  display:inline-block;width:100%;
}
.file-upload-label {
  display:block;padding:12px 15px;text-align:center;
  background:linear-gradient(135deg,var(--gray-dark),var(--black-primary));
  border:2px dashed rgba(255,215,0,0.35);
  border-radius:8px;color:var(--gold-light);
  cursor:pointer;transition:.3s;
}
.file-upload-label:hover {
  border-color:var(--gold-primary);
  background:linear-gradient(135deg,var(--black-primary),var(--gray-dark));
}
.file-selected {
  background:rgba(255,215,0,0.1);
  border-color:var(--gold-primary);
}
.file-size-info {
  font-size:11px;color:var(--gray-medium);margin-top:5px;
}

/* Navigation */
.form-navigation {
  display:none;justify-content:space-between;
  align-items:center;padding:28px 40px;
  background:var(--gray-dark);
  border-top:1px solid rgba(255,215,0,0.15);
}
.form-navigation.show {display:flex;}

/* Buttons */
.btn {
  padding:12px 30px;border:none;border-radius:8px;
  font-size:15px;font-weight:600;cursor:pointer;
  transition:.35s;text-transform:uppercase;letter-spacing:.5px;
}
.btn-prev {background:var(--gray-medium);color:#fff;}
.btn-prev:hover {background:var(--gray-dark);transform:translateX(-5px);}
.btn-next,.btn-submit {
  background:linear-gradient(135deg,var(--gold-dark),var(--gold-primary));
  color:var(--black-primary);position:relative;overflow:hidden;
}
.btn:disabled {opacity:.5;cursor:not-allowed;transform:none!important;}

/* Modal pago */
.modal {
  display:none;position:fixed;top:0;left:0;
  width:100%;height:100%;background:rgba(0,0,0,.9);
  z-index:1000;align-items:center;justify-content:center;padding:20px;
}
.modal.show {display:flex;}
.modal-content {
  background:linear-gradient(135deg,var(--black-secondary),var(--gray-dark));
  max-width:520px;width:100%;padding:34px 38px;
  border-radius:18px;border:1px solid rgba(255,215,0,0.3);
  box-shadow:0 0 25px rgba(255,215,0,0.18);
  max-height:92vh;overflow-y:auto;position:relative;
}
.close-btn {
  position:absolute;top:12px;right:12px;
  background:none;border:1px solid var(--gold-primary);
  color:var(--gold-primary);padding:6px 12px;
  border-radius:6px;cursor:pointer;font-weight:600;
}
.modal-title {
  color:var(--gold-primary);font-size:24px;
  margin:0 0 18px;text-align:center;
}

/* Loading */
.loading-overlay {
  position:fixed;top:0;left:0;width:100%;height:100%;
  background:rgba(0,0,0,.85);display:none;
  flex-direction:column;align-items:center;
  justify-content:center;z-index:1300;color:#fff;
}
.loading-overlay.show {display:flex;}
.spinner {
  border:4px solid #444;border-top:4px solid var(--gold-primary);
  border-radius:50%;width:60px;height:60px;
  animation:spin 1s linear infinite;margin-bottom:25px;
}
@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}

/* Debug banner */
.debug-banner {
  position:fixed;bottom:8px;right:8px;
  background:rgba(255,215,0,0.12);
  border:1px solid var(--gold-primary);
  padding:6px 12px;color:var(--gold-primary);
  font-size:12px;border-radius:6px;z-index:1500;
  font-weight:600;backdrop-filter:blur(4px);
}

/* Decision buttons */
.decision-question {
  text-align:center;padding:35px 0;transition:.3s;
}
.decision-question.disabled {opacity:.35;pointer-events:none;}
.decision-buttons {
  display:flex;gap:18px;justify-content:center;
  flex-wrap:wrap;margin-top:25px;
}
.decision-btn {
  padding:14px 38px;background:var(--black-primary);
  border:2px solid rgba(255,215,0,0.35);
  border-radius:10px;color:#fff;cursor:pointer;
  font-size:15px;font-weight:600;transition:.35s;
}
.decision-btn:hover:not(:disabled) {
  border-color:var(--gold-primary);
  box-shadow:0 5px 18px rgba(255,215,0,0.25);
}
.decision-btn.selected {
  background:var(--gold-primary);
  color:var(--black-primary);
  border-color:var(--gold-primary);
}
</style>
</head>
<body>

<div class="particles" id="particles"></div>

<div class="main-container">
  <div class="form-card">
    <!-- Header -->
    <div class="form-header">
      <div class="logo">E-FirmaContrata</div>
      <div class="tagline">Sistema de Gesti√≥n Documental - Inquilino</div>
    </div>

    <!-- Status del link -->
    <div id="linkStatus" class="link-status">
      <div class="link-status-content">
        <span id="statusIcon">‚è≥</span>
        <span id="statusText">Verificando acceso...</span>
      </div>
    </div>

    <!-- Pantalla inicial -->
    <div class="initial-screen" id="initialScreen">
      <h2 class="initial-title">Bienvenido al Sistema de Registro</h2>
      <p class="initial-description">
        Para continuar con el proceso de arrendamiento, primero debe realizar el pago 
        de los derechos de contrato y luego proceder con el registro de sus documentos.
      </p>
      <div class="initial-buttons">
        <div class="initial-btn" onclick="abrirModalPago()">
          <div class="initial-btn-icon">üí≥</div>
          <div class="initial-btn-title">Pagar Derechos</div>
          <div class="initial-btn-desc">Valor: $60.000 COP</div>
        </div>
        <div class="initial-btn" onclick="verificarPagoAntesDeIniciar()">
          <div class="initial-btn-icon">üìù</div>
          <div class="initial-btn-title">Registrarse</div>
          <div class="initial-btn-desc">Complete su documentaci√≥n</div>
        </div>
      </div>
    </div>

    <!-- Progress bar (oculto inicialmente) -->
    <div class="progress-container" id="progressContainer">
      <div class="progress-bar" id="progressBar"></div>
    </div>

    <!-- Contenido del formulario (oculto inicialmente) -->
    <div class="form-content" id="formContent">
      <!-- Los pasos del formulario se mantendr√°n aqu√≠ -->
    </div>

    <!-- Navegaci√≥n (oculta inicialmente) -->
    <div class="form-navigation" id="formNavigation">
      <button type="button" class="btn btn-prev" id="btnPrev" onclick="previousStep()" style="display:none;">
        Anterior
      </button>
      <div style="flex:1;"></div>
      <button type="button" class="btn btn-next" id="btnNext" onclick="nextStep()">
        Siguiente
      </button>
    </div>
  </div>
</div>

<!-- Modal de pago -->
<div class="modal" id="modalPago">
  <div class="modal-content">
    <button class="close-btn" onclick="cerrarModalPago()">Cerrar ‚úï</button>
    <h3 class="modal-title">Pago de Derechos de Contrato</h3>
    <div style="padding:20px 0;">
      <p style="color:var(--gold-light);margin-bottom:20px;">
        Valor a pagar: <strong style="color:var(--gold-primary);font-size:24px;">$60.000 COP</strong>
      </p>
      <p style="color:#999;font-size:14px;">
        Realice el pago y adjunte el comprobante para continuar.
      </p>
    </div>
    <button class="btn btn-submit" onclick="marcarPagoRealizado()" style="width:100%;">
      Ya realic√© el pago ‚úì
    </button>
  </div>
</div>

<!-- Loading overlay -->
<div class="loading-overlay" id="loadingOverlay">
  <div class="spinner"></div>
  <h3 id="loadingMsg">Procesando...</h3>
  <p style="font-size:13px;opacity:.8;">No cierre esta ventana.</p>
</div>

<!-- Debug banner -->
<div id="debugBanner" class="debug-banner" style="display:none;">DEBUG ACTIVO</div>

<script>
// ===== CONFIGURACI√ìN =====
const CONFIG = {
  DEBUG: true,
  API_URL: 'https://script.google.com/macros/s/AKfycbzOnhQ8CD2gWMdvvYnF2v1FL3yto5sM8i_jV9FmIJa1Os05YwXR5RKSsq22ePlwqQgL/exec',
  MAX_FILE_SIZE: 10 * 1024 * 1024
};

// ===== ESTADO GLOBAL =====
const state = {
  codigoRegistro: '',
  linkValido: false,
  pagoRealizado: false,
  currentStep: 1,
  totalSteps: 4,
  archivosBase64: {},
  hasCodeudores: null,
  numCodeudores: 0,
  documentoCompletoRequerido: null
};

// ===== INICIALIZACI√ìN =====
window.onload = function() {
  console.log('üöÄ Iniciando formulario inquilino...');
  
  // Mostrar debug si est√° activo
  if (CONFIG.DEBUG) {
    document.getElementById('debugBanner').style.display = 'block';
  }
  
  // Obtener par√°metros
  const urlParams = new URLSearchParams(window.location.search);
  state.codigoRegistro = urlParams.get('cdr') || '';
  const modo = urlParams.get('modo') || 'normal';
  
  console.log('üìã CDR:', state.codigoRegistro);
  console.log('üîß Modo:', modo);
  
  // Verificar CDR
  if (!state.codigoRegistro) {
    mostrarErrorAcceso('No se proporcion√≥ c√≥digo de registro');
    return;
  }
  
  // Validar formato CDR
  if (!validarCodigoRegistro(state.codigoRegistro)) {
    mostrarErrorAcceso('C√≥digo de registro inv√°lido');
    return;
  }
  
  // Verificar estado del link
  verificarEstadoLink();
  
  // Crear part√≠culas de fondo
  createParticles();
};

// ===== VERIFICACI√ìN DE LINK =====
async function verificarEstadoLink() {
  const statusEl = document.getElementById('linkStatus');
  const statusIcon = document.getElementById('statusIcon');
  const statusText = document.getElementById('statusText');
  
  statusEl.classList.add('show');
  
  try {
    // Para modo desarrollo, siempre v√°lido con c√≥digos TEST
    if (CONFIG.DEBUG && state.codigoRegistro.startsWith('TEST')) {
      state.linkValido = true;
      statusEl.classList.add('valid');
      statusIcon.textContent = '‚úÖ';
      statusText.textContent = 'Link v√°lido - Modo desarrollo';
      return;
    }
    
    // Llamar API para verificar
    const response = await fetch(
      `${CONFIG.API_URL}?accion=verificarLink&cdr=${encodeURIComponent(state.codigoRegistro)}&tipo=inquilino`
    );
    
    if (!response.ok) throw new Error('Error en verificaci√≥n');
    
    const resultado = await response.json();
    
    if (resultado.activo) {
      state.linkValido = true;
      statusEl.classList.add('valid');
      statusIcon.textContent = '‚úÖ';
      statusText.textContent = 'Link v√°lido - Puede continuar';
    } else {
      state.linkValido = false;
      statusEl.classList.add('invalid');
      statusIcon.textContent = 'üîí';
      statusText.textContent = 'Link ya utilizado o inv√°lido';
      mostrarErrorAcceso('Este formulario ya fue completado anteriormente');
    }
    
  } catch (error) {
    console.error('Error verificando link:', error);
    // En caso de error, permitir acceso en desarrollo
    if (CONFIG.DEBUG) {
      state.linkValido = true;
      statusEl.classList.add('valid');
      statusIcon.textContent = '‚ö†Ô∏è';
      statusText.textContent = 'Error de verificaci√≥n - Modo desarrollo activo';
    } else {
      mostrarErrorAcceso('Error verificando acceso');
    }
  }
}

// ===== FUNCIONES DE VALIDACI√ìN =====
function validarCodigoRegistro(codigo) {
  const regex = /^[A-Z0-9_\-()#\s\.]+$/i;
  return regex.test(codigo);
}

function mostrarErrorAcceso(mensaje) {
  document.getElementById('initialScreen').innerHTML = `
    <div style="text-align:center;padding:40px;">
      <div style="font-size:60px;margin-bottom:20px;">üîí</div>
      <h2 style="color:var(--error);margin-bottom:20px;">Acceso Denegado</h2>
      <p style="color:var(--white);margin-bottom:30px;">${mensaje}</p>
      <a href="selector.html" style="display:inline-block;padding:12px 30px;background:var(--gold-primary);color:var(--black-primary);text-decoration:none;border-radius:8px;font-weight:600;">
        Volver al Inicio
      </a>
    </div>
  `;
}

// ===== FUNCIONES DE PAGO =====
function abrirModalPago() {
  if (!state.linkValido && !CONFIG.DEBUG) {
    alert('El link no es v√°lido');
    return;
  }
  document.getElementById('modalPago').classList.add('show');
}

function cerrarModalPago() {
  document.getElementById('modalPago').classList.remove('show');
}

function marcarPagoRealizado() {
  state.pagoRealizado = true;
  cerrarModalPago();
  alert('‚úÖ Pago registrado. Puede continuar con el registro.');
}

function verificarPagoAntesDeIniciar() {
  if (!state.linkValido && !CONFIG.DEBUG) {
    alert('El link no es v√°lido');
    return;
  }
  
  if (!state.pagoRealizado && !CONFIG.DEBUG) {
    alert('Debe realizar el pago antes de continuar');
    abrirModalPago();
    return;
  }
  
  iniciarRegistro();
}

// ===== INICIAR REGISTRO =====
function iniciarRegistro() {
  console.log('üìù Iniciando registro...');
  
  // Ocultar pantalla inicial
  document.getElementById('initialScreen').classList.add('hidden');
  
  // Mostrar progress y formulario
  document.getElementById('progressContainer').classList.add('show');
  document.getElementById('formContent').classList.add('show');
  document.getElementById('formNavigation').classList.add('show');
  
  // Cargar contenido del formulario
  cargarFormulario();
}

// ===== CARGAR FORMULARIO =====
function cargarFormulario() {
  // Aqu√≠ va el contenido completo del formulario
  // Por brevedad, muestro estructura b√°sica
  document.getElementById('formContent').innerHTML = `
    <!-- Paso 1: Documentos -->
    <div class="form-step active" data-step="1">
      <h2 class="step-title">Documentos Iniciales</h2>
      <div class="form-field show">
        <label>Documento Estudio Aprobado <span class="required">*</span></label>
        <div class="file-upload-wrapper">
          <label class="file-upload-label" for="estudioAprobado">
            Seleccionar archivo
          </label>
          <input type="file" id="estudioAprobado" style="display:none" accept="image/*,.pdf">
        </div>
        <div class="file-size-info">M√°ximo 10MB - Formatos: JPG, PNG, PDF</div>
      </div>
    </div>
    
    <!-- M√°s pasos aqu√≠... -->
  `;
  
  // Inicializar progress bar
  actualizarProgressBar();
}

// ===== NAVEGACI√ìN =====
function nextStep() {
  // L√≥gica para siguiente paso
  console.log('Siguiente paso...');
}

function previousStep() {
  // L√≥gica para paso anterior
  console.log('Paso anterior...');
}

function actualizarProgressBar() {
  // Actualizar barra de progreso
}

// ===== EFECTOS VISUALES =====
function createParticles() {
  const container = document.getElementById('particles');
  for (let i = 0; i < 50; i++) {
    const particle = document.createElement('div');
    particle.className = 'particle';
    particle.style.left = Math.random() * 100 + '%';
    particle.style.animationDelay = Math.random() * 15 + 's';
    particle.style.animationDuration = (15 + Math.random() * 10) + 's';
    container.appendChild(particle);
  }
}

// ===== LOG DE INICIALIZACI√ìN =====
console.log('‚úÖ Formulario Inquilino v2.0 cargado');
console.log('üìã CDR:', state.codigoRegistro);
console.log('üîß Debug:', CONFIG.DEBUG ? 'ACTIVO' : 'INACTIVO');
</script>

</body>
</html>
