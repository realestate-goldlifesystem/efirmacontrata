<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulario Inquilino - E-firmaContrata</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <div class="card">
            <div class="card-header">
                <h1>üè† Documentos de Arrendamiento</h1>
                <p>Complete el proceso para la elaboraci√≥n del contrato</p>
            </div>

            <div class="card-body">
                <!-- Banner modo correcci√≥n -->
                <div id="correctionBanner" class="alert alert-warning" style="display: none;">
                    <h3>üìã Modo Correcci√≥n</h3>
                    <p>Solo necesitas cargar los siguientes documentos:</p>
                    <ul id="correctionDocsList"></ul>
                </div>

                <!-- Progress bar -->
                <div class="progress-container">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressBar"></div>
                    </div>
                    <div class="progress-text" id="progressText">Paso 1 de 4</div>
                </div>

                <!-- Mensaje de error/√©xito -->
                <div id="alertMessage" class="alert" style="display: none;"></div>

                <!-- SECCI√ìN 1: Archivos iniciales -->
                <div class="form-section active" id="section1">
                    <h2>üìé Documentos Iniciales</h2>
                    
                    <div class="form-group" id="estudioAprobadoGroup">
                        <label>Estudio Aprobado <span class="required">*</span></label>
                        <div class="file-upload" onclick="document.getElementById('estudioAprobado').click()">
                            <input type="file" id="estudioAprobado" accept="*/*" style="display: none;" onchange="handleFileSelect(this, 'estudioList', 'estudioAprobado')">
                            <div class="upload-icon">üìÑ</div>
                            <div class="upload-text">Haga clic para seleccionar el archivo</div>
                            <small>Cualquier formato (m√°x. 10MB)</small>
                        </div>
                        <div id="estudioList" class="file-list"></div>
                    </div>

                    <div class="form-group" id="comprobantePagoGroup">
                        <label>Comprobante de Pago <span class="required">*</span></label>
                        <div class="file-upload" onclick="document.getElementById('comprobantePago').click()">
                            <input type="file" id="comprobantePago" accept="*/*" style="display: none;" onchange="handleFileSelect(this, 'pagoList', 'comprobantePago')">
                            <div class="upload-icon">üí≥</div>
                            <div class="upload-text">Haga clic para seleccionar el archivo</div>
                            <small>Comprobante de los $60.000</small>
                        </div>
                        <div id="pagoList" class="file-list"></div>
                    </div>
                </div>

                <!-- SECCI√ìN 2: Datos del inquilino -->
                <div class="form-section" id="section2">
                    <h2>üë§ Datos del Inquilino</h2>
                    
                    <div class="form-grid">
                        <div class="form-group full-width">
                            <label>Nombre Completo <span class="required">*</span></label>
                            <input type="text" id="nombreInquilino" placeholder="Nombres y apellidos completos">
                        </div>
                        
                        <div class="form-group">
                            <label>Tipo de Documento <span class="required">*</span></label>
                            <select id="tipoDocInquilino">
                                <option value="">Seleccione...</option>
                                <option value="CC">C√©dula de Ciudadan√≠a</option>
                                <option value="CE">C√©dula de Extranjer√≠a</option>
                                <option value="PAS">Pasaporte</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>N√∫mero de Documento <span class="required">*</span></label>
                            <div class="validation-group">
                                <input type="text" id="docInquilino1" placeholder="Ingrese el n√∫mero">
                                <input type="text" id="docInquilino2" placeholder="Confirme el n√∫mero" disabled>
                                <span class="validation-status" id="docStatus"></span>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Correo Electr√≥nico <span class="required">*</span></label>
                            <div class="validation-group">
                                <input type="email" id="emailInquilino1" placeholder="correo@ejemplo.com">
                                <input type="email" id="emailInquilino2" placeholder="Confirme el correo" disabled>
                                <span class="validation-status" id="emailStatus"></span>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>N√∫mero de Celular <span class="required">*</span></label>
                            <div class="validation-group">
                                <input type="tel" id="celInquilino1" placeholder="3001234567">
                                <input type="tel" id="celInquilino2" placeholder="Confirme el n√∫mero" disabled>
                                <span class="validation-status" id="celStatus"></span>
                            </div>
                        </div>
                    </div>

                    <div class="form-group" id="cedulaInquilinoGroup">
                        <label>Fotograf√≠as del Documento <span class="required">*</span></label>
                        <div class="form-grid">
                            <div>
                                <label class="sub-label">Frontal</label>
                                <div class="file-upload" onclick="document.getElementById('docFrontalInquilino').click()">
                                    <input type="file" id="docFrontalInquilino" accept="image/*,application/pdf" style="display: none;" onchange="handleFileSelect(this, 'frontalInquilinoList', 'docFrontalInquilino')">
                                    <div class="upload-icon">üì∑</div>
                                    <div class="upload-text">Frontal del documento</div>
                                </div>
                                <div id="frontalInquilinoList" class="file-list"></div>
                            </div>
                            <div>
                                <label class="sub-label">Trasero</label>
                                <div class="file-upload" onclick="document.getElementById('docTraseroInquilino').click()">
                                    <input type="file" id="docTraseroInquilino" accept="image/*,application/pdf" style="display: none;" onchange="handleFileSelect(this, 'traseroInquilinoList', 'docTraseroInquilino')">
                                    <div class="upload-icon">üì∑</div>
                                    <div class="upload-text">Trasero del documento</div>
                                </div>
                                <div id="traseroInquilinoList" class="file-list"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SECCI√ìN 3: Pregunta sobre codeudores -->
                <div class="form-section" id="section3">
                    <div class="codeudor-question">
                        <h2>üë• ¬øEn el estudio aparecen codeudores?</h2>
                        <div class="question-buttons">
                            <button type="button" class="btn btn-option" onclick="responderCodeudor(true)">S√≠</button>
                            <button type="button" class="btn btn-option" onclick="responderCodeudor(false)">No</button>
                        </div>
                    </div>
                </div>

                <!-- SECCI√ìN 4: Datos de codeudores (din√°mica) -->
                <div id="codeudorSections"></div>

                <!-- SECCI√ìN FINAL: Confirmaci√≥n -->
                <div class="form-section" id="finalSection">
                    <div class="success-message">
                        <div class="success-icon">‚úÖ</div>
                        <h2>¬°Todo listo para enviar!</h2>
                        <p>Revise que todos los documentos est√©n cargados correctamente antes de continuar.</p>
                        
                        <div class="summary" id="summaryContent">
                            <!-- Se llena din√°micamente -->
                        </div>
                    </div>
                </div>

                <!-- Navegaci√≥n -->
                <div class="form-navigation">
                    <button class="btn btn-secondary" id="btnPrev" onclick="navegarSeccion(-1)" style="display: none;">
                        ‚Üê Anterior
                    </button>
                    <button class="btn btn-primary" id="btnNext" onclick="navegarSeccion(1)">
                        Siguiente ‚Üí
                    </button>
                    <button class="btn btn-success" id="btnSubmit" onclick="enviarFormulario()" style="display: none;">
                        üöÄ Enviar Documentos
                    </button>
                </div>

                <!-- Loading -->
                <div id="loadingOverlay" class="loading-overlay" style="display: none;">
                    <div class="spinner"></div>
                    <p>Procesando documentos...</p>
                </div>
            </div>
        </div>
    </div>

    <script src="config.js"></script>
    <script>
        // ==========================================
        // VARIABLES GLOBALES
        // ==========================================
        let currentSection = 1;
        let totalSections = 4;
        let tieneCodeudores = false;
        let numCodeudores = 0;
        const maxCodeudores = 3;
        let archivosBase64 = {};
        let modoFormulario = 'normal';
        let documentosACorregir = [];
        let codigoRegistro = '';

        // ==========================================
        // INICIALIZACI√ìN
        // ==========================================
        window.onload = async function() {
            console.log('üöÄ Iniciando formulario inquilino');
            
            // Obtener par√°metros de URL
            const urlParams = new URLSearchParams(window.location.search);
            codigoRegistro = urlParams.get('cdr');
            modoFormulario = urlParams.get('modo') || 'normal';
            
            if (!codigoRegistro) {
                mostrarError('C√≥digo de registro no v√°lido');
                deshabilitarFormulario();
                return;
            }

            // Verificar estado del link
            const linkActivo = await verificarEstadoLink();
            if (!linkActivo) {
                deshabilitarFormulario();
                return;
            }

            // Si es modo correcci√≥n, configurar
            if (modoFormulario === 'correccion') {
                configurarModoCorreccion();
            }

            actualizarProgreso();
        };

        // ==========================================
        // VERIFICACI√ìN DE LINK
        // ==========================================
        async function verificarEstadoLink() {
            try {
                mostrarLoading(true);
                const response = await fetch(`${CONFIG.API_URL}?accion=verificarLink&cdr=${codigoRegistro}&tipo=inquilino`);
                const data = await response.json();
                
                if (!data.success || !data.activo) {
                    mostrarError(CONFIG.MESSAGES.LINK_INACTIVO);
                    return false;
                }
                
                return true;
            } catch(error) {
                console.error('Error verificando link:', error);
                mostrarError('Error de conexi√≥n. Intente nuevamente.');
                return false;
            } finally {
                mostrarLoading(false);
            }
        }

        // ==========================================
        // MODO CORRECCI√ìN
        // ==========================================
        function configurarModoCorreccion() {
            // Obtener documentos a corregir de la URL
            const docsParam = new URLSearchParams(window.location.search).get('docs');
            if (docsParam) {
                try {
                    documentosACorregir = JSON.parse(decodeURIComponent(docsParam));
                } catch(e) {
                    console.error('Error parseando documentos:', e);
                }
            }

            // Mostrar banner
            const banner = document.getElementById('correctionBanner');
            if (banner && documentosACorregir.length > 0) {
                banner.style.display = 'block';
                const lista = document.getElementById('correctionDocsList');
                lista.innerHTML = documentosACorregir.map(doc => `<li>${doc}</li>`).join('');
            }

            // Marcar campos ya aprobados
            marcarCamposAprobados();
        }

        function marcarCamposAprobados() {
            if (!documentosACorregir.includes('Estudio aprobado')) {
                document.getElementById('estudioAprobadoGroup').classList.add('approved');
            }
            if (!documentosACorregir.includes('Comprobante de pago')) {
                document.getElementById('comprobantePagoGroup').classList.add('approved');
            }
            if (!documentosACorregir.includes('C√©dula del inquilino')) {
                document.getElementById('cedulaInquilinoGroup').classList.add('approved');
            }
        }

        // ==========================================
        // NAVEGACI√ìN
        // ==========================================
        function navegarSeccion(direccion) {
            // Validar secci√≥n actual antes de avanzar
            if (direccion === 1 && !validarSeccionActual()) {
                return;
            }

            currentSection += direccion;
            
            if (currentSection < 1) currentSection = 1;
            if (currentSection > totalSections) currentSection = totalSections;

            mostrarSeccion();
            actualizarProgreso();
            actualizarBotones();
        }

        function mostrarSeccion() {
            // Ocultar todas las secciones
            document.querySelectorAll('.form-section').forEach(section => {
                section.classList.remove('active');
            });

            // Determinar qu√© secci√≥n mostrar
            if (currentSection <= 3) {
                document.getElementById(`section${currentSection}`).classList.add('active');
            } else if (currentSection > 3 && currentSection <= 3 + numCodeudores) {
                const codeudorIndex = currentSection - 3;
                document.getElementById(`codeudorSection${codeudorIndex}`).classList.add('active');
            } else {
                document.getElementById('finalSection').classList.add('active');
                generarResumen();
            }
        }

        function actualizarProgreso() {
            const progress = (currentSection / totalSections) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('progressText').textContent = `Paso ${currentSection} de ${totalSections}`;
        }

        function actualizarBotones() {
            const prevBtn = document.getElementById('btnPrev');
            const nextBtn = document.getElementById('btnNext');
            const submitBtn = document.getElementById('btnSubmit');

            // Bot√≥n anterior
            prevBtn.style.display = currentSection === 1 ? 'none' : 'inline-block';

            // Bot√≥n siguiente vs enviar
            if (currentSection === totalSections) {
                nextBtn.style.display = 'none';
                submitBtn.style.display = 'inline-block';
            } else {
                nextBtn.style.display = 'inline-block';
                submitBtn.style.display = 'none';
            }
        }

        // ==========================================
        // VALIDACIONES
        // ==========================================
        function validarSeccionActual() {
            let esValido = true;
            
            switch(currentSection) {
                case 1: // Archivos iniciales
                    esValido = validarArchivosIniciales();
                    break;
                case 2: // Datos inquilino
                    esValido = validarDatosInquilino();
                    break;
                case 3: // Pregunta codeudores
                    esValido = validarPreguntaCodeudores();
                    break;
                default:
                    if (currentSection > 3 && currentSection <= 3 + numCodeudores) {
                        const codeudorIndex = currentSection - 3;
                        esValido = validarDatosCodeudor(codeudorIndex);
                    }
            }
            
            return esValido;
        }

        function validarArchivosIniciales() {
            if (modoFormulario === 'correccion') {
                if (documentosACorregir.includes('Estudio aprobado') && !archivosBase64.estudioAprobado) {
                    mostrarError('Por favor cargue el estudio aprobado.');
                    return false;
                }
                if (documentosACorregir.includes('Comprobante de pago') && !archivosBase64.comprobantePago) {
                    mostrarError('Por favor cargue el comprobante de pago.');
                    return false;
                }
                return true;
            }

            if (!archivosBase64.estudioAprobado || !archivosBase64.comprobantePago) {
                mostrarError('Por favor cargue ambos archivos requeridos.');
                return false;
            }
            
            return true;
        }

        function validarDatosInquilino() {
            const nombre = document.getElementById('nombreInquilino').value.trim();
            const tipoDoc = document.getElementById('tipoDocInquilino').value;
            const doc1 = document.getElementById('docInquilino1').value.trim();
            const doc2 = document.getElementById('docInquilino2').value.trim();
            const email1 = document.getElementById('emailInquilino1').value.trim();
            const email2 = document.getElementById('emailInquilino2').value.trim();
            const cel1 = document.getElementById('celInquilino1').value.trim();
            const cel2 = document.getElementById('celInquilino2').value.trim();

            if (!nombre || !tipoDoc) {
                mostrarError('Por favor complete todos los campos obligatorios.');
                return false;
            }

            if (doc1 !== doc2) {
                mostrarError('Los n√∫meros de documento no coinciden.');
                return false;
            }

            if (email1 !== email2) {
                mostrarError('Los correos electr√≥nicos no coinciden.');
                return false;
            }

            if (cel1 !== cel2) {
                mostrarError('Los n√∫meros de celular no coinciden.');
                return false;
            }

            // Validar fotos del documento
            if (modoFormulario !== 'correccion' || documentosACorregir.includes('C√©dula del inquilino')) {
                if (!archivosBase64.docFrontalInquilino || !archivosBase64.docTraseroInquilino) {
                    mostrarError('Por favor cargue ambas fotos del documento.');
                    return false;
                }
            }

            return true;
        }

        function validarPreguntaCodeudores() {
            // La pregunta se valida autom√°ticamente al responder
            return true;
        }

        function validarDatosCodeudor(index) {
            const nombre = document.getElementById(`nombreCodeudor${index}`).value.trim();
            const tipoDoc = document.getElementById(`tipoDocCodeudor${index}`).value;
            const doc1 = document.getElementById(`docCodeudor${index}1`).value.trim();
            const doc2 = document.getElementById(`docCodeudor${index}2`).value.trim();

            if (!nombre || !tipoDoc || !doc1 || !doc2) {
                mostrarError(`Por favor complete todos los datos del Codeudor ${index}.`);
                return false;
            }

            if (doc1 !== doc2) {
                mostrarError(`Los documentos del Codeudor ${index} no coinciden.`);
                return false;
            }

            if (!archivosBase64[`docFrontalCodeudor${index}`] || !archivosBase64[`docTraseroCodeudor${index}`]) {
                mostrarError(`Por favor cargue las fotos del documento del Codeudor ${index}.`);
                return false;
            }

            return true;
        }

        // ==========================================
        // MANEJO DE ARCHIVOS
        // ==========================================
        function handleFileSelect(input, listId, key) {
            const file = input.files[0];
            if (!file) return;

            // Validar tama√±o
            const maxSize = key.includes('doc') ? CONFIG.MAX_IMAGE_SIZE : CONFIG.MAX_FILE_SIZE;
            if (file.size > maxSize) {
                mostrarError(`El archivo es demasiado grande. M√°ximo ${maxSize / 1024 / 1024}MB.`);
                input.value = '';
                return;
            }

            // Mostrar archivo seleccionado
            document.getElementById(listId).innerHTML = `
                <div class="file-item">
                    <span>üìÑ ${file.name}</span>
                    <button class="remove-file" onclick="removeFile('${key}', '${listId}', '${input.id}')">√ó</button>
                </div>
            `;

            // Marcar como cargado
            input.closest('.file-upload').classList.add('has-file');

            // Convertir a base64
            const reader = new FileReader();
            reader.onload = function(e) {
                archivosBase64[key] = e.target.result;
                console.log(`‚úÖ ${key} convertido a base64`);
            };
            reader.onerror = function(error) {
                console.error('Error leyendo archivo:', error);
                mostrarError('Error al procesar el archivo.');
            };
            reader.readAsDataURL(file);
        }

        function removeFile(key, listId, inputId) {
            delete archivosBase64[key];
            document.getElementById(listId).innerHTML = '';
            document.getElementById(inputId).value = '';
            document.getElementById(inputId).closest('.file-upload').classList.remove('has-file');
        }

        // ==========================================
        // VALIDACI√ìN DE CAMPOS DOBLES
        // ==========================================
        // Listeners para campos de validaci√≥n doble
        document.addEventListener('DOMContentLoaded', function() {
            // Documento
            const doc1 = document.getElementById('docInquilino1');
            const doc2 = document.getElementById('docInquilino2');
            if (doc1 && doc2) {
                doc1.addEventListener('input', function() {
                    doc2.disabled = !this.value;
                    if (!this.value) doc2.value = '';
                    validarCampoDoble('docInquilino1', 'docInquilino2', 'docStatus');
                });
                doc2.addEventListener('input', function() {
                    validarCampoDoble('docInquilino1', 'docInquilino2', 'docStatus');
                });
            }

            // Email
            const email1 = document.getElementById('emailInquilino1');
            const email2 = document.getElementById('emailInquilino2');
            if (email1 && email2) {
                email1.addEventListener('input', function() {
                    email2.disabled = !this.value;
                    if (!this.value) email2.value = '';
                    validarCampoDoble('emailInquilino1', 'emailInquilino2', 'emailStatus');
                });
                email2.addEventListener('input', function() {
                    validarCampoDoble('emailInquilino1', 'emailInquilino2', 'emailStatus');
                });
            }

            // Celular
            const cel1 = document.getElementById('celInquilino1');
            const cel2 = document.getElementById('celInquilino2');
            if (cel1 && cel2) {
                cel1.addEventListener('input', function() {
                    cel2.disabled = !this.value;
                    if (!this.value) cel2.value = '';
                    validarCampoDoble('celInquilino1', 'celInquilino2', 'celStatus');
                });
                cel2.addEventListener('input', function() {
                    validarCampoDoble('celInquilino1', 'celInquilino2', 'celStatus');
                });
            }
        });

        function validarCampoDoble(id1, id2, statusId) {
            const campo1 = document.getElementById(id1);
            const campo2 = document.getElementById(id2);
            const status = document.getElementById(statusId);
            
            if (!campo1 || !campo2 || !status) return;
            
            if (campo1.value && campo2.value) {
                if (campo1.value === campo2.value) {
                    status.innerHTML = '‚úÖ';
                    status.className = 'validation-status valid';
                } else {
                    status.innerHTML = '‚ùå';
                    status.className = 'validation-status invalid';
                }
            } else {
                status.innerHTML = '';
            }
        }

        // ==========================================
        // SISTEMA DE CODEUDORES
        // ==========================================
        function responderCodeudor(respuesta) {
            tieneCodeudores = respuesta;
            
            // Marcar bot√≥n seleccionado
            document.querySelectorAll('.btn-option').forEach(btn => {
                btn.classList.remove('selected');
            });
            event.target.classList.add('selected');

            if (respuesta) {
                // Crear primera secci√≥n de codeudor
                crearSeccionCodeudor(1);
                numCodeudores = 1;
            } else {
                numCodeudores = 0;
            }

            // Recalcular total de secciones
            totalSections = 4 + numCodeudores;
            
            // Avanzar autom√°ticamente
            setTimeout(() => navegarSeccion(1), 500);
        }

        function crearSeccionCodeudor(index) {
            const container = document.getElementById('codeudorSections');
            
            const html = `
                <div class="form-section" id="codeudorSection${index}">
                    <h2>üë• Datos del Codeudor ${index}</h2>
                    
                    <div class="form-grid">
                        <div class="form-group full-width">
                            <label>Nombre Completo <span class="required">*</span></label>
                            <input type="text" id="nombreCodeudor${index}" placeholder="Nombres y apellidos completos">
                        </div>
                        
                        <div class="form-group">
                            <label>Tipo de Documento <span class="required">*</span></label>
                            <select id="tipoDocCodeudor${index}">
                                <option value="">Seleccione...</option>
                                <option value="CC">C√©dula de Ciudadan√≠a</option>
                                <option value="CE">C√©dula de Extranjer√≠a</option>
                                <option value="PAS">Pasaporte</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>N√∫mero de Documento <span class="required">*</span></label>
                            <div class="validation-group">
                                <input type="text" id="docCodeudor${index}1" placeholder="Ingrese el n√∫mero">
                                <input type="text" id="docCodeudor${index}2" placeholder="Confirme el n√∫mero" disabled>
                                <span class="validation-status" id="docCodeudorStatus${index}"></span>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Correo Electr√≥nico <span class="required">*</span></label>
                            <div class="validation-group">
                                <input type="email" id="emailCodeudor${index}1" placeholder="correo@ejemplo.com">
                                <input type="email" id="emailCodeudor${index}2" placeholder="Confirme el correo" disabled>
                                <span class="validation-status" id="emailCodeudorStatus${index}"></span>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>N√∫mero de Celular <span class="required">*</span></label>
                            <div class="validation-group">
                                <input type="tel" id="celCodeudor${index}1" placeholder="3001234567">
                                <input type="tel" id="celCodeudor${index}2" placeholder="Confirme el n√∫mero" disabled>
                                <span class="validation-status" id="celCodeudorStatus${index}"></span>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Fotograf√≠as del Documento <span class="required">*</span></label>
                        <div class="form-grid">
                            <div>
                                <label class="sub-label">Frontal</label>
                                <div class="file-upload" onclick="document.getElementById('docFrontalCodeudor${index}').click()">
                                    <input type="file" id="docFrontalCodeudor${index}" accept="image/*,application/pdf" style="display: none;" 
                                           onchange="handleFileSelect(this, 'frontalCodeudor${index}List', 'docFrontalCodeudor${index}')">
                                    <div class="upload-icon">üì∑</div>
                                    <div class="upload-text">Frontal del documento</div>
                                </div>
                                <div id="frontalCodeudor${index}List" class="file-list"></div>
                            </div>
                            <div>
                                <label class="sub-label">Trasero</label>
                                <div class="file-upload" onclick="document.getElementById('docTraseroCodeudor${index}').click()">
                                    <input type="file" id="docTraseroCodeudor${index}" accept="image/*,application/pdf" style="display: none;" 
                                           onchange="handleFileSelect(this, 'traseroCodeudor${index}List', 'docTraseroCodeudor${index}')">
                                    <div class="upload-icon">üì∑</div>
                                    <div class="upload-text">Trasero del documento</div>
                                </div>
                                <div id="traseroCodeudor${index}List" class="file-list"></div>
                            </div>
                        </div>
                    </div>
                    
                    ${index < maxCodeudores ? `
                    <div class="codeudor-question">
                        <h3>¬øHay otro codeudor adicional?</h3>
                        <div class="question-buttons">
                            <button type="button" class="btn btn-option" onclick="agregarCodeudor()">S√≠</button>
                            <button type="button" class="btn btn-option" onclick="finalizarCodeudores()">No</button>
                        </div>
                    </div>
                    ` : `
                    <div class="alert alert-info">
                        <p>M√°ximo n√∫mero de codeudores alcanzado (3)</p>
                    </div>
                    `}
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', html);
            
            // Configurar validaci√≥n para los nuevos campos
            configurarValidacionCodeudor(index);
        }

        function configurarValidacionCodeudor(index) {
            // Similar a la validaci√≥n del inquilino
            const doc1 = document.getElementById(`docCodeudor${index}1`);
            const doc2 = document.getElementById(`docCodeudor${index}2`);
            
            if (doc1 && doc2) {
                doc1.addEventListener('input', function() {
                    doc2.disabled = !this.value;
                    if (!this.value) doc2.value = '';
                });
            }

            const email1 = document.getElementById(`emailCodeudor${index}1`);
            const email2 = document.getElementById(`emailCodeudor${index}2`);
            
            if (email1 && email2) {
                email1.addEventListener('input', function() {
                    email2.disabled = !this.value;
                    if (!this.value) email2.value = '';
                });
            }

            const cel1 = document.getElementById(`celCodeudor${index}1`);
            const cel2 = document.getElementById(`celCodeudor${index}2`);
            
            if (cel1 && cel2) {
                cel1.addEventListener('input', function() {
                    cel2.disabled = !this.value;
                    if (!this.value) cel2.value = '';
                });
            }
        }

        function agregarCodeudor() {
            if (numCodeudores < maxCodeudores) {
                numCodeudores++;
                crearSeccionCodeudor(numCodeudores);
                totalSections = 4 + numCodeudores;
                
                // Avanzar a la nueva secci√≥n
                setTimeout(() => navegarSeccion(1), 300);
            }
        }

        function finalizarCodeudores() {
            // Avanzar a la secci√≥n final
            currentSection = totalSections;
            mostrarSeccion();
            actualizarProgreso();
            actualizarBotones();
        }

        // ==========================================
        // RESUMEN Y ENV√çO
        // ==========================================
        function generarResumen() {
            const summary = document.getElementById('summaryContent');
            if (!summary) return;

            let html = '<h3>üìã Resumen de documentos cargados:</h3><ul>';
            
            // Archivos
            if (archivosBase64.estudioAprobado) html += '<li>‚úÖ Estudio aprobado</li>';
            if (archivosBase64.comprobantePago) html += '<li>‚úÖ Comprobante de pago</li>';
            if (archivosBase64.docFrontalInquilino) html += '<li>‚úÖ C√©dula inquilino (frontal)</li>';
            if (archivosBase64.docTraseroInquilino) html += '<li>‚úÖ C√©dula inquilino (trasera)</li>';
            
            // Codeudores
            for (let i = 1; i <= numCodeudores; i++) {
                if (archivosBase64[`docFrontalCodeudor${i}`]) {
                    html += `<li>‚úÖ C√©dula codeudor ${i}</li>`;
                }
            }
            
            html += '</ul>';
            summary.innerHTML = html;
        }

        async function enviarFormulario() {
            if (!confirm('¬øEst√° seguro de enviar todos los documentos?')) {
                return;
            }

            mostrarLoading(true);

            // Recopilar datos
            const datosFormulario = {
                codigoRegistro: codigoRegistro,
                modoFormulario: modoFormulario,
                inquilino: {
                    nombre: document.getElementById('nombreInquilino').value,
                    tipoDocumento: document.getElementById('tipoDocInquilino').value,
                    numeroDocumento: document.getElementById('docInquilino1').value,
                    email: document.getElementById('emailInquilino1').value,
                    celular: document.getElementById('celInquilino1').value
                },
                codeudores: [],
                tieneCodeudores: tieneCodeudores,
                numCodeudores: numCodeudores,
                fechaEnvio: new Date().toISOString()
            };

            // Agregar codeudores
            for (let i = 1; i <= numCodeudores; i++) {
                const nombre = document.getElementById(`nombreCodeudor${i}`).value;
                if (nombre) {
                    datosFormulario.codeudores.push({
                        nombre: nombre,
                        tipoDocumento: document.getElementById(`tipoDocCodeudor${i}`).value,
                        numeroDocumento: document.getElementById(`docCodeudor${i}1`).value,
                        email: document.getElementById(`emailCodeudor${i}1`).value,
                        celular: document.getElementById(`celCodeudor${i}1`).value
                    });
                }
            }

            try {
                const response = await fetch(CONFIG.API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        accion: 'procesarFormularioInquilino',
                        datosFormulario: datosFormulario,
                        archivosBase64: archivosBase64
                    })
                });

                const result = await response.json();

                if (result.success) {
                    mostrarExito();
                } else {
                    mostrarError(result.message || 'Error al procesar los documentos');
                }
            } catch(error) {
                console.error('Error enviando formulario:', error);
                mostrarError('Error de conexi√≥n. Por favor intente nuevamente.');
            } finally {
                mostrarLoading(false);
            }
        }

        function mostrarExito() {
            document.querySelector('.card-body').innerHTML = `
                <div class="success-page">
                    <div class="success-icon">‚úÖ</div>
                    <h2>¬°Documentos Enviados Exitosamente!</h2>
                    <p>Su documentaci√≥n ha sido recibida y ser√° validada en las pr√≥ximas 24 horas.</p>
                    <div class="alert alert-info">
                        <h3>üìß ¬øQu√© sigue?</h3>
                        <ul>
                            <li>Recibir√° un email de confirmaci√≥n</li>
                            <li>Validaremos su documentaci√≥n</li>
                            <li>Le notificaremos cuando el proceso contin√∫e</li>
                        </ul>
                    </div>
                    <p><strong>Puede cerrar esta ventana.</strong></p>
                </div>
            `;
        }

        // ==========================================
        // UTILIDADES UI
        // ==========================================
        function mostrarError(mensaje) {
            const alert = document.getElementById('alertMessage');
            alert.className = 'alert alert-danger';
            alert.textContent = mensaje;
            alert.style.display = 'block';
            
            setTimeout(() => {
                alert.style.display = 'none';
            }, 5000);
        }

        function mostrarLoading(mostrar) {
            document.getElementById('loadingOverlay').style.display = mostrar ? 'flex' : 'none';
        }

        function deshabilitarFormulario() {
            document.querySelector('.card-body').innerHTML = `
                <div class="alert alert-danger">
                    <h3>‚õî Formulario No Disponible</h3>
                    <p>${CONFIG.MESSAGES.LINK_INACTIVO}</p>
                </div>
            `;
        }

        // Log de inicializaci√≥n
        console.log('‚úÖ Formulario inquilino inicializado');
        console.log('üìä Modo:', modoFormulario);
        console.log('üîë CDR:', codigoRegistro);
    </script>
</body>
</html>
