<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-Firmacontrata - Validando acceso...</title>
    <style>
        /* Estilos basicos para el selector */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 0;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .contenedor {
            max-width: 600px;
            width: 90%;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #B8860B, #FFD700);
            color: #0F0F0F;
            padding: 25px;
            text-align: center;
        }
        
        .header h1 {
            margin: 0;
            font-size: 28px;
            font-weight: bold;
        }
        
        .header p {
            margin: 10px 0 0 0;
            opacity: 0.9;
            font-size: 14px;
        }
        
        .contenedor-validacion {
            padding: 40px 30px;
            text-align: center;
        }
        
        #mensaje {
            margin: 20px 0;
            padding: 20px;
            border-radius: 10px;
            display: none;
        }
        
        .info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #764ba2;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin: 30px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .codigo-display {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 16px;
            font-weight: bold;
            color: #764ba2;
            margin: 15px 0;
            border: 2px dashed #dee2e6;
        }
        
        .whatsapp-container {
            margin-top: 30px;
            padding-top: 30px;
            border-top: 1px solid #e0e0e0;
            display: none;
        }
        
        .whatsapp-btn {
            display: inline-block;
            background: #25D366;
            color: white;
            padding: 12px 30px;
            border-radius: 30px;
            text-decoration: none;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .whatsapp-btn:hover {
            background: #128C7E;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(37, 211, 102, 0.3);
        }
        
        .estado-info {
            background: #fff3cd;
            border: 1px solid #ffc107;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            color: #856404;
        }
        
        .debug-info {
            background: #f0f0f0;
            padding: 10px;
            border-radius: 5px;
            margin-top: 20px;
            font-size: 12px;
            text-align: left;
            display: none;
        }
    </style>
</head>
<body>
    <div class="contenedor">
        <div class="header">
            <h1>üè† E-Firmacontrata</h1>
            <p>Sistema de Gesti√≥n de Contratos de Arrendamiento</p>
        </div>
        
        <div class="contenedor-validacion">
            <div class="loader"></div>
            <p style="color: #666;">Validando acceso al formulario...</p>
            
            <div id="mensaje"></div>
            
            <div class="whatsapp-container" id="whatsappContainer">
                <p style="color: #666; margin-bottom: 15px;">
                    Si necesita ayuda o tiene alguna pregunta, cont√°ctenos:
                </p>
                <a href="https://wa.me/573177623878" target="_blank" class="whatsapp-btn">
                    üí¨ Contactar por WhatsApp
                </a>
            </div>
            
            <div class="debug-info" id="debugInfo"></div>
        </div>
    </div>
    
    <script>
        // Configuracion de la API
        const API_URL = 'https://script.google.com/macros/s/AKfycbzOnhQ8CD2gWMdvvYnF2v1FL3yto5sM8i_jV9FmIJa1Os05YwXR5RKSsq22ePlwqQgL/exec';
        const DEBUG = false; // Cambiar a true para ver informaci√≥n de depuraci√≥n
        
        // Variables globales
        let parametros = {};
        
        // Funci√≥n para mostrar mensajes
        function mostrarMensaje(mensaje, tipo) {
            const mensajeDiv = document.getElementById('mensaje');
            mensajeDiv.innerHTML = mensaje;
            mensajeDiv.className = tipo;
            mensajeDiv.style.display = 'block';
            
            // Ocultar el loader
            document.querySelector('.loader').style.display = 'none';
            document.querySelector('.contenedor-validacion p').style.display = 'none';
        }
        
        // Funci√≥n para mostrar WhatsApp
        function mostrarWhatsApp() {
            document.getElementById('whatsappContainer').style.display = 'block';
        }
        
        // Funci√≥n para obtener parametros de la URL
        function obtenerParametrosURL() {
            const params = {};
            const queryString = window.location.search.substring(1);
            const pares = queryString.split('&');
            
            for (let i = 0; i < pares.length; i++) {
                const par = pares[i].split('=');
                params[decodeURIComponent(par[0])] = decodeURIComponent(par[1] || '');
            }
            
            return params;
        }
        
        // Funci√≥n para determinar el tipo de formulario desde la accion
        function obtenerTipoFormulario(action) {
            // Soportar ambos formatos (con guion o con guion bajo)
            if (action === 'formulario_inquilino' || action === 'formulario-inquilino') return 'inquilino';
            if (action === 'formulario_propietario' || action === 'formulario-propietario') return 'propietario';
            if (action === 'correccion_inquilino' || action === 'correccion-inquilino') return 'inquilino';
            if (action === 'correccion_propietario' || action === 'correccion-propietario') return 'propietario';
            return null;
        }
        
        // Funci√≥n para verificar el codigo con la API
        function verificarCodigoConAPI(codigoRegistro, tipoFormulario) {
            console.log("=== VERIFICACI√ìN DE ACCESO ===");
            console.log("C√≥digo de registro:", codigoRegistro);
            console.log("Tipo de formulario:", tipoFormulario);
            
            // Validar parametros
            if (!codigoRegistro) {
                mostrarMensaje("Error: No se especific√≥ un c√≥digo de registro", "error");
                mostrarWhatsApp();
                return;
            }
            
            if (!tipoFormulario || (tipoFormulario !== 'inquilino' && tipoFormulario !== 'propietario')) {
                mostrarMensaje("Error: Tipo de formulario no v√°lido", "error");
                mostrarWhatsApp();
                return;
            }
            
            // Mostrar el codigo que estamos verificando
            const mensaje = document.getElementById('mensaje');
            mensaje.innerHTML = `
                <p style="margin: 0;">Verificando acceso al formulario:</p>
                <div class="codigo-display">${codigoRegistro}</div>
            `;
            mensaje.className = "info";
            mensaje.style.display = "block";
            
            // Construir URL de la API
            const url = `${API_URL}?accion=verificarLink&cdr=${encodeURIComponent(codigoRegistro)}&tipo=${encodeURIComponent(tipoFormulario)}`;
            
            console.log("URL de la API:", url);
            
            // Realizar la peticion
            fetch(url)
                .then(response => {
                    console.log("Respuesta recibida:", response);
                    return response.json();
                })
                .then(data => {
                    console.log("Datos de la respuesta:", data);
                    
                    if (DEBUG) {
                        document.getElementById('debugInfo').style.display = 'block';
                        document.getElementById('debugInfo').innerHTML = `
                            <strong>Debug Info:</strong><br>
                            Estado actual: ${data.estadoActual || 'Desconocido'}<br>
                            Activo: ${data.activo ? 'S√≠' : 'No'}<br>
                            Mensaje: ${data.mensaje}
                        `;
                    }
                    
                    if (data.success) {
                        if (data.activo) {
                            // Formulario habilitado, redirigir
                            mostrarMensaje(
                                `<strong>‚úÖ Formulario disponible</strong><br>
                                <span style="font-size: 14px;">Redirigiendo al formulario de ${tipoFormulario}...</span>`,
                                "success"
                            );
                            
                            // Determinar si es modo correcci√≥n
                            const esCorreccion = parametros.action && parametros.action.includes('correccion');
                            
                            setTimeout(() => {
                                if (tipoFormulario === 'inquilino') {
                                    let urlDestino = `formulario-inquilino.html?cdr=${encodeURIComponent(codigoRegistro)}`;
                                    if (esCorreccion) {
                                        urlDestino += '&modo=correccion';
                                    }
                                    window.location.href = urlDestino;
                                } else {
                                    let urlDestino = `formulario-propietario.html?cdr=${encodeURIComponent(codigoRegistro)}`;
                                    if (esCorreccion) {
                                        urlDestino += '&modo=correccion';
                                    }
                                    window.location.href = urlDestino;
                                }
                            }, 1500);
                        } else {
                            // Formulario no disponible - Mostrar estado actual
                            let mensajeHTML = `<strong>üîí Formulario no disponible</strong><br><br>`;
                            
                            // Mensajes espec√≠ficos seg√∫n el estado
                            if (data.estadoActual) {
                                if (data.estadoActual.includes('Documentos del inquilino recibidos')) {
                                    mensajeHTML += `
                                        <div class="estado-info">
                                            <strong>Estado actual:</strong><br>
                                            Los documentos ya fueron recibidos y est√°n en proceso de validaci√≥n.<br><br>
                                            Si necesita realizar correcciones, espere a que el equipo de validaci√≥n 
                                            le env√≠e un nuevo enlace por correo electr√≥nico.
                                        </div>
                                    `;
                                } else if (data.estadoActual.includes('Formulario del inquilino aprobado')) {
                                    mensajeHTML += `
                                        <div class="estado-info">
                                            <strong>Estado actual:</strong><br>
                                            Los documentos del inquilino ya fueron aprobados.<br><br>
                                            El proceso contin√∫a con el propietario.
                                        </div>
                                    `;
                                } else if (data.estadoActual.includes('Formulario ya completado')) {
                                    mensajeHTML += `
                                        <div class="estado-info">
                                            Este formulario ya fue completado anteriormente.<br><br>
                                            Si necesita enviar documentos adicionales o correcciones, 
                                            contacte al equipo de soporte.
                                        </div>
                                    `;
                                } else {
                                    mensajeHTML += `
                                        <div class="estado-info">
                                            <strong>Estado:</strong> ${data.estadoActual}
                                        </div>
                                    `;
                                }
                            } else {
                                mensajeHTML += `${data.mensaje || "El formulario no est√° disponible en este momento"}`;
                            }
                            
                            mostrarMensaje(mensajeHTML, "error");
                            mostrarWhatsApp();
                        }
                    } else {
                        // Error en la verificaci√≥n
                        mostrarMensaje(
                            `<strong>‚ùå Error de verificaci√≥n</strong><br>
                            ${data.mensaje || "No se pudo verificar el c√≥digo"}`,
                            "error"
                        );
                        mostrarWhatsApp();
                    }
                })
                .catch(error => {
                    console.error("Error en fetch:", error);
                    mostrarMensaje(
                        `<strong>Error de conexi√≥n</strong><br>
                        Por favor intente nuevamente m√°s tarde.<br>
                        <small>${error.message}</small>`,
                        "error"
                    );
                    mostrarWhatsApp();
                });
        }
        
        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            console.log("Selector Router iniciado");
            
            // Obtener parametros de la URL
            parametros = obtenerParametrosURL();
            console.log("Parametros URL:", parametros);
            
            // Verificar si tenemos los parametros necesarios
            if (parametros.action && parametros.cdr) {
                const tipoFormulario = obtenerTipoFormulario(parametros.action);
                
                if (tipoFormulario) {
                    // Verificar con la API
                    verificarCodigoConAPI(parametros.cdr, tipoFormulario);
                } else {
                    mostrarMensaje(
                        "<strong>Error: Tipo de formulario no reconocido</strong><br>" +
                        "Por favor verifique el enlace proporcionado.",
                        "error"
                    );
                    mostrarWhatsApp();
                }
            } else {
                mostrarMensaje(
                    "<strong>Error: Enlace incompleto</strong><br>" +
                    "El enlace que est√° utilizando no contiene toda la informaci√≥n necesaria.<br>" +
                    "Por favor use el enlace completo que recibi√≥ por correo electr√≥nico.",
                    "error"
                );
                mostrarWhatsApp();
            }
        });
    </script>
</body>
</html>
