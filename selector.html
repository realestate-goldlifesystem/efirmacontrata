<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Verificando Acceso - E-firmaContrata</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<link rel="stylesheet" href="style.css">
<style>
/* Estilos espec√≠ficos del selector (con acentos corregidos) */
body {
  display:flex;justify-content:center;align-items:center;min-height:100vh;margin:0;
  background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
  font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif;
}
.verificacion-container{background:#fff;padding:40px;border-radius:15px;box-shadow:0 20px 40px rgba(0,0,0,.1);text-align:center;max-width:520px;width:92%;}
.logo{font-size:60px;margin-bottom:20px;animation:pulse 2s infinite}
@keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.1)}100%{transform:scale(1)}}
.spinner{border:3px solid #f3f3f3;border-top:3px solid #764ba2;border-radius:50%;width:50px;height:50px;animation:spin 1s linear infinite;margin:20px auto}
@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
.status-message{margin:20px 0;padding:15px;border-radius:8px;animation:fadeIn .5s}
@keyframes fadeIn{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}
.status-message.success{background:#d4edda;color:#155724;border:1px solid #c3e6cb}
.status-message.error{background:#f8d7da;color:#721c24;border:1px solid #f5c6cb}
.status-message.warning{background:#fff3cd;color:#856404;border:1px solid #ffeeba}
.status-message.info{background:#d1ecf1;color:#0c5460;border:1px solid #bee5eb}
.progress-steps{display:flex;justify-content:center;margin:30px 0}
.step{width:30px;height:30px;border-radius:50%;background:#e0e0e0;margin:0 10px;display:flex;align-items:center;justify-content:center;font-size:12px;color:#fff;transition:.3s}
.step.active{background:#764ba2;transform:scale(1.2)}
.step.completed{background:#28a745}
.code-display{background:#f8f9fa;padding:10px;border-radius:5px;font-family:monospace;font-size:14px;color:#495057;margin:15px 0;word-break:break-all}
.btn-container{margin-top:30px}
.btn{display:inline-block;padding:12px 30px;background:#764ba2;color:#fff;text-decoration:none;border-radius:25px;transition:.3s;border:none;cursor:pointer;font-size:16px}
.btn:hover{background:#5a3d7a;transform:translateY(-2px);box-shadow:0 5px 15px rgba(118,75,162,.3)}
.debug-info{margin-top:30px;padding:15px;background:#f8f9fa;border-radius:8px;font-size:12px;color:#6c757d;display:none;text-align:left}
.debug-info.show{display:block}
</style>
</head>
<body>
<div class="verificacion-container">
  <div class="logo">üîê</div>
  <h1>Verificando Acceso</h1>
  <div class="spinner" id="spinner"></div>
  <p id="statusText">Validando su enlace de acceso...</p>
  <div class="progress-steps" id="progressSteps">
    <div class="step active" id="step1">1</div>
    <div class="step" id="step2">2</div>
    <div class="step" id="step3">3</div>
  </div>
  <div id="messageContainer"></div>
  <div id="codeContainer"></div>
  <div id="buttonContainer" class="btn-container" style="display:none;"></div>
  <div id="debugInfo" class="debug-info">
    <h4>üîß Informaci√≥n de Debug</h4>
    <pre id="debugContent"></pre>
  </div>
</div>
<script src="config.js"></script>
<script>
let parametros={action:'',cdr:'',modo:'normal',docs:[]};
async function verificarAcceso(){
  console.log('[Selector] Iniciando verificaci√≥n');
  actualizarPaso(1,'Leyendo par√°metros...');
  obtenerParametros();
  if(CONFIG.DEBUG) mostrarDebug();
  if(!parametros.cdr||!parametros.action){
    mostrarError('Enlace no v√°lido','Faltan par√°metros requeridos');
    return;
  }
  actualizarPaso(2,'Verificando con el servidor...');
  await verificarEstadoLink();
}
function obtenerParametros(){
  const urlParams=new URLSearchParams(window.location.search);
  parametros.action=urlParams.get('action')||'';
  parametros.cdr=urlParams.get('cdr')||'';
  parametros.modo=urlParams.get('modo')||'normal';
  const docsParam=urlParams.get('docs');
  if(docsParam){try{parametros.docs=JSON.parse(decodeURIComponent(docsParam));}catch(e){parametros.docs=[];}}
  console.log('[Selector] Par√°metros:',parametros);
}
async function verificarEstadoLink(){
  const tipo=parametros.action.includes('inquilino')?'inquilino':'propietario';
  const CODIGOS_PRUEBA=['TEST001','TEST002','TEST003','DEMO'];
  if(CODIGOS_PRUEBA.includes(parametros.cdr)){
    console.log('[Selector] C√≥digo de prueba: acceso autom√°tico');
    linkActivo();return;
  }
  try{
    const url=`${CONFIG.API_URL}?accion=verificarLink&cdr=${encodeURIComponent(parametros.cdr)}&tipo=${tipo}`;
    const response=await fetch(url,{method:'GET',mode:'cors'});
    if(response.ok){
      const data=await response.json();
      if(data.success&&data.activo) linkActivo(); else linkInactivo();
    }else{
      console.warn('[Selector] HTTP no OK, asumiendo activo');
      linkActivo();
    }
  }catch(e){
    console.error('[Selector] Error verificaci√≥n:',e);
    linkActivo();
  }
}
function linkActivo(){
  actualizarPaso(3,'¬°Acceso verificado!');
  document.getElementById('spinner').style.display='none';
  document.getElementById('statusText').innerHTML='‚úÖ Enlace v√°lido y activo';
  document.getElementById('messageContainer').innerHTML=`
    <div class="status-message success">
      <h2>Acceso Autorizado</h2>
      <p>Ser√° redirigido al formulario...</p>
    </div>`;
  document.getElementById('codeContainer').innerHTML=`
    <div class="code-display"><strong>C√≥digo de Registro:</strong> ${parametros.cdr}</div>`;
  setTimeout(()=>redirigirAFormulario(),1500);
}
function linkInactivo(){
  actualizarPaso(3,'Enlace ya utilizado');
  document.getElementById('spinner').style.display='none';
  document.getElementById('statusText').innerHTML='üîí Enlace inactivo';
  document.getElementById('messageContainer').innerHTML=`
    <div class="status-message warning">
      <h2>Enlace Ya Utilizado</h2>
      <p>Este enlace ya fue usado anteriormente.</p>
    </div>`;
  document.getElementById('codeContainer').innerHTML=`
    <div class="code-display"><strong>C√≥digo de Registro:</strong> ${parametros.cdr}</div>`;
  setTimeout(()=>{window.location.href=`pagina-exito.html?estado=usado&cdr=${encodeURIComponent(parametros.cdr)}`;},2500);
}
function redirigirAFormulario(){
  let url='';
  if(parametros.action==='formulario_inquilino'){
    url=`formulario-inquilino.html?cdr=${encodeURIComponent(parametros.cdr)}`;
    if(parametros.modo==='correccion'&&parametros.docs.length>0){
      url+=`&modo=correccion&docs=${encodeURIComponent(JSON.stringify(parametros.docs))}`;
    }
  }else if(parametros.action==='formulario_propietario'){
    url=`formulario-propietario.html?cdr=${encodeURIComponent(parametros.cdr)}`;
    if(parametros.modo==='correccion'&&parametros.docs.length>0){
      url+=`&modo=correccion&docs=${encodeURIComponent(JSON.stringify(parametros.docs))}`;
    }
  }
  if(url){console.log('[Selector] Redirigiendo a:',url);window.location.href=url;}
  else mostrarError('Error','No se pudo determinar el destino');
}
function actualizarPaso(paso,mensaje){
  document.getElementById('statusText').textContent=mensaje;
  for(let i=1;i<=3;i++){
    const el=document.getElementById(`step${i}`);
    if(i<paso){el.classList.remove('active');el.classList.add('completed');el.textContent='‚úì';}
    else if(i===paso){el.classList.add('active');}
    else el.classList.remove('active','completed');
  }
}
function mostrarError(titulo,mensaje){
  document.getElementById('spinner').style.display='none';
  document.getElementById('progressSteps').style.display='none';
  document.getElementById('messageContainer').innerHTML=`
    <div class="status-message error">
      <h2>${titulo}</h2>
      <p>${mensaje}</p>
    </div>`;
  document.getElementById('buttonContainer').style.display='block';
  document.getElementById('buttonContainer').innerHTML=`
    <a href="index.html" class="btn">Volver</a>`;
}
function mostrarDebug(){
  if(!CONFIG.DEBUG)return;
  const debugInfo=document.getElementById('debugInfo');
  debugInfo.classList.add('show');
  document.getElementById('debugContent').textContent=
`URL: ${window.location.href}
Action: ${parametros.action}
CDR: ${parametros.cdr}
Modo: ${parametros.modo}
Docs: ${JSON.stringify(parametros.docs)}
API URL: ${CONFIG.API_URL}
Timestamp: ${new Date().toISOString()}
UserAgent: ${navigator.userAgent}`;
}
window.onload=verificarAcceso;
</script>
</body>
</html>
