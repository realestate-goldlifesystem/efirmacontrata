<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>E-FirmaContrata • Selector de acceso</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Branding global -->
  <link rel="stylesheet" href="theme.css" />

  <!-- Estilos mínimos específicos -->
  <style>
    .wrap{
      min-height:100vh; display:flex; align-items:center; justify-content:center; padding:20px;
      background: radial-gradient(1200px 600px at 50% -20%, rgba(255,215,0,.08), transparent 60%), var(--black-primary);
    }
    .selector{ width:min(760px,95vw) }
    .row{ display:grid; grid-template-columns: 1fr auto; gap:12px }
    @media (max-width: 640px){ .row{ grid-template-columns: 1fr } }
    .hint{ font-size: var(--fs-small); color: var(--gray-400) }
    .hr{ height:1px; background:rgba(255,215,0,.18); margin:18px 0 }
    .skeleton{
      height:12px; background:linear-gradient(90deg,#2a2a2a,#343434,#2a2a2a); background-size:200% 100%;
      animation: sk 1.2s linear infinite;
    }
    @keyframes sk{ to{ background-position: -200% 0 } }
  </style>
</head>
<body>
  <main class="wrap">
    <section class="card selector">
      <header class="card-header">
        <div class="badge">E-FirmaContrata</div>
        <h1>Validación de enlace / CDR</h1>
      </header>

      <div class="card-body">
        <div class="alert alert-info" id="msgInfo" style="display:none">
          Procesando tu enlace. Por favor espera…
        </div>

        <div id="formBlock">
          <p class="muted" style="margin-top:0">
            Pega tu <strong>CDR</strong> (código de registro) o abre este selector desde el enlace que recibiste.
          </p>

          <label for="cdr">Código de registro (CDR) <span class="required">*</span></label>
          <div class="row">
            <input id="cdr" class="input" type="text" placeholder="Ej: V-000123 o A-000456" />
            <button id="btnValidar" class="btn btn-primary">Validar</button>
          </div>
          <p class="hint">También detectamos automáticamente el CDR si viene en la URL (?cdr=...)</p>

          <div class="hr"></div>

          <div class="grid grid-2">
            <div class="banner">
              <strong>¿Modo corrección?</strong><br/>
              Si tu enlace es de corrección, cargaremos los documentos solicitados.
            </div>
            <div class="banner success">
              <strong>Consejo:</strong><br/>
              Ten a mano tus PDFs/imagenes (máx. 10MB) para agilizar el proceso.
            </div>
          </div>
        </div>

        <div id="loadingBlock" style="display:none">
          <div class="loader" aria-label="Cargando"></div>
          <p class="muted" style="margin-top:10px">Validando con el servidor…</p>
          <div class="skeleton" style="margin-top:8px"></div>
        </div>

        <div id="resultBlock" style="display:none">
          <div id="resultAlert" class="alert"></div>
          <div class="actions" style="display:flex;gap:12px;flex-wrap:wrap">
            <a id="btnContinuar" href="#" class="btn btn-primary btn-pill" style="display:none">Ir al formulario</a>
            <a href="index.html" class="btn btn-secondary btn-pill">Volver al inicio</a>
            <a href="pagina-exito.html?status=error&msg=CDR%20inv%C3%A1lido" class="btn btn-ghost btn-pill">Reportar</a>
          </div>
        </div>

      </div>
    </section>
  </main>

  <!-- Config global -->
  <script src="config.js"></script>

  <script>
    (function(){
      const el = {
        cdr: document.getElementById('cdr'),
        btn: document.getElementById('btnValidar'),
        msgInfo: document.getElementById('msgInfo'),
        formBlock: document.getElementById('formBlock'),
        loading: document.getElementById('loadingBlock'),
        result: document.getElementById('resultBlock'),
        resultAlert: document.getElementById('resultAlert'),
        btnContinuar: document.getElementById('btnContinuar'),
      };

      // Si viene por enlace, leer parámetros
      const qs = new URLSearchParams(location.search);
      const cdrFromUrl = qs.get('cdr') || '';
      const modo = qs.get('modo') || ''; // 'correccion' si aplica
      const docs = qs.get('docs') || ''; // lista codificada si aplica
      const demo = qs.get('demo') === '1';

      if (cdrFromUrl) {
        el.cdr.value = cdrFromUrl;
        el.msgInfo.style.display = 'block';
        validar();
      }

      if (demo) {
        el.cdr.value = 'V-000123';
      }

      el.btn.addEventListener('click', validar);
      el.cdr.addEventListener('keydown', e => (e.key === 'Enter') && validar());

      function validar(){
        const cdr = (el.cdr.value || '').trim();
        if (!cdr) {
          renderError('Por favor ingresa un CDR válido.');
          return;
        }

        toggleLoading(true);

        const url = new URL(CONFIG.API_URL);
        url.searchParams.set('accion', 'verificarLink');
        url.searchParams.set('cdr', cdr);
        if (modo) url.searchParams.set('modo', modo);
        if (docs) url.searchParams.set('docs', docs);

        fetch(url.toString(), { method:'GET' })
          .then(r => r.json())
          .then(data => {
            // Estructura esperada:
            // { ok:true, tipo:'inquilino'|'propietario', modo:'correccion'|null, docs:[...], redirectParams:{}, usado:false }
            if (!data || data.ok !== true) {
              throw new Error(data && data.message ? data.message : 'Respuesta inválida del servidor');
            }

            // Construir URL de destino
            const tipo = (data.tipo || '').toLowerCase();
            let dest = tipo === 'propietario' ? 'formulario-propietario.html' : 'formulario-inquilino.html';
            const params = new URLSearchParams();
            params.set('cdr', cdr);

            // Modo corrección
            const isCorreccion = (data.modo === 'correccion') || (modo === 'correccion');
            if (isCorreccion) {
              params.set('modo', 'correccion');
              if (data.docs && Array.isArray(data.docs) && data.docs.length) {
                params.set('docs', encodeURIComponent(JSON.stringify(data.docs)));
              } else if (docs) {
                params.set('docs', docs);
              }
            }

            const finalUrl = `${dest}?${params.toString()}`;

            // Si ya está usado
            if (data.usado === true) {
              renderWarning('Este enlace ya fue utilizado. Si necesitas cargar correcciones, solicita un nuevo enlace.');
              el.btnContinuar.style.display = 'none';
              return;
            }

            // OK → permitir continuar
            renderSuccess(`Encontramos tu registro como <b>${tipo || 'inquilino'}</b>.`);
            el.btnContinuar.href = finalUrl;
            el.btnContinuar.style.display = 'inline-flex';
          })
          .catch(err => {
            console.error('[selector] Error:', err);
            renderError(err.message || 'No fue posible validar tu CDR.');
          })
          .finally(() => toggleLoading(false));
      }

      function toggleLoading(isLoading){
        el.formBlock.style.display = isLoading ? 'none' : 'block';
        el.loading.style.display = isLoading ? 'block' : 'none';
        el.result.style.display = isLoading ? 'none' : 'block';
      }

      function renderSuccess(text){
        el.resultAlert.className = 'alert alert-success';
        el.resultAlert.innerHTML = text;
      }
      function renderWarning(text){
        el.resultAlert.className = 'alert alert-warning';
        el.resultAlert.innerHTML = text;
      }
      function renderError(text){
        el.resultAlert.className = 'alert alert-danger';
        el.resultAlert.innerHTML = text;
        el.btnContinuar.style.display = 'none';
      }
    })();
  </script>
</body>
</html>
