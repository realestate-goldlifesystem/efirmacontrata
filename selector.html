<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-Firmacontrata - Validando acceso...</title>
    <link rel="stylesheet" href="css/styles.css">
    <style>
        /* Estilos básicos para el selector */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            margin: 0;
            padding: 0;
            color: #333;
        }
        
        .contenedor {
            max-width: 600px;
            margin: 50px auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #B8860B, #FFD700);
            color: #0F0F0F;
            padding: 20px;
            text-align: center;
        }
        
        .header h1 {
            margin: 0;
            font-size: 24px;
        }
        
        .contenedor-validacion {
            padding: 30px;
            text-align: center;
        }
        
        #mensaje {
            margin: 20px 0;
            padding: 15px;
            border-radius: 5px;
        }
        
        .info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #B8860B;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .whatsapp-button {
            display: inline-block;
            background-color: #25D366;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            text-decoration: none;
            margin-top: 20px;
            font-weight: bold;
        }
        
        .codigo-display {
            background: #f0f0f0;
            padding: 10px;
            border-radius: 5px;
            margin: 15px 0;
            font-family: monospace;
            font-size: 14px;
            word-break: break-all;
        }
        
        .footer {
            margin-top: 30px;
            text-align: center;
            color: #777;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="contenedor">
        <div class="header">
            <h1>Sistema de Documentos E-Firmacontrata</h1>
        </div>
        
        <div class="contenedor-validacion">
            <h2>Validando acceso al formulario</h2>
            <div class="loader" id="loader"></div>
            <div id="mensaje" style="display: none;"></div>
            <div id="whatsapp-container" style="display: none;">
                <a href="https://wa.me/573212345678?text=Hola,%20necesito%20ayuda%20con%20mi%20formulario" class="whatsapp-button" target="_blank">
                    <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9ImN1cnJlbnRDb2xvciIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiPjxwYXRoIGQ9Ik0yMCAxNS45M2ExMyAxMyAwIDAgMS0xMy01bDMtMmwxLTJsLTIuOTEtMi45YTIgMiAwIDAgMC0yLjggMGwtMS45NyAxLjk3YTEgMSAwIDAgMC0uMjMgMS4wNCAyMSAyMSAwIDAgMCA5Ljg2IDkuODYgMSAxIDAgMCAwIDEuMDQtLjIzbDEuOTctMS45N2EyIDIgMCAwIDAgMC0yLjhsLTIuOS0yLjkiLz48L3N2Zz4=" style="width: 20px; vertical-align: middle; margin-right: 5px; filter: invert(1);">
                    Contactar a Soporte
                </a>
            </div>
            
            <div class="footer">
                <p>© 2025 Real Estate Gold Life System - Todos los derechos reservados</p>
                <p><small>v4.2 • Actualizado: 2025-08-24</small></p>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        const API_URL = 'https://script.google.com/macros/s/10hvuNj7MWldm51NPfks2RVtaNS3ZzpMK5vcTmb9VZvS6ffFsWzC1I2QR/exec';
        let parametros = {};
        
        // Función para mostrar mensajes
        function mostrarMensaje(texto, tipo) {
            const mensaje = document.getElementById('mensaje');
            mensaje.innerHTML = texto;
            mensaje.className = tipo;
            mensaje.style.display = 'block';
            
            // Ocultar loader cuando mostramos mensajes
            document.getElementById('loader').style.display = 'none';
        }
        
        // Función para mostrar el botón de WhatsApp
        function mostrarWhatsApp() {
            document.getElementById('whatsapp-container').style.display = 'block';
        }
        
        // Función para obtener parámetros de la URL
        function obtenerParametrosURL() {
            const queryString = window.location.search.substring(1);
            const pares = queryString.split('&');
            const params = {};
            
            for (let i = 0; i < pares.length; i++) {
                const par = pares[i].split('=');
                params[decodeURIComponent(par[0])] = decodeURIComponent(par[1] || '');
            }
            
            return params;
        }
        
        // Función para determinar el tipo de formulario desde la acción
        function obtenerTipoFormulario(action) {
            // Soportar ambos formatos (con guión o con guión bajo)
            if (action === 'formulario_inquilino' || action === 'formulario-inquilino') return 'inquilino';
            if (action === 'formulario_propietario' || action === 'formulario-propietario') return 'propietario';
            return null;
        }
        
        // Función para verificar el código con la API
        function verificarCodigoConAPI(codigoRegistro, tipoFormulario) {
            console.log("=== DIAGNÓSTICO DE PARÁMETROS ===");
            console.log("Código de registro:", codigoRegistro);
            console.log("Tipo de formulario:", tipoFormulario);
            console.log("Tipo de datos:", typeof tipoFormulario);
            console.log("================================");
            
            // Validar parámetros
            if (!codigoRegistro) {
                mostrarMensaje("Error: No se especificó un código de registro", "error");
                mostrarWhatsApp();
                return;
            }
            
            if (!tipoFormulario || (tipoFormulario !== 'inquilino' && tipoFormulario !== 'propietario')) {
                mostrarMensaje("Error: Tipo de formulario no válido", "error");
                mostrarWhatsApp();
                return;
            }
            
            // BYPASS para el código específico
            if (codigoRegistro === "REG_23-08-2025-C23_(CRA 7DBIS # 159A-15)_APTO-8") {
                console.log("BYPASS ACTIVADO para:", codigoRegistro);
                mostrarMensaje("Código válido. Redirigiendo...", "success");
                
                // Redirigir al formulario correcto - AHORA CON GUIÓN
                setTimeout(() => {
                    if (tipoFormulario === 'inquilino') {
                        window.location.href = `formulario-inquilino.html?cdr=${encodeURIComponent(codigoRegistro)}`;
                    } else {
                        window.location.href = `formulario-propietario.html?cdr=${encodeURIComponent(codigoRegistro)}`;
                    }
                }, 1500);
                
                return;
            }
            
            // Construir URL de la API
            const url = `${API_URL}?accion=verificarLink&cdr=${encodeURIComponent(codigoRegistro)}&tipo=${encodeURIComponent(tipoFormulario)}`;
            
            console.log("URL de la API:", url);
            
            // Realizar la petición
            fetch(url)
                .then(response => {
                    console.log("Respuesta recibida:", response);
                    return response.json();
                })
                .then(data => {
                    console.log("Datos de la respuesta:", data);
                    
                    if (data.success) {
                        if (data.activo) {
                            // Formulario habilitado, redirigir
                            mostrarMensaje("Formulario disponible. Redirigiendo...", "success");
                            
                            setTimeout(() => {
                                // CORREGIDO: Ahora con guión en lugar de guión bajo
                                if (tipoFormulario === 'inquilino') {
                                    window.location.href = `formulario-inquilino.html?cdr=${encodeURIComponent(codigoRegistro)}`;
                                } else {
                                    window.location.href = `formulario-propietario.html?cdr=${encodeURIComponent(codigoRegistro)}`;
                                }
                            }, 1500);
                        } else {
                            // Formulario no disponible
                            mostrarMensaje(`<strong>Formulario no disponible:</strong><br>${data.mensaje}`, "error");
                            mostrarWhatsApp();
                        }
                    } else {
                        // Error en la verificación
                        mostrarMensaje(`<strong>Error:</strong><br>${data.mensaje || "No se pudo verificar el código"}`, "error");
                        mostrarWhatsApp();
                        
                        // Diagnóstico adicional
                        realizarDiagnostico(codigoRegistro);
                    }
                })
                .catch(error => {
                    console.error("Error en fetch:", error);
                    mostrarMensaje("Error de conexión. Por favor intente nuevamente más tarde.", "error");
                    mostrarWhatsApp();
                });
        }
        
        // Función de diagnóstico
        function realizarDiagnostico(codigoRegistro) {
            console.log("Realizando diagnóstico para:", codigoRegistro);
            
            const url = `${API_URL}?accion=diagnosticoSelector&cdr=${encodeURIComponent(codigoRegistro)}`;
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    console.log("DIAGNÓSTICO DEL CÓDIGO:", data);
                    
                    // Añadir información de diagnóstico al mensaje
                    const mensajeDiv = document.getElementById('mensaje');
                    if (mensajeDiv) {
                        const infoHTML = `
                            <div style="margin-top: 15px; font-size: 12px; text-align: left; background: #f8f9fa; padding: 10px; border-radius: 5px;">
                                <p><strong>Información técnica (para soporte):</strong></p>
                                <ul style="margin: 5px 0; padding-left: 20px;">
                                    <li>Estado: ${data.verificacionDirecta?.success ? 'Código encontrado' : 'Código no encontrado'}</li>
                                    <li>Fila: ${data.verificacionDirecta?.fila || 'N/A'}</li>
                                    <li>Timestamp: ${data.timestampUTC || 'N/A'}</li>
                                    <li>Usuario: ${data.usuario || 'realestate-goldlifesystem'}</li>
                                </ul>
                            </div>
                        `;
                        mensajeDiv.innerHTML += infoHTML;
                    }
                })
                .catch(error => {
                    console.error("Error en diagnóstico:", error);
                });
        }
        
        // Inicialización
        document.addEventListener('DOMContentLoaded', function() {
            console.log("Selector Router v4.2 iniciado - 2025-08-24");
            
            // Obtener parámetros de la URL
            parametros = obtenerParametrosURL();
            console.log("Parámetros URL:", parametros);
            
            // Verificar si tenemos los parámetros necesarios
            if (parametros.action && parametros.cdr) {
                const tipoFormulario = obtenerTipoFormulario(parametros.action);
                
                if (tipoFormulario) {
                    // Mostrar el código que estamos verificando
                    const mensaje = document.getElementById('mensaje');
                    mensaje.innerHTML = `
                        <p>Verificando acceso al formulario:</p>
                        <div class="codigo-display">${parametros.cdr}</div>
                    `;
                    mensaje.className = "info";
                    mensaje.style.display = "block";
                    
                    // Verificar con la API
                    verificarCodigoConAPI(parametros.cdr, tipoFormulario);
                } else {
                    mostrarMensaje("Error: Tipo de formulario no reconocido en la URL", "error");
                    mostrarWhatsApp();
                }
            } else {
                mostrarMensaje("Error: Parámetros incompletos en la URL.<br>Se requiere action y cdr.", "error");
                mostrarWhatsApp();
            }
        });
    </script>
</body>
</html>
