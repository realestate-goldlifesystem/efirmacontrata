<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulario Codeudores - E-firmaContrata</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="styles/responsive.css">
    <link rel="stylesheet" href="styles/forms.css">
    <link rel="stylesheet" href="styles/components.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">üè†</div>
            <h1>Formulario de Codeudores</h1>
            <p>Complete la informaci√≥n de los codeudores requeridos</p>
        </div>

        <div class="content">
            <!-- Progress Bar -->
            <div class="progress-container" id="progressContainer">
                <div class="progress-bar" id="progressBar">
                    <!-- Se genera din√°micamente -->
                </div>
            </div>

            <!-- Alert de informaci√≥n -->
            <div class="alert alert-info">
                <div class="alert-icon">‚ÑπÔ∏è</div>
                <div class="alert-content">
                    <div class="alert-title">Informaci√≥n Important</div>
                    <div class="alert-message">
                        Puede registrar hasta 3 codeudores. Cada codeudor debe proporcionar 
                        toda la informaci√≥n solicitada y documentos de identidad.
                    </div>
                </div>
            </div>

            <!-- Formulario -->
            <div class="form-content" id="formContent">
                
                <!-- Paso 1: Selecci√≥n de N√∫mero de Codeudores -->
                <div class="form-section" data-step="selection" id="selectionStep">
                    <h3>üìä N√∫mero de Codeudores</h3>
                    
                    <div class="form-field show">
                        <label>¬øCu√°ntos codeudores desea registrar?</label>
                        <div class="decision-buttons">
                            <button type="button" class="decision-btn" onclick="setNumCodeudores(1)">
                                1 Codeudor
                            </button>
                            <button type="button" class="decision-btn" onclick="setNumCodeudores(2)">
                                2 Codeudores
                            </button>
                            <button type="button" class="decision-btn" onclick="setNumCodeudores(3)">
                                3 Codeudores
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Pasos de Codeudores (se generan din√°micamente) -->
                <div id="codeudorSteps">
                    <!-- Los pasos de codeudores se insertar√°n aqu√≠ -->
                </div>

                <!-- Paso Final: Resumen -->
                <div class="form-section" data-step="summary" id="summaryStep" style="display: none;">
                    <h3>üìã Resumen de Codeudores</h3>
                    
                    <div id="summaryContent">
                        <!-- El resumen se genera din√°micamente -->
                    </div>

                    <div class="form-field">
                        <div class="checkbox-wrapper">
                            <input type="checkbox" id="confirmData" required>
                            <label for="confirmData">
                                Confirmo que toda la informaci√≥n proporcionada es correcta y 
                                los documentos cargados son legibles y actuales.
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Navegaci√≥n -->
            <div class="form-navigation" id="formNavigation">
                <button type="button" class="btn btn-secondary" id="btnPrev" onclick="previousStep()" style="display: none;">
                    ‚Üê Anterior
                </button>
                <button type="button" class="btn btn-primary" id="btnNext" onclick="nextStep()">
                    Siguiente ‚Üí
                </button>
                <button type="button" class="btn btn-success" id="btnSubmit" onclick="submitForm()" style="display: none;">
                    ‚úì Enviar Formulario
                </button>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
        <h3>Procesando informaci√≥n...</h3>
        <p id="loadingMsg">Por favor espere</p>
    </div>

    <!-- Debug Banner -->
    <div id="debugBanner" class="debug-banner" style="display:none;">DEBUG ACTIVO</div>

    <!-- Scripts -->
    <script src="config.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/validations.js"></script>
    <script src="js/api.js"></script>

    <script>
        // ==========================================
        // ESTADO DEL FORMULARIO CODEUDORES
        // ==========================================
        const formState = {
            currentStep: 0,
            totalSteps: 2, // selection + summary
            numCodeudores: 0,
            codigoRegistro: '',
            codeudores: {},
            archivosBase64: {},
            steps: ['selection', 'summary']
        };

        // ==========================================
        // INICIALIZACI√ìN
        // ==========================================
        window.onload = function() {
            initializeForm();
            if (CONFIG.DEBUG) {
                document.getElementById('debugBanner').style.display = 'block';
                document.body.classList.add('debug');
            }
        };

        function initializeForm() {
            const urlParams = new URLSearchParams(window.location.search);
            formState.codigoRegistro = urlParams.get('cdr') || '';
            
            if (!formState.codigoRegistro) {
                mostrarMensaje('C√≥digo de registro no v√°lido', 'error');
                setTimeout(() => window.location.href = 'selector.html', 2500);
                return;
            }

            updateProgressBar();
            updateNavigation();
            mostrarMensaje(`C√≥digo de registro: ${formState.codigoRegistro}`, 'success');
        }

        // ==========================================
        // GESTI√ìN DE PASOS
        // ==========================================
        function setNumCodeudores(num) {
            formState.numCodeudores = num;
            
            // Marcar bot√≥n seleccionado
            document.querySelectorAll('.decision-btn').forEach(btn => btn.classList.remove('selected'));
            event.target.classList.add('selected');
            
            // Generar pasos de codeudores
            generateCodeudorSteps();
            
            // Actualizar navegaci√≥n
            formState.totalSteps = 2 + num; // selection + codeudores + summary
            formState.steps = ['selection'];
            for (let i = 1; i <= num; i++) {
                formState.steps.push(`codeudor-${i}`);
            }
            formState.steps.push('summary');
            
            updateProgressBar();
            updateNavigation();
        }

        function generateCodeudorSteps() {
            const container = document.getElementById('codeudorSteps');
            container.innerHTML = '';

            for (let i = 1; i <= formState.numCodeudores; i++) {
                const stepHtml = createCodeudorStepHTML(i);
                container.insertAdjacentHTML('beforeend', stepHtml);
            }
        }

        function createCodeudorStepHTML(num) {
            return `
                <div class="form-section" data-step="codeudor-${num}" id="codeudor${num}Step" style="display: none;">
                    <h3>üë§ Codeudor ${num}</h3>
                    
                    <!-- Informaci√≥n Personal -->
                    <div class="form-field show">
                        <div class="form-row">
                            <div>
                                <label>Tipo de Documento <span class="required">*</span></label>
                                <select id="tipoDoc${num}" required>
                                    <option value="">Seleccione...</option>
                                    <option value="CC">C√©dula de Ciudadan√≠a</option>
                                    <option value="CE">C√©dula de Extranjer√≠a</option>
                                    <option value="PA">Pasaporte</option>
                                </select>
                            </div>
                            <div>
                                <label>N√∫mero de Documento <span class="required">*</span></label>
                                <input type="text" id="numeroDoc${num}" placeholder="N√∫mero de documento" required>
                            </div>
                        </div>
                    </div>

                    <div class="form-field show">
                        <div class="form-row">
                            <div>
                                <label>Confirmar N√∫mero <span class="required">*</span></label>
                                <input type="text" id="confirmNumeroDoc${num}" placeholder="Confirmar n√∫mero" 
                                       onblur="validarCoincidencia('numeroDoc${num}', 'confirmNumeroDoc${num}')" required>
                                <div class="validation-message" id="confirmNumeroDoc${num}Error"></div>
                            </div>
                            <div>
                                <label>Fecha de Expedici√≥n</label>
                                <input type="date" id="fechaExpedicion${num}">
                            </div>
                        </div>
                    </div>

                    <div class="form-field show">
                        <div class="form-row">
                            <div>
                                <label>Nombres <span class="required">*</span></label>
                                <input type="text" id="nombres${num}" placeholder="Nombres completos" data-type="name" required>
                            </div>
                            <div>
                                <label>Apellidos <span class="required">*</span></label>
                                <input type="text" id="apellidos${num}" placeholder="Apellidos completos" data-type="name" required>
                            </div>
                        </div>
                    </div>

                    <div class="form-field show">
                        <div class="form-row">
                            <div>
                                <label>Email <span class="required">*</span></label>
                                <input type="email" id="email${num}" placeholder="correo@ejemplo.com" 
                                       onblur="validarEmail(this)" required>
                            </div>
                            <div>
                                <label>Confirmar Email <span class="required">*</span></label>
                                <input type="email" id="confirmEmail${num}" placeholder="Confirmar email" 
                                       onblur="validarCoincidencia('email${num}', 'confirmEmail${num}')" required>
                                <div class="validation-message" id="confirmEmail${num}Error"></div>
                            </div>
                        </div>
                    </div>

                    <div class="form-field show">
                        <div class="form-row">
                            <div>
                                <label>Celular <span class="required">*</span></label>
                                <input type="tel" id="celular${num}" placeholder="3001234567" 
                                       onblur="validarTelefono(this)" required>
                            </div>
                            <div>
                                <label>Confirmar Celular <span class="required">*</span></label>
                                <input type="tel" id="confirmCelular${num}" placeholder="Confirmar celular" 
                                       onblur="validarCoincidencia('celular${num}', 'confirmCelular${num}')" required>
                                <div class="validation-message" id="confirmCelular${num}Error"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Documentos -->
                    <div class="form-field show">
                        <h4 style="color: var(--gold-primary); margin-bottom: 15px;">
                            ¬øEl documento de identidad est√° en un solo archivo?
                        </h4>
                        <div class="decision-buttons">
                            <button type="button" class="decision-btn" onclick="setDocumentType(${num}, true)">
                                S√ç - Un archivo
                            </button>
                            <button type="button" class="decision-btn" onclick="setDocumentType(${num}, false)">
                                NO - Frente y reverso
                            </button>
                        </div>
                    </div>

                    <!-- Archivo √∫nico -->
                    <div class="form-field show" id="singleDoc${num}" style="display: none;">
                        <label>Documento de Identidad (Ambas caras) <span class="required">*</span></label>
                        <div class="file-upload-wrapper">
                            <label class="file-upload-label" for="docCompleto${num}" id="labelDocCompleto${num}">
                                Seleccionar archivo
                            </label>
                            <input type="file" id="docCompleto${num}" class="file-upload-input" 
                                   accept="image/*,.pdf" onchange="handleDocumentUpload(this, ${num}, 'completo')">
                        </div>
                        <div class="file-size-info">M√°ximo 10MB - JPG, PNG, PDF</div>
                    </div>

                    <!-- Archivos separados -->
                    <div class="form-field show" id="doubleDoc${num}" style="display: none;">
                        <div style="margin-bottom: 15px;">
                            <label>Cara frontal del documento <span class="required">*</span></label>
                            <div class="file-upload-wrapper">
                                <label class="file-upload-label" for="docFrente${num}" id="labelDocFrente${num}">
                                    Seleccionar frente
                                </label>
                                <input type="file" id="docFrente${num}" class="file-upload-input" 
                                       accept="image/*,.pdf" onchange="handleDocumentUpload(this, ${num}, 'frente')">
                            </div>
                        </div>
                        <div>
                            <label>Cara posterior del documento <span class="required">*</span></label>
                            <div class="file-upload-wrapper">
                                <label class="file-upload-label" for="docReverso${num}" id="labelDocReverso${num}">
                                    Seleccionar reverso
                                </label>
                                <input type="file" id="docReverso${num}" class="file-upload-input" 
                                       accept="image/*,.pdf" onchange="handleDocumentUpload(this, ${num}, 'reverso')">
                            </div>
                        </div>
                        <div class="file-size-info">M√°ximo 10MB cada uno - JPG, PNG, PDF</div>
                    </div>
                </div>
            `;
        }

        // ==========================================
        // NAVEGACI√ìN
        // ==========================================
        function nextStep() {
            if (!validateCurrentStep()) return;
            
            if (formState.currentStep < formState.totalSteps - 1) {
                hideCurrentStep();
                formState.currentStep++;
                showCurrentStep();
                updateNavigation();
                updateProgressBar();
            }
        }

        function previousStep() {
            if (formState.currentStep > 0) {
                hideCurrentStep();
                formState.currentStep--;
                showCurrentStep();
                updateNavigation();
                updateProgressBar();
            }
        }

        function hideCurrentStep() {
            const currentStepName = formState.steps[formState.currentStep];
            const stepElement = document.querySelector(`[data-step="${currentStepName}"]`);
            if (stepElement) {
                stepElement.style.display = 'none';
            }
        }

        function showCurrentStep() {
            const currentStepName = formState.steps[formState.currentStep];
            const stepElement = document.querySelector(`[data-step="${currentStepName}"]`);
            if (stepElement) {
                stepElement.style.display = 'block';
                if (currentStepName === 'summary') {
                    generateSummary();
                }
            }
        }

        function updateNavigation() {
            const btnPrev = document.getElementById('btnPrev');
            const btnNext = document.getElementById('btnNext');
            const btnSubmit = document.getElementById('btnSubmit');
            
            btnPrev.style.display = formState.currentStep === 0 ? 'none' : 'block';
            btnNext.style.display = formState.currentStep === formState.totalSteps - 1 ? 'none' : 'block';
            btnSubmit.style.display = formState.currentStep === formState.totalSteps - 1 ? 'block' : 'none';
        }

        function updateProgressBar() {
            const progressBar = document.getElementById('progressBar');
            const progress = ((formState.currentStep) / (formState.totalSteps - 1)) * 100;
            
            let html = `<div class="progress-line"></div>`;
            html += `<div class="progress-line-active" style="width: ${progress}%"></div>`;
            
            formState.steps.forEach((stepName, index) => {
                const isActive = index === formState.currentStep;
                const isCompleted = index < formState.currentStep;
                const stepNumber = index + 1;
                
                let label = stepName;
                if (stepName === 'selection') label = 'Selecci√≥n';
                else if (stepName === 'summary') label = 'Resumen';
                else if (stepName.startsWith('codeudor-')) {
                    const num = stepName.split('-')[1];
                    label = `Codeudor ${num}`;
                }
                
                html += `
                    <div class="step ${isActive ? 'active' : ''} ${isCompleted ? 'completed' : ''}">
                        <div class="step-circle">${isCompleted ? '‚úì' : stepNumber}</div>
                        <div class="step-label">${label}</div>
                    </div>
                `;
            });
            
            progressBar.innerHTML = html;
        }

        // ==========================================
        // VALIDACIONES Y HANDLERS
        // ==========================================
        function validateCurrentStep() {
            const currentStepName = formState.steps[formState.currentStep];
            
            if (currentStepName === 'selection') {
                if (formState.numCodeudores === 0) {
                    mostrarMensaje('Seleccione el n√∫mero de codeudores', 'error');
                    return false;
                }
                return true;
            }
            
            if (currentStepName.startsWith('codeudor-')) {
                const num = parseInt(currentStepName.split('-')[1]);
                return validateCodeudor(num);
            }
            
            if (currentStepName === 'summary') {
                const confirmCheckbox = document.getElementById('confirmData');
                if (!confirmCheckbox.checked) {
                    mostrarMensaje('Debe confirmar que la informaci√≥n es correcta', 'error');
                    return false;
                }
                return true;
            }
            
            return true;
        }

        function validateCodeudor(num) {
            const requiredFields = [
                `tipoDoc${num}`, `numeroDoc${num}`, `confirmNumeroDoc${num}`,
                `nombres${num}`, `apellidos${num}`, `email${num}`, `confirmEmail${num}`,
                `celular${num}`, `confirmCelular${num}`
            ];
            
            for (const fieldId of requiredFields) {
                const field = document.getElementById(fieldId);
                if (!field || !field.value.trim()) {
                    mostrarMensaje(`Complete todos los campos del Codeudor ${num}`, 'error');
                    field?.focus();
                    return false;
                }
            }
            
            // Validar coincidencias
            const checks = [
                [`numeroDoc${num}`, `confirmNumeroDoc${num}`, 'n√∫meros de documento'],
                [`email${num}`, `confirmEmail${num}`, 'emails'],
                [`celular${num}`, `confirmCelular${num}`, 'n√∫meros de celular']
            ];
            
            for (const [field1, field2, label] of checks) {
                const val1 = document.getElementById(field1).value;
                const val2 = document.getElementById(field2).value;
                if (val1 !== val2) {
                    mostrarMensaje(`Los ${label} no coinciden en Codeudor ${num}`, 'error');
                    return false;
                }
            }
            
            // Validar documentos
            if (!formState.codeudores[num]?.documentType) {
                mostrarMensaje(`Seleccione el tipo de archivo para Codeudor ${num}`, 'error');
                return false;
            }
            
            const docType = formState.codeudores[num].documentType;
            if (docType === 'single') {
                if (!formState.archivosBase64[`docCompleto${num}`]) {
                    mostrarMensaje(`Cargue el documento del Codeudor ${num}`, 'error');
                    return false;
                }
            } else {
                if (!formState.archivosBase64[`docFrente${num}`] || !formState.archivosBase64[`docReverso${num}`]) {
                    mostrarMensaje(`Cargue frente y reverso del documento del Codeudor ${num}`, 'error');
                    return false;
                }
            }
            
            // Guardar datos del codeudor
            saveCodeudorData(num);
            return true;
        }

        function setDocumentType(num, isSingle) {
            if (!formState.codeudores[num]) {
                formState.codeudores[num] = {};
            }
            
            formState.codeudores[num].documentType = isSingle ? 'single' : 'double';
            
            // Actualizar UI
            event.target.parentElement.querySelectorAll('.decision-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            event.target.classList.add('selected');
            
            const singleDoc = document.getElementById(`singleDoc${num}`);
            const doubleDoc = document.getElementById(`doubleDoc${num}`);
            
            if (isSingle) {
                singleDoc.style.display = 'block';
                doubleDoc.style.display = 'none';
            } else {
                singleDoc.style.display = 'none';
                doubleDoc.style.display = 'block';
            }
        }

        function handleDocumentUpload(input, num, type) {
            const file = input.files[0];
            if (!file) return;
            
            if (file.size > CONFIG.MAX_FILE_SIZE) {
                mostrarMensaje('El archivo excede el l√≠mite de 10MB', 'error');
                input.value = '';
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const key = type === 'completo' ? `docCompleto${num}` : 
                           type === 'frente' ? `docFrente${num}` : `docReverso${num}`;
                
                formState.archivosBase64[key] = {
                    nombre: file.name,
                    tipo: file.type,
                    contenido: e.target.result
                };
                
                const labelId = type === 'completo' ? `labelDocCompleto${num}` :
                               type === 'frente' ? `labelDocFrente${num}` : `labelDocReverso${num}`;
                
                const label = document.getElementById(labelId);
                if (label) {
                    label.textContent = file.name;
                    label.classList.add('file-selected');
                }
            };
            
            reader.readAsDataURL(file);
        }

        function saveCodeudorData(num) {
            if (!formState.codeudores[num]) {
                formState.codeudores[num] = {};
            }
            
            formState.codeudores[num] = {
                ...formState.codeudores[num],
                tipoDocumento: document.getElementById(`tipoDoc${num}`).value,
                numeroDocumento: document.getElementById(`numeroDoc${num}`).value,
                fechaExpedicion: document.getElementById(`fechaExpedicion${num}`).value,
                nombres: document.getElementById(`nombres${num}`).value,
                apellidos: document.getElementById(`apellidos${num}`).value,
                email: document.getElementById(`email${num}`).value,
                celular: document.getElementById(`celular${num}`).value
            };
        }

        function generateSummary() {
            const summaryContent = document.getElementById('summaryContent');
            let html = '';
            
            for (let i = 1; i <= formState.numCodeudores; i++) {
                const codeudor = formState.codeudores[i] || {};
                html += `
                    <div class="card mb-3">
                        <div class="card-header">
                            <h4 class="card-title">Codeudor ${i}</h4>
                        </div>
                        <div class="card-body">
                            <div class="grid">
                                <div><strong>Tipo Doc:</strong> ${codeudor.tipoDocumento || '-'}</div>
                                <div><strong>Documento:</strong> ${codeudor.numeroDocumento || '-'}</div>
                                <div><strong>Nombres:</strong> ${codeudor.nombres || '-'}</div>
                                <div><strong>Apellidos:</strong> ${codeudor.apellidos || '-'}</div>
                                <div><strong>Email:</strong> ${codeudor.email || '-'}</div>
                                <div><strong>Celular:</strong> ${codeudor.celular || '-'}</div>
                            </div>
                            <div class="mt-2">
                                <strong>Documentos:</strong> 
                                ${getDocumentStatus(i)}
                            </div>
                        </div>
                    </div>
                `;
            }
            
            summaryContent.innerHTML = html;
        }

        function getDocumentStatus(num) {
            const docType = formState.codeudores[num]?.documentType;
            if (docType === 'single') {
                return formState.archivosBase64[`docCompleto${num}`] ? 
                       formState.archivosBase64[`docCompleto${num}`].nombre : 'No cargado';
            } else if (docType === 'double') {
                const frente = formState.archivosBase64[`docFrente${num}`]?.nombre || 'No';
                const reverso = formState.archivosBase64[`docReverso${num}`]?.nombre || 'No';
                return `Frente: ${frente}, Reverso: ${reverso}`;
            }
            return 'No definido';
        }

        async function submitForm() {
            if (!validateCurrentStep()) return;
            
            const formData = {
                codigoRegistro: formState.codigoRegistro,
                numCodeudores: formState.numCodeudores,
                codeudores: formState.codeudores
            };
            
            try {
                mostrarOverlay(true, 'Enviando informaci√≥n de codeudores...');
                
                const resultado = await realizarLlamadaAPI({
                    accion: 'procesarFormularioCodeudores',
                    datosFormulario: formData,
                    archivosBase64: formState.archivosBase64
                });
                
                if (resultado.success) {
                    mostrarOverlay(true, 'Informaci√≥n enviada. Redirigiendo...');
                    setTimeout(() => {
                        redirigirCon('pagina-exito.html', {
                            estado: 'exitoso',
                            cdr: formState.codigoRegistro,
                            tipo: 'codeudores'
                        });
                    }, 1500);
                } else {
                    mostrarMensaje('Error enviando la informaci√≥n. Intente nuevamente.', 'error');
                }
                
            } catch (error) {
                console.error('Error enviando formulario:', error);
                mostrarMensaje('Error de conexi√≥n. Intente nuevamente.', 'error');
            } finally {
                mostrarOverlay(false);
            }
        }

        // Mostrar paso inicial
        showCurrentStep();
    </script>
</body>
</html>