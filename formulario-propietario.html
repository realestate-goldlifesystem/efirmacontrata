<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Formulario Propietario - E-firmaContrata</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<link rel="stylesheet" href="style.css">
<link rel="stylesheet" href="styles/responsive.css">
<link rel="stylesheet" href="styles/forms.css">
<link rel="stylesheet" href="styles/components.css">
<style>
/* Ajustes m铆nimos: acentos corregidos + banner debug reutilizable */
.message{padding:15px;margin:20px 0;border-radius:5px;text-align:center;animation:slideDown .3s}
.message.success{background:#d4edda;color:#155724;border:1px solid #c3e6cb}
.message.error{background:#f8d7da;color:#721c24;border:1px solid #f5c6cb}
.message.info{background:#d1ecf1;color:#0c5460;border:1px solid #bee5eb}
@keyframes slideDown{from{transform:translateY(-20px);opacity:0}to{transform:translateY(0);opacity:1}}
.spinner{border:3px solid #f3f3f3;border-top:3px solid #3498db;border-radius:50%;width:40px;height:40px;animation:spin 1s linear infinite;margin:20px auto}
@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
.loading-overlay{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(255,255,255,.92);z-index:2000;justify-content:center;align-items:center;flex-direction:column}
.loading-overlay.show{display:flex}
.debug-banner{position:fixed;bottom:8px;right:8px;background:rgba(33,150,243,0.15);border:1px solid #2196F3;padding:6px 12px;color:#0c5460;font-size:12px;border-radius:6px;z-index:1500;font-weight:600;backdrop-filter:blur(4px)}
</style>
</head>
<body>
<div class="container">
  <div class="card">
    <div class="card-header">
      <h1> Formulario del Propietario</h1>
      <p>Complete todos los documentos requeridos para el contrato de arrendamiento</p>
    </div>
    <div class="card-body">
      <div id="messageContainer"></div>
      <!-- Secci贸n 1 -->
      <div class="form-section" style="display:block">
        <h2> Informaci贸n Personal del Propietario</h2>
        <div class="form-row">
          <div class="form-group">
            <label>Tipo de Documento <span class="required">*</span></label>
            <select id="tipoDocumento">
              <option value="">Seleccione...</option>
              <option value="CC">C茅dula de Ciudadan铆a</option>
              <option value="CE">C茅dula de Extranjer铆a</option>
              <option value="PA">Pasaporte</option>
              <option value="NIT">NIT</option>
            </select>
          </div>
          <div class="form-group">
            <label>N煤mero de Documento <span class="required">*</span></label>
            <input type="text" id="numeroDocumento" placeholder="Ej: 1234567890">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Nombres Completos <span class="required">*</span></label>
            <input type="text" id="nombres" placeholder="Ej: Juan Carlos">
          </div>
          <div class="form-group">
            <label>Apellidos Completos <span class="required">*</span></label>
            <input type="text" id="apellidos" placeholder="Ej: Garc铆a L贸pez">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Correo Electr贸nico <span class="required">*</span></label>
            <input type="email" id="email" placeholder="correo@ejemplo.com">
          </div>
          <div class="form-group">
            <label>Celular <span class="required">*</span></label>
            <input type="tel" id="celular" placeholder="Ej: 3001234567">
          </div>
        </div>
        <div class="form-group">
          <label>Direcci贸n de Residencia <span class="required">*</span></label>
            <input type="text" id="direccion" placeholder="Ej: Calle 123 #45-67, Barrio, Ciudad">
        </div>
      </div>
      <!-- Secci贸n 2 -->
      <div class="form-section" style="display:block">
        <h2> Documentos B谩sicos</h2>
        <div class="form-group">
          <label>Documento de Identidad (Ambas caras) <span class="required">*</span></label>
          <input type="file" id="docIdentidad" class="file-input" accept="image/*,.pdf">
          <small class="form-text">Suba ambas caras del documento en una imagen o PDF</small>
        </div>
        <div class="form-group">
          <label>Formulario SARLAFT <span class="required">*</span></label>
          <div class="info-box">
            <p> Descargue el formulario SARLAFT, diligencie todos los campos y s煤balo firmado.</p>
            <a href="https://drive.google.com/file/d/1example/view" target="_blank" class="download-link"> Descargar Formulario SARLAFT</a>
          </div>
          <input type="file" id="sarlaft" class="file-input" accept="image/*,.pdf">
        </div>
      </div>
      <!-- Secci贸n 3 -->
      <div class="form-section" style="display:block">
        <h2> Documentos del Inmueble</h2>
        <div class="form-group">
          <label>Certificado Bancario <span class="required">*</span></label>
          <input type="file" id="certBancario" class="file-input" accept="image/*,.pdf">
          <small class="form-text">Certificado (no mayor a 30 d铆as)</small>
        </div>
        <div class="form-group">
          <label>Certificado de Tradici贸n y Libertad <span class="required">*</span></label>
          <input type="file" id="certTradicion" class="file-input" accept="image/*,.pdf">
          <small class="form-text">No mayor a 30 d铆as</small>
        </div>
      </div>
      <!-- Secci贸n 4 -->
      <div class="form-section" style="display:block">
        <h2> Servicios P煤blicos</h2>
        <div class="info-box">
          <p> Debe cargar m铆nimo 2 servicios p煤blicos (recibo + pago al d铆a).</p>
        </div>
        <div class="form-group">
          <label>N煤mero de servicios p煤blicos a cargar</label>
          <select id="numServicios" onchange="generarCamposServicios()">
            <option value="2">2 servicios</option>
            <option value="3">3 servicios</option>
            <option value="4">4 servicios</option>
            <option value="5">5 servicios</option>
          </select>
        </div>
        <div id="serviciosContainer"></div>
      </div>
      <!-- Secci贸n 5 -->
      <div class="form-section" style="display:block">
        <h2> Documentos Opcionales</h2>
        <div class="form-group">
          <label>Reglamento de Propiedad Horizontal (si aplica)</label>
          <input type="file" id="reglamento" class="file-input" accept="image/*,.pdf">
        </div>
        <div class="form-group">
          <label>Manual de Convivencia (si aplica)</label>
            <input type="file" id="manual" class="file-input" accept="image/*,.pdf">
        </div>
      </div>
      <div class="form-section" style="display:block">
        <button type="button" class="btn btn-success btn-lg" onclick="enviarFormulario()"> ENVIAR DOCUMENTOS</button>
      </div>
    </div>
  </div>
</div>

<div id="loadingOverlay" class="loading-overlay">
  <div class="spinner"></div>
  <h3>Procesando documentos...</h3>
  <p>Por favor espere, esto puede tomar unos segundos</p>
</div>
<div id="debugBanner" class="debug-banner" style="display:none;">DEBUG ACTIVO</div>

<script src="config.js"></script>
<script>
let codigoRegistro='',archivosBase64={},serviciosPublicos=[];
window.onload=function(){
  if(CONFIG.DEBUG)document.getElementById('debugBanner').style.display='block';
  const urlParams=new URLSearchParams(window.location.search);
  codigoRegistro=urlParams.get('cdr')||'';
  if(!codigoRegistro){
    mostrarMensaje('C贸digo de registro no v谩lido','error');
    setTimeout(()=>window.location.href='selector.html',2500);
    return;
  }
  mostrarMensaje(`C贸digo de registro: ${codigoRegistro}`,'success');
  configurarArchivos();
  generarCamposServicios();
};

function configurarArchivos(){
  document.querySelectorAll('input[type="file"]').forEach(inp=>{
    inp.addEventListener('change',()=>convertirArchivoBase64(inp));
  });
}
function convertirArchivoBase64(input){
  const file=input.files[0];if(!file)return;
  const maxSize=file.type.startsWith('image/')?CONFIG.MAX_IMAGE_SIZE:CONFIG.MAX_FILE_SIZE;
  if(file.size>maxSize){
    mostrarMensaje(`El archivo ${file.name} excede el l铆mite (${(maxSize/1024/1024)}MB)`, 'error');
    input.value='';return;
  }
  const reader=new FileReader();
  reader.onload=e=>{
    archivosBase64[input.id]={nombre:file.name,tipo:file.type,contenido:e.target.result};
  };
  reader.readAsDataURL(file);
}
function generarCamposServicios(){
  const num=parseInt(document.getElementById('numServicios').value);
  const cont=document.getElementById('serviciosContainer');
  cont.innerHTML='';serviciosPublicos=[];
  const tipos=['Energ铆a','Agua','Gas','Internet','Administraci贸n'];
  for(let i=1;i<=num;i++){
    cont.innerHTML+=`
      <div class="servicio-item">
        <div class="servicio-header"><h4>Servicio ${i}</h4></div>
        <div class="form-group">
          <label>Tipo de Servicio <span class="required">*</span></label>
          <select id="tipoServicio${i}">
            <option value="">Seleccione...</option>
            ${tipos.map(t=>`<option value="${t.toLowerCase()}">${t}</option>`).join('')}
          </select>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Recibo del Servicio <span class="required">*</span></label>
            <input type="file" id="reciboServicio${i}" class="file-input" accept="image/*,.pdf" onchange="convertirArchivoBase64(this)">
          </div>
          <div class="form-group">
            <label>Comprobante de Pago <span class="required">*</span></label>
            <input type="file" id="pagoServicio${i}" class="file-input" accept="image/*,.pdf" onchange="convertirArchivoBase64(this)">
          </div>
        </div>
      </div>`;
    serviciosPublicos.push({index:i,tipo:'',recibo:'',pago:''});
  }
}
function validarFormulario(){
  const campos=['tipoDocumento','numeroDocumento','nombres','apellidos','email','celular','direccion'];
  for(const c of campos){
    const v=document.getElementById(c).value;
    if(!v){mostrarMensaje(`Complete el campo: ${c}`,'error');return false;}
  }
  const req=['docIdentidad','sarlaft','certBancario','certTradicion'];
  for(const r of req){
    if(!archivosBase64[r]){mostrarMensaje(`Debe cargar el archivo: ${r}`,'error');return false;}
  }
  const num=parseInt(document.getElementById('numServicios').value);
  let completos=0;
  for(let i=1;i<=num;i++){
    const tipo=document.getElementById(`tipoServicio${i}`).value;
    if(tipo && archivosBase64[`reciboServicio${i}`] && archivosBase64[`pagoServicio${i}`]){
      completos++;serviciosPublicos[i-1].tipo=tipo;
    }
  }
  if(completos<2){mostrarMensaje('Debe cargar al menos 2 servicios completos','error');return false;}
  return true;
}
async function enviarFormulario(){
  if(!validarFormulario())return;
  document.getElementById('loadingOverlay').classList.add('show');
  const datosFormulario={
    codigoRegistro,
    propietario:{
      tipoDocumento:document.getElementById('tipoDocumento').value,
      numeroDocumento:document.getElementById('numeroDocumento').value,
      nombre:document.getElementById('nombres').value+' '+document.getElementById('apellidos').value,
      nombres:document.getElementById('nombres').value,
      apellidos:document.getElementById('apellidos').value,
      email:document.getElementById('email').value,
      celular:document.getElementById('celular').value,
      direccion:document.getElementById('direccion').value
    },
    serviciosPublicos:serviciosPublicos.filter(s=>s.tipo!=='')
  };
  try{
    await fetch(CONFIG.API_URL,{
      method:'POST',mode:'no-cors',headers:{'Content-Type':'text/plain'},
      body:JSON.stringify({
        accion:'procesarFormularioPropietario',
        datosFormulario,
        archivosBase64
      })
    });
    mostrarMensaje('Documentos enviados. Redirigiendo...','success');
    setTimeout(()=>window.location.href=`pagina-exito.html?estado=exitoso&cdr=${encodeURIComponent(codigoRegistro)}&tipo=propietario`,1500);
  }catch(err){
    console.error('[Propietario] Error env铆o',err);
    mostrarMensaje('Error de conexi贸n. Intente nuevamente.','error');
    document.getElementById('loadingOverlay').classList.remove('show');
  }
}
function mostrarMensaje(msg,tipo){
  const c=document.getElementById('messageContainer');
  c.innerHTML=`<div class="message ${tipo}">${msg}</div>`;
  if(tipo!=='error'){setTimeout(()=>{c.innerHTML='';},5000);}
}
</script>
</body>
</html>
