<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <title>Verificando... - E-firmaContrata</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --gold-primary: #FFD700;
      --gold-dark: #B8860B;
      --black-primary: #0F0F0F;
      --gray-dark: #222;
      --text-light: #f4f4f4;
      --success: #28a745;
      --info: #17a2b8;
      --error: #dc3545;
    }

    body {
      margin: 0;
      padding: 0;
      background-color: var(--black-primary);
      background-image: radial-gradient(#FFD70011 1px, transparent 1px);
      background-size: 40px 40px;
      font-family: 'Segoe UI', Arial, sans-serif;
      color: var(--text-light);
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
      overflow: hidden;
    }

    .validator-container {
      background-color: var(--gray-dark);
      padding: 40px;
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
      text-align: center;
      max-width: 500px;
      width: 90%;
      border: 1px solid #333;
      position: relative;
    }

    .logo-text {
      color: var(--gold-primary);
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 20px;
      letter-spacing: 1px;
    }

    /* Loader Styles */
    .loader-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px 0;
    }

    .spinner {
      width: 50px;
      height: 50px;
      border: 5px solid rgba(255, 215, 0, 0.3);
      border-radius: 50%;
      border-top-color: var(--gold-primary);
      animation: spin 1s ease-in-out infinite;
      margin-bottom: 20px;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .status-text {
      color: #ccc;
      font-size: 16px;
    }

    /* Content Styles (Hidden by default) */
    .content-container {
      display: none;
      animation: fadeIn 0.5s;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .icon-large {
      font-size: 48px;
      margin-bottom: 15px;
      display: block;
    }

    .status-title {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 10px;
      color: white;
    }

    .status-message {
      color: #bbb;
      line-height: 1.6;
      margin-bottom: 25px;
    }

    .btn {
      display: inline-block;
      padding: 12px 30px;
      background: var(--gold-primary);
      color: var(--black-primary);
      text-decoration: none;
      border-radius: 30px;
      font-weight: bold;
      transition: all 0.3s ease;
      border: none;
      cursor: pointer;
      font-size: 15px;
    }

    .btn:hover {
      background: #f2c300;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(255, 215, 0, 0.2);
    }

    .btn-secondary {
      background: transparent;
      border: 2px solid #555;
      color: #ccc;
    }

    .btn-secondary:hover {
      border-color: #888;
      background: #333;
      color: white;
    }

    .error-box {
      background: rgba(220, 53, 69, 0.1);
      border: 1px solid var(--error);
      color: #ff6b6b;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 14px;
    }
  </style>
</head>

<body>

  <div class="validator-container">
    <div class="logo-text">EFirmaContrata</div>

    <!-- Loading State -->
    <div id="loader" class="loader-container">
      <div class="spinner"></div>
      <div class="status-text">Validando enlace...</div>
    </div>

    <!-- Success/Info State -->
    <div id="info-content" class="content-container">
      <span class="icon-large" id="status-icon">âœ…</span>
      <h2 class="status-title" id="status-title">Estado del Proceso</h2>
      <p class="status-message" id="status-message">
        Tu formulario ya ha sido procesado.
      </p>
      <div id="actions-container">
        <!-- Buttons will be injected here if needed -->
        <a href="index.html" class="btn btn-secondary">Volver al Inicio</a>
      </div>
    </div>

    <!-- Error State -->
    <div id="error-content" class="content-container">
      <span class="icon-large">ðŸš«</span>
      <h2 class="status-title">Enlace No VÃ¡lido</h2>
      <div class="error-box" id="error-message">
        No se pudo verificar la informaciÃ³n.
      </div>
      <a href="index.html" class="btn btn-secondary">Ir al Inicio</a>
    </div>

  </div>

  <script src="config.js"></script>
  <script>
    // Obtener parÃ¡metros de la URL
    function getParams() {
      const params = new URLSearchParams(window.location.search);
      return {
        cdr: params.get('cdr'),
        action: params.get('action'), // formulario-inquilino o formulario-propietario
        modo: params.get('modo') // correccion, etc.
      };
    }

    function showLoader() {
      document.getElementById('loader').style.display = 'flex';
      document.getElementById('info-content').style.display = 'none';
      document.getElementById('error-content').style.display = 'none';
    }

    function showInfo(icon, title, message, urlBtn = null) {
      document.getElementById('loader').style.display = 'none';
      document.getElementById('info-content').style.display = 'block';

      document.getElementById('status-icon').innerText = icon;
      document.getElementById('status-title').innerText = title;
      document.getElementById('status-message').innerText = message;

      if (urlBtn) {
        document.getElementById('actions-container').innerHTML = `<a href="${urlBtn}" class="btn">Continuar</a>`;
      } else {
        document.getElementById('actions-container').innerHTML = `<a href="index.html" class="btn btn-secondary">Volver al Inicio</a>`;
      }
    }

    function showError(msg) {
      document.getElementById('loader').style.display = 'none';
      document.getElementById('error-content').style.display = 'block';
      document.getElementById('error-message').innerText = msg;
    }

    function init() {
      const { cdr, action, modo } = getParams();

      if (!cdr || !action) {
        showError('Enlace incompleto o invÃ¡lido. Falta cÃ³digo de registro.');
        return;
      }

      // Inferir rol
      let rol = '';
      if (action.includes('inquilino')) rol = 'inquilino';
      else if (action.includes('propietario')) rol = 'propietario';
      else {
        showError('Tipo de formulario no reconocido.');
        return;
      }

      // IMPORTANTE: En GitHub Pages NO funciona google.script.run
      // Debemos usar fetch() al Web App URL
      if (typeof CONFIG === 'undefined' || !CONFIG.API_URL) {
        showError('Error de configuraciÃ³n: No se encontrÃ³ la URL de la API.');
        return;
      }

      const apiUrl = `${CONFIG.API_URL}?accion=verificarLink&cdr=${encodeURIComponent(cdr)}&tipo=${rol}`;

      fetch(apiUrl)
        .then(response => response.json())
        .then(response => {
          console.log('Respuesta backend:', response);

          if (!response.success) {
            showError(response.mensaje || 'Error desconocido del servidor.');
            return;
          }

          if (response.activo) {
            // RedirecciÃ³n automÃ¡tica
            document.querySelector('.status-text').innerText = 'Redirigiendo al formulario...';

            let targetUrl = response.redirectUrl;

            // Si el backend no devolviÃ³ URL completa, construirla aqui (fallback)
            if (!targetUrl) {
              targetUrl = `${action}.html?cdr=${cdr}`;
              if (modo) targetUrl += `&modo=${modo}`;
            }

            window.location.href = targetUrl;
          } else {
            // Mostrar estado (Ya completado, etc)
            let icon = 'â„¹ï¸';
            if (response.status === 'diligenciado' || response.status === 'aprobado') icon = 'âœ…';

            showInfo(icon, 'Estado del Proceso', response.mensaje);
          }
        })
        .catch(error => {
          console.error(error);
          showError('Error de conexiÃ³n con el servidor: ' + error.message);
        });
    }

    // Iniciar al cargar
    window.onload = init;
  </script>
</body>

</html>